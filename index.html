<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostKinaa - ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑ö‡∑Å‡∂∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .pulse-animation { animation: pulse 2s ease-in-out infinite; }
        
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }
        .float { animation: float 3s ease-in-out infinite; }
        
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.5); } 50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.9); } }
        .glow { animation: glow 2s ease-in-out infinite; }

        .auth-button { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .auth-button:hover { transform: translateY(-5px) scale(1.02); }
        .auth-button:active { transform: translateY(0) scale(0.98); }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.4);
        }

        input:focus {
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        .disabled { opacity: 0.6; pointer-events: none; filter: grayscale(50%); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-down { animation: slideDown 0.4s ease-out; }

        /* Custom Modal Styles */
        .modal-backdrop {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.5);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-content {
            animation: modalFadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 flex items-center justify-center p-4 relative overflow-hidden">

    <!-- Animated Background Elements -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-10 left-10 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse"></div>
        <div class="absolute top-40 right-10 w-96 h-96 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse" style="animation-delay: 1s;"></div>
        <div class="absolute -bottom-20 left-1/3 w-80 h-80 bg-blue-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <!-- Main Container -->
    <div class="w-full max-w-md glass-effect rounded-3xl p-10 shadow-2xl fade-in relative z-10">
        <!-- Logo & Title -->
        <div class="text-center mb-8">
            <div class="text-6xl mb-4 float">üåü</div>
            <h1 class="text-5xl font-black mb-3 bg-clip-text text-transparent bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 pulse-animation">PostKinaa</h1>
            <p class="text-gray-600 font-semibold text-lg">‚ú® ‡∂∫‡∑è‡∑Ö‡∑î‡∑Ä‡∑ù ‡∂ë‡∂ö‡∑ä‡∂ö ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±!</p>
        </div>

        <!-- Notification Area -->
        <div id="notification" class="mb-4 hidden"></div>

        <!-- Auth Container -->
        <div id="authContainer">
            <!-- Sign In Section -->
            <div id="signInSection">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">üîê ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±</h2>
                
                <!-- Google Sign In Button -->
                <button id="googleSignInBtn" class="auth-button w-full flex items-center justify-center space-x-3 bg-white text-gray-700 border-2 border-gray-300 p-4 rounded-2xl font-bold text-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 hover:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-300 mb-6 shadow-lg hover:shadow-xl">
                    <svg class="w-6 h-6" viewBox="0 0 533.5 544.3" xmlns="http://www.w3.org/2000/svg"><path d="M533.5 244.3c0-14.7-1.2-29.2-3.4-43.2H267.5v82.7h149.3c-6.4 39.8-29.7 73.5-62.8 96.1l-2.6 1.8 69.4 53.7 3.8.3c42.8-39.7 67.5-97 67.5-164.8z" fill="#4285F4"/><path d="M267.5 544.3c71.2 0 131-23.7 174.7-64.4l-73.4-56.9c-20.4 13.6-46.7 22-77.2 22-59 0-109.8-39.9-127.7-93.5l-2.5.3-71.1 55.4-1.7.9c41 81.3 124.9 138.2 229.7 138.2z" fill="#34A853"/><path d="M140.2 329.8c-3.1-9.4-5.2-19.4-5.2-29.8 0-10.4 2.1-20.4 5.1-29.8l-1.9-1.5-73.6-57.2-1.4.7c-21.7 43.1-34.4 92.5-34.4 147.2 0 54.7 12.7 104.1 34.4 147.2l75-58.4z" fill="#FBBC05"/><path d="M267.5 108.3c38.7 0 73.1 13.3 99.9 38.6L437 78.4c-43.7-41-103.5-66.7-169.5-66.7-104.8 0-188.7 56.9-229.7 138.2l75 58.4c17.9-53.6 68.7-93.5 127.7-93.5z" fill="#EA4335"/></svg>
                    <span>üöÄ ‡∂ú‡∑ñ‡∂ú‡∂Ω‡∑ä ‡∑Ñ‡∂ª‡∑Ñ‡∑è ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±</span>
                </button>
                
                <div class="flex items-center my-6">
                    <hr class="flex-grow border-gray-300">
                    <span class="px-4 text-gray-500 text-sm font-semibold">‡∂±‡∑ê‡∂≠‡∑Ñ‡∑ú‡∂≠‡∑ä</span>
                    <hr class="flex-grow border-gray-300">
                </div>
                
                <!-- Email/Password Login -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">üìß ‡∂ä‡∂∏‡∑ö‡∂Ω‡∑ä ‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫</label>
                        <input type="email" id="authEmail" placeholder="your@email.com" 
                            class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition duration-300 font-medium bg-white/60 backdrop-blur-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">üîí ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫</label>
                        <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                            class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition duration-300 font-medium bg-white/60 backdrop-blur-sm">
                    </div>
                </div>
                
                <button id="signInBtn" class="auth-button w-full bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 text-white p-4 rounded-2xl font-bold text-lg hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-300 mt-6 shadow-xl hover:shadow-2xl">
                    üéØ ‡∂ä‡∂∏‡∑ö‡∂Ω‡∑ä/‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±
                </button>
                
                <p class="text-center text-gray-600 mt-6 font-medium">
                    ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∂±‡∑ú‡∂Ø‡∑ä‡∂Ø? 
                    <button id="toggleAuthBtn" class="text-purple-600 font-bold hover:text-pink-600 transition-colors duration-300 hover:underline">‚ú® ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±</button>
                </p>
            </div>

            <!-- Sign Up Section -->
            <div id="signUpSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">üéâ ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∂±‡∑ä‡∂±</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">üìß ‡∂ä‡∂∏‡∑ö‡∂Ω‡∑ä ‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫</label>
                        <input type="email" id="signUpEmail" placeholder="your@email.com" 
                            class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-pink-300 focus:border-pink-500 transition duration-300 font-medium bg-white/60 backdrop-blur-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">üë§ ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂±‡∑è‡∂∏‡∂∫ (Username)</label>
                        <input type="text" id="displayName" placeholder="‡∂Ö‡∂¥‡∑ñ‡∂ª‡∑î ‡∂±‡∂∏‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±..." 
                            class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-pink-300 focus:border-pink-500 transition duration-300 font-medium bg-white/60 backdrop-blur-sm">
                        <p class="text-xs text-gray-500 mt-1 font-medium">‚ö†Ô∏è ‡∂î‡∂∂‡∂ú‡∑ö ‡∂±‡∂∏ ‡∂Ö‡∂±‡∑ä ‡∂Ö‡∂∫‡∂ß ‡∂¥‡∑ô‡∂±‡∑ô‡∂±‡∑î ‡∂á‡∂≠</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">üîí ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫</label>
                        <input type="password" id="signUpPassword" placeholder="‡∂Ö‡∑Ä‡∂∏ ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä 6‡∂ö‡∑ä" 
                            class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-pink-300 focus:border-pink-500 transition duration-300 font-medium bg-white/60 backdrop-blur-sm">
                    </div>
                </div>
                
                <button id="signUpBtn" class="auth-button w-full bg-gradient-to-r from-pink-600 via-purple-600 to-blue-600 text-white p-4 rounded-2xl font-bold text-lg hover:from-pink-700 hover:via-purple-700 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-pink-300 transition duration-300 mt-6 shadow-xl hover:shadow-2xl">
                    üöÄ ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∂±‡∑ä‡∂±
                </button>

                <p class="text-center text-gray-600 mt-6 font-medium">
                    ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂≠‡∑í‡∂∂‡∑ô‡∂±‡∑Ä‡∂Ø? 
                    <button id="backToSignIn" class="text-pink-600 font-bold hover:text-purple-600 transition-colors duration-300 hover:underline">üîê ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Username Modal -->
    <div id="usernameModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="modal-content glass-effect rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl border-2 border-white/40">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">üë§</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂±‡∑è‡∂∏‡∂∫</h2>
                <p class="text-gray-600 font-medium">‡∂Ö‡∂±‡∑ä ‡∂Ö‡∂∫‡∂ß ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂± ‡∂±‡∂∏‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">‚ú® ‡∂î‡∂∂‡∑ö ‡∂±‡∂∏</label>
                <input type="text" id="modalUsername" placeholder="‡∂Ö‡∂¥‡∑ñ‡∂ª‡∑î ‡∂±‡∂∏‡∂ö‡∑ä ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±..." 
                    class="w-full p-4 border-2 border-purple-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition duration-300 font-medium bg-white/80">
                <p id="usernameError" class="text-red-500 text-sm font-bold mt-2 hidden">‚ùå ‡∂∏‡∑ô‡∂∏ ‡∂±‡∂∏ ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∑Ä‡∑ö!</p>
                <p id="usernameSuccess" class="text-green-500 text-sm font-bold mt-2 hidden">‚úÖ ‡∂∏‡∑ô‡∂∏ ‡∂±‡∂∏ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö!</p>
            </div>
            
            <button id="confirmUsername" class="w-full bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 text-white p-4 rounded-2xl font-bold text-lg hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-300 shadow-xl hover:shadow-2xl">
                üöÄ ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
            </button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAzNJ-P8aAMvTuNWKcQYCjIIHiaL0BpdZ0",
          authDomain: "game-f1c21.firebaseapp.com",
          databaseURL: "https://game-f1c21-default-rtdb.firebaseio.com",
          projectId: "game-f1c21",
          storageBucket: "game-f1c21.firebasestorage.app",
          messagingSenderId: "656338565711",
          appId: "1:656338565711:web:395f9c7f846588b065883a"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const database = firebase.database();

        // Notification System
        function showMessage(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = 'mb-4 p-4 rounded-2xl font-bold text-center slide-down shadow-lg';
            
            if (type === 'error') {
                notification.className += ' bg-gradient-to-r from-red-400 to-pink-500 text-white';
            } else if (type === 'success') {
                notification.className += ' bg-gradient-to-r from-green-400 to-emerald-500 text-white';
            } else {
                notification.className += ' bg-gradient-to-r from-purple-400 to-pink-500 text-white';
            }
            
            notification.textContent = message;
            notification.classList.remove('hidden');

            clearTimeout(window._notifTimeout);
            window._notifTimeout = setTimeout(() => {
                notification.classList.add('hidden');
            }, 3500);
        }

        // Disable/Enable buttons
        function disableButtons(disable = true) {
            const elements = document.querySelectorAll('#authContainer input, #authContainer button, #googleSignInBtn');
            elements.forEach(el => {
                if (disable) {
                    el.classList.add('disabled');
                    el.disabled = true;
                } else {
                    el.classList.remove('disabled');
                    el.disabled = false;
                }
            });
        }

        // Toggle Auth Sections
        document.getElementById('toggleAuthBtn').addEventListener('click', () => {
            document.getElementById('signInSection').classList.add('hidden');
            document.getElementById('signUpSection').classList.remove('hidden');
        });
        
        document.getElementById('backToSignIn').addEventListener('click', () => {
            document.getElementById('signUpSection').classList.add('hidden');
            document.getElementById('signInSection').classList.remove('hidden');
        });

        // Check if user already signed in
        auth.onAuthStateChanged(user => {
            if (user) {
                window.location.href = 'Home.html';
            }
        });

        // Check if username exists in database
        async function checkUsernameExists(username) {
            if (!username || username.trim() === '') return true;
            
            const normalizedUsername = username.trim().toLowerCase();
            const snapshot = await database.ref('usernames').once('value');
            
            if (snapshot.exists()) {
                const usernames = snapshot.val();
                return Object.values(usernames).some(
                    name => name.toLowerCase() === normalizedUsername
                );
            }
            return false;
        }

        // Save username to database
        async function saveUsername(uid, username) {
            await database.ref('usernames/' + uid).set(username);
            await database.ref('users/' + uid + '/name').set(username);
        }

        // Show Username Modal
        function showUsernameModal(user) {
            return new Promise((resolve, reject) => {
                const modal = document.getElementById('usernameModal');
                const input = document.getElementById('modalUsername');
                const errorMsg = document.getElementById('usernameError');
                const successMsg = document.getElementById('usernameSuccess');
                const confirmBtn = document.getElementById('confirmUsername');
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                input.value = '';
                errorMsg.classList.add('hidden');
                successMsg.classList.add('hidden');
                
                // Real-time username validation
                let checkTimeout;
                input.addEventListener('input', () => {
                    clearTimeout(checkTimeout);
                    errorMsg.classList.add('hidden');
                    successMsg.classList.add('hidden');
                    
                    const username = input.value.trim();
                    if (username.length < 3) return;
                    
                    checkTimeout = setTimeout(async () => {
                        const exists = await checkUsernameExists(username);
                        if (exists) {
                            errorMsg.classList.remove('hidden');
                            successMsg.classList.add('hidden');
                        } else {
                            errorMsg.classList.add('hidden');
                            successMsg.classList.remove('hidden');
                        }
                    }, 500);
                });
                
                confirmBtn.onclick = async () => {
                    const username = input.value.trim();
                    
                    if (!username || username.length < 3) {
                        showMessage('‚ùå ‡∂±‡∂∏ ‡∂Ö‡∑Ä‡∂∏ ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î 3‡∂ö‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í!', 'error');
                        return;
                    }
                    
                    const exists = await checkUsernameExists(username);
                    if (exists) {
                        showMessage('‚ùå ‡∂∏‡∑ô‡∂∏ ‡∂±‡∂∏ ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∑Ä‡∑ö! ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂±‡∂∏‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.', 'error');
                        return;
                    }
                    
                    try {
                        await user.updateProfile({ displayName: username });
                        await saveUsername(user.uid, username);
                        
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                        resolve(username);
                    } catch (error) {
                        reject(error);
                    }
                };
            });
        }

        // Ensure user has valid username
        async function ensureDisplayName(user) {
            if (!user) return;
            
            // Check if user already has username in database
            const snapshot = await database.ref('usernames/' + user.uid).once('value');
            
            if (!snapshot.exists() || !snapshot.val()) {
                // User doesn't have username in database - need to set one
                try {
                    const username = await showUsernameModal(user);
                    showMessage(`‚úÖ ‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${username}! üéâ`, 'success');
                    return username;
                } catch (error) {
                    console.error('Username setup failed:', error);
                    showMessage('‚ùå ‡∂±‡∂∏ ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä!', 'error');
                    throw error;
                }
            } else {
                // Username already exists in database
                const existingUsername = snapshot.val();
                
                // Update user profile if it doesn't match database
                if (user.displayName !== existingUsername) {
                    await user.updateProfile({ displayName: existingUsername });
                }
                
                return existingUsername;
            }
        }

        // Sign Up with Email/Password
        document.getElementById('signUpBtn').addEventListener('click', async () => {
            const email = document.getElementById('signUpEmail').value.trim();
            const password = document.getElementById('signUpPassword').value;
            const displayName = document.getElementById('displayName').value.trim();

            if (!email || !password || !displayName) {
                showMessage('‚ùå ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂¥‡∑î‡∂ª‡∑Ä‡∂±‡∑ä‡∂±!', 'error');
                return;
            }
            
            if (displayName.length < 3) {
                showMessage('‚ùå ‡∂±‡∂∏ ‡∂Ö‡∑Ä‡∂∏ ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î 3‡∂ö‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í!', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('‚ùå ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂Ö‡∑Ä‡∂∏ ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä 6‡∂ö‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í', 'error');
                return;
            }

            // Check if username already exists
            const usernameExists = await checkUsernameExists(displayName);
            if (usernameExists) {
                showMessage('‚ùå ‡∂∏‡∑ô‡∂∏ ‡∂±‡∂∏ ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∑Ä‡∑ö! ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂±‡∂∏‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.', 'error');
                return;
            }

            disableButtons(true);
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: displayName });
                await saveUsername(userCredential.user.uid, displayName);
                
                showMessage(`‚úÖ ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í! ‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${displayName}! üéâ`);
                setTimeout(() => {
                    window.location.href = 'Home.html';
                }, 1500);
            } catch (error) {
                disableButtons(false);
                let errorMsg = '‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î ‡∑Ä‡∑í‡∂∫!';
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg = '‡∂∏‡∑ô‡∂∏ ‡∂ä‡∂∏‡∑ö‡∂Ω‡∑ä ‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫ ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∑Ä‡∑ö!';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = '‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂±‡∑ú‡∑Ä‡∂± ‡∂ä‡∂∏‡∑ö‡∂Ω‡∑ä ‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫‡∂ö‡∑ä!';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = '‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∑Ä‡∂©‡∑è‡∂≠‡∑ä ‡∑Å‡∂ö‡∑ä‡∂≠‡∑í‡∂∏‡∂≠‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í!';
                }
                showMessage(`‚ùå ${errorMsg}`, 'error');
            }
        });

        // Sign In with Email/Password
        document.getElementById('signInBtn').addEventListener('click', async () => {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                showMessage('‚ùå ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂¥‡∑î‡∂ª‡∑Ä‡∂±‡∑ä‡∂±!', 'error');
                return;
            }

            disableButtons(true);
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Check if user has username in database
                const usernameSnapshot = await database.ref('usernames/' + user.uid).once('value');
                
                if (!usernameSnapshot.exists() || !usernameSnapshot.val()) {
                    // No username in database - ask for one
                    showMessage('üéâ ‡∑É‡∑ä‡∑Ä‡∑è‡∂ú‡∂≠‡∂∏! ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª username ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±...', 'info');
                    
                    try {
                        const username = await showUsernameModal(user);
                        showMessage(`‚úÖ ‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${username}! üéâ`, 'success');
                        
                        setTimeout(() => {
                            window.location.href = 'Home.html';
                        }, 1500);
                    } catch (error) {
                        disableButtons(false);
                        showMessage('‚ùå Username ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä!', 'error');
                    }
                } else {
                    // Username exists - proceed to home
                    const existingUsername = usernameSnapshot.val();
                    
                    // Update user profile if needed
                    if (user.displayName !== existingUsername) {
                        await user.updateProfile({ displayName: existingUsername });
                    }
                    
                    showMessage(`‚úÖ ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑î‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í! ‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${existingUsername}! üéâ`);
                    
                    setTimeout(() => {
                        window.location.href = 'Home.html';
                    }, 1500);
                }
            } catch (error) {
                disableButtons(false);
                let errorMsg = '‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î ‡∑Ä‡∑í‡∂∫!';
                if (error.code === 'auth/user-not-found') {
                    errorMsg = '‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫! ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∂±‡∑ä‡∂±.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMsg = '‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫‡∂ö‡∑ä!';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = '‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂±‡∑ú‡∑Ä‡∂± ‡∂ä‡∂∏‡∑ö‡∂Ω‡∑ä ‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫‡∂ö‡∑ä!';
                }
                showMessage(`‚ùå ${errorMsg}`, 'error');
            }
        });

        // Google Sign-in
        document.getElementById('googleSignInBtn').addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            disableButtons(true);
            
            try {
                const userCredential = await auth.signInWithPopup(provider);
                const user = userCredential.user;
                
                // Check if this is a new user or existing user
                const usernameSnapshot = await database.ref('usernames/' + user.uid).once('value');
                
                if (!usernameSnapshot.exists() || !usernameSnapshot.val()) {
                    // New user - need to set username
                    showMessage('üéâ ‡∑É‡∑ä‡∑Ä‡∑è‡∂ú‡∂≠‡∂∏! ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª username ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±...', 'info');
                    
                    try {
                        const username = await showUsernameModal(user);
                        showMessage(`‚úÖ ‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${username}! üéâ`, 'success');
                        
                        setTimeout(() => {
                            window.location.href = 'Home.html';
                        }, 1500);
                    } catch (error) {
                        // If username setup fails, sign out the user
                        await auth.signOut();
                        disableButtons(false);
                        showMessage('‚ùå Username ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä! ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.', 'error');
                    }
                } else {
                    // Existing user - just login
                    const existingUsername = usernameSnapshot.val();
                    
                    // Update user profile if needed
                    if (user.displayName !== existingUsername) {
                        await user.updateProfile({ displayName: existingUsername });
                    }
                    
                    showMessage(`‚úÖ ‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${existingUsername}! üéâ`, 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'Home.html';
                    }, 1500);
                }
            } catch (error) {
                disableButtons(false);
                let errorMsg = 'Google ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑î‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä!';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMsg = '‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑î‡∂∏ ‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì.';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMsg = '‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª popup ‡∂Ö‡∑Ä‡∑Ñ‡∑í‡∂ª ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∂Ö‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.';
                }
                showMessage(`‚ùå ${errorMsg}`, 'error');
            }
        });

        // Enter key support
        document.getElementById('authPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('signInBtn').click();
        });
        
        document.getElementById('signUpPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('signUpBtn').click();
        });
        
        document.getElementById('modalUsername').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('confirmUsername').click();
        });
    </script>
</body>
</html>
