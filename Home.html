<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostKinaa - Social Media Home</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
        .fade-in { animation: fadeIn 0.5s ease-out; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }

        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .float { animation: float 3s ease-in-out infinite; }

        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); } 50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); } }
        .glow { animation: glow 2s ease-in-out infinite; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-100%); } to { opacity: 1; transform: translateX(0); } }
        .slide-in { animation: slideIn 0.6s ease-out; }

        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .post-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .post-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
        }

        .reaction-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .reaction-btn:hover {
            transform: scale(1.15);
        }

        .reaction-btn:active {
            transform: scale(0.95);
        }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .pulse-animation { animation: pulse 2s ease-in-out infinite; }

        .gradient-border {
            position: relative;
            border: 3px solid transparent;
            background-clip: padding-box;
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 3px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate { to { filter: hue-rotate(360deg); } }

        input:focus, textarea:focus {
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        .hover-lift {
            transition: all 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-3px);
        }
    </style>
</head>

<body class="min-h-screen">

    <header id="appHeader" class="glass-effect sticky top-0 z-50 shadow-2xl border-b-2 border-white/50">
        <div class="max-w-4xl mx-auto px-4 py-5 flex items-center justify-between">
            
            <div class="flex items-center space-x-4">
                <button onclick="goToSettings()" title="‡∑É‡∑ê‡∂ö‡∑É‡∑ì‡∂∏‡∑ä"
                    class="p-3 text-2xl text-gray-600 hover:text-purple-600 hover:bg-purple-100 rounded-2xl transition-all duration-300 hover:rotate-90 hover:scale-110">
                    ‚öôÔ∏è
                </button>
                <h1 class="text-4xl font-black bg-clip-text text-transparent float pulse-animation" id="headerTitle">üåü PostKinaa</h1>
            </div>

            <div class="flex items-center space-x-3">
                <button onclick="signOutUser()"  
                    class="px-5 py-2 bg-gradient-to-r from-red-400 to-pink-500 text-white rounded-full text-sm font-bold hover:from-red-500 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105">
                    üö™ Logout
                </button>
                <span id="connectionStatus" style="display:none;" 
                    class="px-4 py-2 bg-gradient-to-r from-green-400 to-emerald-500 text-white rounded-full text-sm font-bold shadow-lg glow">
                    ‚ú® Connected
                </span>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6">

        <div class="glass-effect rounded-3xl shadow-2xl border-2 border-white/40 p-8 mb-8 hover:shadow-[0_30px_70px_rgba(168,85,247,0.3)] transition-all duration-500 hover:scale-[1.02]">
            <div class="flex items-start space-x-5">

                <div class="w-14 h-14 bg-gradient-to-br from-purple-500 via-pink-500 to-blue-500 rounded-2xl flex items-center justify-center text-3xl shadow-2xl shrink-0 float">üòä</div>

                <div class="flex-1">
                    <input id="authorName" type="text" placeholder="‚ú® ‡∂î‡∂∂‡∑ö ‡∂±‡∂∏..." 
                        class="w-full px-5 py-3 mb-3 bg-white/60 backdrop-blur-sm rounded-2xl border-2 border-purple-200 focus:border-purple-500 outline-none transition-all duration-300 font-semibold text-gray-800 hover:bg-white/80 shadow-sm">

                    <textarea id="newPostInput" placeholder="üí≠ ‡∂î‡∂∂‡∑ö ‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä ‡∂∏‡∑ô‡∂≠‡∂± ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±... ‡∂Ö‡∂Ø ‡∂∏‡∑ú‡∂ö‡∂Ø ‡∑É‡∑í‡∂≠‡∂±‡∑ä‡∂±‡∑ö?"
                        class="w-full px-5 py-4 bg-white/60 backdrop-blur-sm rounded-2xl border-2 border-purple-200 focus:border-purple-500 outline-none resize-none transition-all duration-300 font-medium text-gray-700 hover:bg-white/80 shadow-sm"
                        rows="4"></textarea>
                    
                    <div class="mb-4 relative">
                        <span id="selectedFeelingDisplay" class="hidden px-4 py-2 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold shadow-inner transition-all duration-300 inline-flex items-center">
                            <span class="mr-1">Feeling:</span> <span id="currentFeelingEmoji"></span> <span id="currentFeelingText" class="ml-1"></span>
                            <button onclick="clearFeeling()" class="ml-3 text-red-500 hover:text-red-700 text-lg leading-none">x</button>
                        </span>
                        
                        <div id="feelingSelector" class="hidden absolute top-full left-0 mt-2 p-4 w-full glass-effect rounded-xl shadow-2xl border border-white/50 fade-in z-10">
                            <h4 class="font-bold text-gray-700 mb-3 text-lg">‡∂Ö‡∂Ø ‡∂î‡∂∂‡∑ö ‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏ ‡∂ö‡∑î‡∂∏‡∂ö‡∑ä‡∂Ø?</h4>
                            
                            <div class="flex flex-wrap gap-2 mb-4" id="defaultFeelingsContainer">
                                </div>

                            <div class="flex items-center space-x-2">
                                <div class="relative flex-1">
                                    <input type="text" id="customFeelingInput" 
                                        oninput="updateRecommendedEmoji(this.value)"
                                        placeholder="‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏‡∂ö‡∑ä ‡∂ß‡∂∫‡∑í‡∂¥‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±... (‡∂ã‡∂Ø‡∑è: happy, ‡∂Ø‡∑î‡∂ö‡∑ô‡∂±‡∑ä)"
                                        class="w-full px-4 py-2 pr-12 bg-white/70 rounded-lg border border-purple-200 focus:border-purple-500 outline-none transition-all duration-300 text-gray-700 text-sm">
                                    <span id="recommendedEmojiDisplay" class="absolute right-3 top-1/2 -translate-y-1/2 text-2xl opacity-50 transition-opacity duration-200" title="Recommended Emoji">
                                        üí≠
                                    </span>
                                </div>
                                <button onclick="handleCustomFeeling()"
                                    class="p-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors duration-300 text-sm font-semibold">
                                    ‚úîÔ∏è Add
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-5">
                        <div class="flex space-x-2">
                            <button onclick="openFeelingSelector()" title="‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"
                                class="p-3 hover:bg-gradient-to-br hover:from-pink-100 hover:to-yellow-100 rounded-2xl text-2xl transition-all duration-300 hover:scale-110 hover:-rotate-6">üòÄ</button>
                        </div>

                        <button onclick="createPost()" id="postButton"
                            class="px-8 py-3.5 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 text-white rounded-full font-bold hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 shadow-2xl transition-all duration-300 flex items-center space-x-2 hover:scale-105 hover:shadow-[0_15px_40px_rgba(168,85,247,0.5)]">
                            <span>üöÄ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="text-center py-12">
            <div class="inline-block w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full spinner"></div>
            <p class="mt-6 text-gray-700 font-bold text-lg">‚ú® ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä Loading ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</p>
            <p class="mt-2 text-gray-500">‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ª‡∑ê‡∂≥‡∑ì ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±</p>
        </div>

        <div id="postsFeed" style="display:none;"></div> 

        <div id="noPostsMessage" class="text-center py-16 glass-effect rounded-3xl border-2 border-white/40 shadow-2xl" style="display:none;">
            <div class="text-8xl mb-6 float">üì≠</div>
            <p class="text-2xl text-gray-700 font-bold mb-3">‡∂≠‡∑Ä‡∂∏ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂±‡∑ë</p>
            <p class="text-gray-500 text-lg">‡∂¥‡∑Ö‡∂∏‡∑î ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂î‡∂∂ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!</p>
            <p class="text-6xl mt-8">‚ú®</p>
        </div>
    </div>

    <script>

    /* ============================================================
        üî• Firebase Config + Init
    ============================================================ */
    const firebaseConfig = {
        apiKey: "AIzaSyAzNJ-P8aAMvTuNWKcQYCjIIHiaL0BpdZ0",
        authDomain: "game-f1c21.firebaseapp.com",
        databaseURL: "https://game-f1c21-default-rtdb.firebaseio.com",
        projectId: "game-f1c21",
        storageBucket: "game-f1c21.firebasestorage.app",
        messagingSenderId: "656338565711",
        appId: "1:656338565711:web:395f9c7f846588b065883a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    const postsRef = database.ref("posts");

    let currentUser = null;
    let selectedFeeling = null; 

    /* ============================================================
        üî• Theme System
    ============================================================ */
    const THEMES = {
        default: {
            bg: 'bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50',
            header: 'bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600',
            download: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
        },
        blue: {
            bg: 'bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50',
            header: 'bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600',
            download: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
        },
        green: {
            bg: 'bg-gradient-to-br from-green-50 via-teal-50 to-cyan-50',
            header: 'bg-gradient-to-r from-green-600 via-teal-600 to-cyan-600',
            download: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
        },
        dark: {
            bg: 'bg-gray-800', 
            header: 'bg-gradient-to-r from-gray-300 via-gray-100 to-gray-300', 
            download: 'linear-gradient(135deg, #374151 0%, #1f2937 100%)'
        },
    };

    function applyTheme() {
        const themeName = localStorage.getItem("appTheme") || "default";
        const theme = THEMES[themeName] || THEMES.default;

        document.body.className = "min-h-screen " + theme.bg;
        const headerTitle = document.getElementById("headerTitle");
        
        if (themeName === 'dark') {
            headerTitle.className =
                "text-3xl font-bold bg-clip-text text-white";
        } else {
            headerTitle.className =
                "text-3xl font-bold bg-clip-text text-transparent " + theme.header;
        }
    }

    /* ============================================================
        üî• Auth Check and Connection Status
    ============================================================ */
    auth.onAuthStateChanged(user => {
        const statusEl = document.getElementById("connectionStatus");
        if (!user) {
            statusEl.style.display = "none";
            window.location.href = "index.html";
            return;
        }
        
        statusEl.style.display = "inline-block";
        
        currentUser = user;
        database.ref('users/' + user.uid + '/name').once('value', snap => {
            const userName = snap.val();
            const defaultName = user.email ? user.email.split("@")[0] : '‡∂±‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠';
            document.getElementById('authorName').value = userName || defaultName;
        });

        applyTheme();
        loadPosts();
    });

    function signOutUser() {
        auth.signOut().then(() => {
            showNotification("Logout successful.");
            window.location.href = "index.html";
        });
    }

    /* ============================================================
        üî• Settings Page Redirection
    ============================================================ */
    function goToSettings() {
        window.location.href = "settings.html";
    }

    /* ============================================================
        üî• Load Posts - FIXED VERSION
    ============================================================ */
    function loadPosts() {
        const feed = document.getElementById("postsFeed");
        const loading = document.getElementById("loadingIndicator");
        const noPosts = document.getElementById("noPostsMessage");

        feed.innerHTML = "";
        loading.style.display = "block";
        feed.style.display = "none";
        noPosts.style.display = "none";

        // Changed from "on" to "once" to prevent duplicate rendering
        postsRef.orderByChild("timestamp").once("value").then(snap => { 
            loading.style.display = "none";
            
            if (!snap.exists()) {
                feed.style.display = "none";
                noPosts.style.display = "block";
                return;
            }

            const posts = [];
            snap.forEach(s => {
                posts.push({ id: s.key, ...s.val() });
            });
            
            // Reversing to show the latest posts first
            posts.reverse(); 

            feed.innerHTML = "";
            posts.forEach(p => renderPost(p));
            
            feed.style.display = "block";
        }).catch(err => {
            console.error("Error loading posts:", err);
            loading.style.display = "none";
            showNotification("‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂Ω‡∑ù‡∂©‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‚ùå");
        });

        // Listen for new posts in real-time
        postsRef.on("child_added", (snapshot) => {
            // Skip if initial load
            if (feed.innerHTML === "") return;
            
            const newPost = { id: snapshot.key, ...snapshot.val() };
            const existingPost = document.getElementById(`post-${newPost.id}`);
            
            if (!existingPost) {
                feed.insertBefore(createPostElement(newPost), feed.firstChild);
                showNotification("‡∂±‡∑Ä ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∑Ä‡∑î‡∂±‡∑è! üéâ");
            }
        });

        // Listen for post changes
        postsRef.on("child_changed", (snapshot) => {
            const updatedPost = { id: snapshot.key, ...snapshot.val() };
            const postElement = document.getElementById(`post-${updatedPost.id}`);
            
            if (postElement) {
                const newElement = createPostElement(updatedPost);
                postElement.replaceWith(newElement);
            }
        });

        // Listen for post deletions
        postsRef.on("child_removed", (snapshot) => {
            const postElement = document.getElementById(`post-${snapshot.key}`);
            if (postElement) {
                postElement.remove();
            }
            
            // Check if feed is empty
            if (feed.children.length === 0) {
                feed.style.display = "none";
                noPosts.style.display = "block";
            }
        });
    }

    /* ============================================================
        üî• Create Post Element
    ============================================================ */
    function createPostElement(post) {
        const timeAgo = getTimeAgo(post.timestamp);
        const me = currentUser ? currentUser.uid : null;
        const isAuthor = post.authorId === me;

        const myReaction = post.reactions && post.reactions[me] ? post.reactions[me] : null;
        const postFeeling = post.feeling; 

        const likeCount = post.reactionCounts?.like || 0;
        const laughCount = post.reactionCounts?.laugh || 0;
        const fireCount = post.reactionCounts?.fire || 0;

        const div = document.createElement("div");
        div.id = `post-${post.id}`;
        div.className =
            "post-card glass-effect rounded-3xl shadow-2xl border-2 border-white/40 p-7 hover:shadow-[0_30px_70px_rgba(168,85,247,0.3)] transition-all duration-500 fade-in mb-8";
        
        div.style.position = 'relative'; 

        const feelingDisplayHTML = postFeeling ? 
            `<span class="ml-2 px-2 py-0.5 bg-gradient-to-r from-yellow-50 to-pink-50 text-gray-700 rounded-full text-xs font-bold shadow-sm inline-flex items-center">
                <span class="mr-1 text-base">${postFeeling.emoji}</span> is feeling ${postFeeling.text}
            </span>`
            : '';

        div.innerHTML = `
            <div class="flex items-center justify-between mb-5">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-gradient-to-br ${post.gradient} rounded-2xl flex items-center justify-center text-3xl shadow-xl hover:scale-110 transition-transform duration-300">
                        ${post.avatar || '‚ùì'}
                    </div>
                    <div>
                        <div class="flex items-center">
                            <h3 class="font-bold text-gray-800 text-xl">${post.author || '‡∂±‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠'}</h3>
                            ${feelingDisplayHTML} 
                        </div>
                        <p class="text-sm text-gray-500 font-semibold">‚è∞ ${timeAgo}</p>
                    </div>
                </div>

                ${
                    isAuthor
                        ? `
                    <div class="flex space-x-2">
                        <button onclick="editPost('${post.id}', '${escapeText(post.content)}')"
                            class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-3 rounded-2xl text-xl transition-all duration-300 hover:scale-110 hover:rotate-12">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="deletePost('${post.id}')"
                            class="text-red-500 hover:text-red-700 hover:bg-red-50 p-3 rounded-2xl text-xl transition-all duration-300 hover:scale-110 hover:-rotate-12">
                            üóëÔ∏è
                        </button>
                    </div>`
                        : ""
                }
            </div>

            <p class="text-gray-800 mb-6 leading-relaxed text-lg whitespace-pre-line font-medium bg-gradient-to-r from-gray-700 to-gray-900 bg-clip-text">${post.content || 'Content not found'}</p>

            <div class="flex items-center justify-between pt-5 border-t-2 border-gray-100">
                <button onclick="toggleSingleReaction('${post.id}', 'like')"
                    class="reaction-btn flex items-center space-x-2 px-5 py-3 rounded-2xl hover:bg-gradient-to-r hover:from-pink-50 hover:to-red-50 text-gray-700 transition-all duration-300 hover:scale-110
                    ${myReaction === 'like' ? 'bg-gradient-to-r from-pink-100 to-red-100 text-pink-600 shadow-lg scale-105' : ''}">
                    <span class="text-2xl">‚ù§Ô∏è</span>
                    <span class="reaction-count font-bold text-lg">${likeCount}</span>
                </button>

                <button onclick="toggleSingleReaction('${post.id}', 'laugh')"
                    class="reaction-btn flex items-center space-x-2 px-5 py-3 rounded-2xl hover:bg-gradient-to-r hover:from-yellow-50 hover:to-orange-50 text-gray-700 transition-all duration-300 hover:scale-110
                    ${myReaction === 'laugh' ? 'bg-gradient-to-r from-yellow-100 to-orange-100 text-yellow-600 shadow-lg scale-105' : ''}">
                    <span class="text-2xl">üòÇ</span>
                    <span class="reaction-count font-bold text-lg">${laughCount}</span>
                </button>

                <button onclick="toggleSingleReaction('${post.id}', 'fire')"
                    class="reaction-btn flex items-center space-x-2 px-5 py-3 rounded-2xl hover:bg-gradient-to-r hover:from-orange-50 hover:to-red-50 text-gray-700 transition-all duration-300 hover:scale-110
                    ${myReaction === 'fire' ? 'bg-gradient-to-r from-orange-100 to-red-100 text-red-600 shadow-lg scale-105' : ''}">
                    <span class="text-2xl">üî•</span>
                    <span class="reaction-count font-bold text-lg">${fireCount}</span>
                </button>

                <button onclick="commentPost('${post.id}')"
                    class="px-5 py-3 rounded-2xl hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 text-gray-700 transition-all duration-300 flex items-center space-x-2 hover:scale-110">
                    <span class="text-2xl">üí¨</span>
                    <span class="font-bold text-lg">${post.commentsCount || 0}</span>
                </button>

                <button onclick="downloadPost('${post.id}')"
                    class="px-5 py-3 rounded-2xl hover:bg-gradient-to-r hover:from-green-50 hover:to-teal-50 text-gray-700 transition-all duration-300 flex items-center space-x-2 hover:scale-110 hover:rotate-12">
                    <span class="text-2xl">‚¨áÔ∏è</span>
                </button>
            </div>
        `;

        return div;
    }

    /* ============================================================
        üî• Render Single Post 
    ============================================================ */
    function renderPost(post) {
        const feed = document.getElementById("postsFeed");
        const postElement = createPostElement(post);
        feed.appendChild(postElement);
    }

    /* ============================================================
        üî• NEW: Feeling Feature Logic 
    ============================================================ */
    const FEELINGS_MAP = [
        { text: "‡∑É‡∂≠‡∑î‡∂ß‡∑í‡∂±‡∑ä", emoji: "üòä" },
        { text: "‡∂Ü‡∂Ø‡∂ª‡∂∫‡∑ô‡∂±‡∑ä", emoji: "ü•∞" },
        { text: "‡∂ö‡∂∏‡∑ä‡∂∏‡∑ê‡∂Ω‡∑í", emoji: "üò™" },
        { text: "‡∑É‡∂±‡∑ä‡∑É‡∑î‡∂±‡∑ä", emoji: "üßò" },
        { text: "‡∂ö‡∑ù‡∂¥‡∂∫‡∑ô‡∂±‡∑ä", emoji: "üò°" },
        { text: "‡∂ã‡∂Ø‡∑ä‡∂∫‡∑ù‡∂ú‡∂∫‡∑ô‡∂±‡∑ä", emoji: "ü§©" },
        { text: "‡∂Ø‡∑î‡∂ö‡∑ô‡∂±‡∑ä", emoji: "üò¢" },
        { text: "‡∂∂‡∂Ω‡∑è‡∂¥‡∑ú‡∂ª‡∑ú‡∂≠‡∑ä‡∂≠‡∑î ‡∑É‡∑Ñ‡∂ú‡∂≠‡∂∫‡∑í", emoji: "üôè" },
    ];

    function renderFeelingButtons() {
        const container = document.getElementById('defaultFeelingsContainer');
        container.innerHTML = '';
        
        FEELINGS_MAP.forEach(f => {
            const button = document.createElement('button');
            button.className = 'px-4 py-2 bg-white/80 rounded-full shadow-md text-sm font-medium hover:bg-purple-100 transition-colors duration-200 flex items-center space-x-1';
            button.innerHTML = `<span>${f.emoji}</span> <span class="ml-1">${f.text}</span>`;
            button.onclick = () => selectFeeling(f.text, f.emoji);
            container.appendChild(button);
        });
    }

    function openFeelingSelector() {
        const selector = document.getElementById('feelingSelector');
        selector.classList.toggle('hidden');
        // Render buttons the first time it opens
        if (selector.querySelector('#defaultFeelingsContainer').children.length === 0) {
            renderFeelingButtons();
        }
    }

    function selectFeeling(text, emoji) {
        selectedFeeling = { text: text, emoji: emoji };
        
        // Update display
        document.getElementById('currentFeelingEmoji').textContent = emoji;
        document.getElementById('currentFeelingText').textContent = text;
        document.getElementById('selectedFeelingDisplay').classList.remove('hidden');
        document.getElementById('feelingSelector').classList.add('hidden'); // Hide selector after selection
        
        showNotification(`Feeling added: ${emoji} ${text} üéâ`);
    }

    function clearFeeling() {
        selectedFeeling = null;
        document.getElementById('selectedFeelingDisplay').classList.add('hidden');
        document.getElementById('customFeelingInput').value = '';
        document.getElementById('recommendedEmojiDisplay').textContent = "üí≠"; // Reset recommended emoji
        showNotification("Feeling removed.");
    }
    
    // üî• NEW FUNCTION: Logic to recommend emoji based on text
    function recommendEmoji(text) {
        if (!text) return "üí≠";
        
        const lowerText = text.toLowerCase();

        // Specific keywords check (more weight)
        if (lowerText.includes("love") || lowerText.includes("‡∂Ü‡∂Ø‡∂ª") || lowerText.includes("‡∂¥‡∑ä‚Äç‡∂ª‡∑ö‡∂∏")) return "üíñ";
        if (lowerText.includes("tired") || lowerText.includes("‡∂∏‡∑Ñ‡∂±‡∑ä‡∑É‡∑í") || lowerText.includes("‡∂±‡∑í‡∂Ø‡∑í")) return "üò¥";
        if (lowerText.includes("happy") || lowerText.includes("‡∑É‡∂≠‡∑î‡∂ß") || lowerText.includes("joy")) return "ü•≥";
        if (lowerText.includes("angry") || lowerText.includes("‡∂ö‡∑ö‡∂±‡∑ä‡∂≠‡∑í‡∂∫") || lowerText.includes("heat")) return "üî•";
        if (lowerText.includes("sad") || lowerText.includes("‡∂Ø‡∑î‡∂ö") || lowerText.includes("‡∂Ö‡∂©‡∑î")) return "üò≠";
        if (lowerText.includes("hungry") || lowerText.includes("‡∂∂‡∂©‡∂ú‡∑í‡∂±‡∑í")) return "üçî";
        if (lowerText.includes("excited") || lowerText.includes("‡∂ã‡∂Ø‡∑ä‡∂∫‡∑ù‡∂ú") || lowerText.includes("‡∑Ä‡∑í‡∂±‡∑ù‡∂Ø")) return "üéâ";

        // General keywords check
        if (lowerText.includes("‡∑É‡∂≠‡∑î‡∂ß") || lowerText.includes("happy")) return "üòä";
        if (lowerText.includes("‡∂ö‡∂∏‡∑ä‡∂∏‡∑ê‡∂Ω‡∑í") || lowerText.includes("boring")) return "üò™";
        if (lowerText.includes("‡∑É‡∂±‡∑ä‡∑É‡∑î‡∂±‡∑ä") || lowerText.includes("calm")) return "üßò";
        if (lowerText.includes("‡∂ö‡∑ù‡∂¥") || lowerText.includes("angry")) return "üò°";
        
        return "üí≠"; // Default when no match
    }

    // üî• NEW FUNCTION: Updates the visible emoji next to the input
    function updateRecommendedEmoji(text) {
        const display = document.getElementById('recommendedEmojiDisplay');
        if (display) {
            display.textContent = recommendEmoji(text);
        }
    }

    // üî• UPDATED FUNCTION: Uses the recommended emoji
    function handleCustomFeeling() {
        const input = document.getElementById('customFeelingInput');
        const display = document.getElementById('recommendedEmojiDisplay');
        
        const customText = input.value.trim();
        const finalEmoji = display.textContent.trim() || "üí≠"; // Get the currently recommended emoji

        if (!customText) return;

        selectFeeling(customText, finalEmoji);
        input.value = ''; // Clear input
        display.textContent = "üí≠"; // Reset recommended emoji after use
    }
    
    /* ============================================================
        üî• Create Post 
    ============================================================ */
    function createPost() {
        const name = document.getElementById("authorName").value.trim() || currentUser.email.split("@")[0];
        const content = document.getElementById("newPostInput").value.trim();

        if (!content && !selectedFeeling) return showNotification("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±, ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!");

        const btn = document.getElementById("postButton");
        btn.disabled = true;
        btn.innerHTML = `<span class="inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full spinner"></span>`;

        const avatars = ["üòä","üé®","‚ú®","üåü","üé≠","üéÆ","üòé","ü§©"];
        const gradients = [
            "from-purple-400 to-pink-400",
            "from-blue-400 to-purple-400",
            "from-pink-400 to-orange-400",
            "from-green-400 to-teal-400",
            "from-indigo-400 to-blue-400"
        ];

        const newPost = {
            author: name,
            content: content,
            authorId: currentUser.uid,
            avatar: avatars[Math.floor(Math.random()*avatars.length)],
            gradient: gradients[Math.floor(Math.random()*gradients.length)],
            feeling: selectedFeeling || null, 
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            reactionCounts: {
                like: 0, 
                laugh: 0,
                fire: 0
            },
            commentsCount: 0,
        };

        postsRef.push(newPost)
        .then(() => {
            document.getElementById("newPostInput").value = "";
            clearFeeling(); 
            btn.disabled = false;
            btn.innerHTML = `<span>üöÄ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</span>`;
            showNotification("‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂¥‡∑Ö ‡∂ö‡∑Ö‡∑è! üéâ");
            // Also save the name to the user's profile
            database.ref('users/' + currentUser.uid).update({ name: name }); 
        })
        .catch(error => {
            console.error("Post Creation Error:", error);
            btn.disabled = false;
            btn.innerHTML = `<span>üöÄ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</span>`;
            showNotification("‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‚ùå");
        });
    }

    /* ============================================================
        üî• Single Reaction System
    ============================================================ */
    function toggleSingleReaction(postId, newReactionType) {
        if (!currentUser) return;

        const uid = currentUser.uid;
        const postReactionsRef = postsRef.child(postId).child("reactions");
        const userReactionRef = postReactionsRef.child(uid);
        const countsRef = postsRef.child(postId).child("reactionCounts");

        userReactionRef.once("value").then(snap => {
            const currentReaction = snap.val();

            if (currentReaction === newReactionType) {
                userReactionRef.remove();
                countsRef.child(newReactionType).transaction(count => (count || 1) - 1);
            } else {
                if (currentReaction) {
                    countsRef.child(currentReaction).transaction(count => (count || 1) - 1);
                }

                userReactionRef.set(newReactionType);

                countsRef.child(newReactionType).transaction(count => (count || 0) + 1);
            }
        });
    }

    function deletePost(id) {
        if (!confirm("‡∂∏‡∑ô‡∂∏ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂∏‡∂ö‡∂±‡∑ä‡∂±‡∂Ø?")) return;

        postsRef.child(id).once("value").then(s => {
            if (s.val().authorId !== currentUser.uid) {
                showNotification("‡∂î‡∂∂‡∂ß ‡∂∏‡∑ô‡∂ö ‡∂∏‡∑ê‡∂ö‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂±‡∑ê‡∑Ñ‡∑ê");
                return;
            }
            postsRef.child(id).remove();
            showNotification("‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂∏‡∂ö‡∂± ‡∂Ω‡∂Ø‡∑ì üóëÔ∏è");
        });
    }

    function editPost(id, oldContent) {
        const newText = prompt("‡∂±‡∑Ä ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:", unescapeText(oldContent));
        if (!newText) return;

        postsRef.child(id).update({
            content: newText,
            edited: true
        });
        showNotification("‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í ‚úèÔ∏è");
    }

    function commentPost(id) {
        window.location.href = `comment.html?postId=${id}`;
    }

    /* ============================================================
        üî• Download Post (Original Complex Logic - UNCHANGED)
    ============================================================ */
    function downloadPost(postId) {
        postsRef.child(postId).once("value").then(snap => {
            const post = snap.val();
            if (!post) return;

            const themeName = localStorage.getItem("appTheme") || "default";
            const theme = THEMES[themeName] || THEMES.default;

            const wrapper = document.createElement("div");
            wrapper.style.cssText = `
                width: 800px;
                height: 760px;
                position: fixed;
                top: -9999px;
                left: -9999px;
                font-family: system-ui, -apple-system, sans-serif;
            `;

            wrapper.innerHTML = `
                <div style="
                    width: 100%;
                    height: 100%;
                    background: ${theme.download};
                    border-radius: 30px;
                    padding: 50px;
                    box-sizing: border-box;
                    display: flex;
                    flex-direction: column;
                ">
                    <div style="
                        background: white;
                        border-radius: 25px;
                        padding: 45px;
                        height: 100%;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
                        display: flex;
                        flex-direction: column;
                        position: relative;
                    ">
                        <div style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 35px;
                            padding-bottom: 25px;
                            border-bottom: 3px solid #f3f4f6;
                        ">
                            <div style="
                                width: 70px;
                                height: 70px;
                                background: ${theme.download};
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 38px;
                                margin-right: 20px;
                                box-shadow: 0 8px 20px rgba(0,0,0,0.12);
                            ">${post.avatar || '‚ùì'}</div>
                            
                            <div style="flex: 1;">
                                <h2 style="
                                    font-size: 32px;
                                    font-weight: 700;
                                    color: #1f2937;
                                    margin: 0 0 5px 0;
                                    letter-spacing: -0.5px;
                                ">${post.author || '‡∂±‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠'}</h2>
                                <p style="
                                    font-size: 16px;
                                    color: #9ca3af;
                                    margin: 0;
                                    font-weight: 500;
                                ">PostKinaa Member</p>
                            </div>
                        </div>

                        <div style="
                            flex: 1;
                            display: flex;
                            align-items: center;
                            overflow: hidden;
                            margin-bottom: 30px;
                        ">
                            <p style="
                                font-size: 26px;
                                line-height: 1.7;
                                color: #374151;
                                margin: 0;
                                white-space: pre-line;
                                font-weight: 400;
                            ">${post.content || 'Content not found'}</p>
                        </div>

                        <div style="
                            padding-top: 25px;
                            border-top: 3px solid #f3f4f6;
                            display: flex;
                            justify-content: flex-end; 
                            align-items: center;
                        ">
                            <span style="
                                font-size: 18px;
                                color: #9ca3af;
                                font-weight: 600;
                            ">PostKinaa.com</span>
                        </div>

                        <div style="
                            position: absolute;
                            top: 0;
                            right: 0;
                            width: 120px;
                            height: 120px;
                            background: ${theme.download};
                            opacity: 0.08;
                            border-radius: 0 25px 0 100%;
                        "></div>
                    </div>
                </div>
            `;

            document.body.appendChild(wrapper);

            html2canvas(wrapper, { 
                scale: 3,
                backgroundColor: null,
                logging: false
            }).then(canvas => {
                const link = document.createElement("a");
                link.download = `PostKinaa_${post.author}_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png", 1.0);
                link.click();
                wrapper.remove();
                showNotification("‚¨áÔ∏è Download ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í!");
            }).catch(err => {
                console.error(err);
                wrapper.remove();
                showNotification("Download error ‚ùå");
            });
        });
    }

    /* ============================================================
        üî• Helpers
    ============================================================ */
    function getTimeAgo(ts) {
        if (!ts) return "‡∂∏‡∑ô‡∂∏ ‡∂∏‡∑ú‡∑Ñ‡∑ú‡∂≠‡∑ö";
        const diff = Date.now() - ts;
        const s = diff/1000;
        if (s<60) return `${Math.floor(s)}s ‡∂¥‡∑ô‡∂ª`;
        const m=s/60;
        if (m<60) return `${Math.floor(m)}min ‡∂¥‡∑ô‡∂ª`;
        const h=m/60;
        if (h<24) return `${Math.floor(h)}h ‡∂¥‡∑ô‡∂ª`;
        return `${Math.floor(h/24)}d ‡∂¥‡∑ô‡∂ª`;
    }

    function showNotification(text) {
        const box = document.createElement("div");
        box.className = "fixed top-5 left-1/2 -translate-x-1/2 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 text-white px-6 py-3 rounded-full shadow-2xl text-sm z-50 fade-in font-bold";
        box.textContent = text;
        document.body.appendChild(box);
        setTimeout(() => {
            box.style.opacity = "0";
            box.style.transform = "translateX(-50%) translateY(-20px)";
            setTimeout(()=>box.remove(),300);
        },2500);
    }

    // HTML special character escaping for passing content via onclick
    function escapeText(text) {
        return text.replace(/'/g, '&#39;').replace(/"/g, '&#34;');
    }
    
    // Reverse escape for use in JS prompt
    function unescapeText(text) {
        return text.replace(/&#39;/g, "'").replace(/&#34;/g, '"');
    }

    </script>

</body>
</html>