<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostKinaa - Social Media Home</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* ============================================================
            üî• ANIMATIONS & STYLES
        ============================================================ */
        @keyframes fadeIn { from { opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
        .fade-in { animation: fadeIn 0.5s ease-out; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .float { animation: float 3s ease-in-out infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .pulse-animation { animation: pulse 2s ease-in-out infinite; }

        .glass-effect {
            background-color: rgba(255, 255, 255, 0.5); 
            backdrop-filter: blur(10px);
        }
        
        /* Utility for pre-line wrapping */
        .whitespace-pre-line {
            white-space: pre-line;
        }

        /* Hide Scrollbar for Notifications Panel */
        #notificationList::-webkit-scrollbar {
            width: 0;
            background: transparent; 
        }
        #notificationList {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* üî• NEW: Modal Enter/Exit Animations */
        .modal-enter { opacity: 0; transform: translateY(20px); }
        .modal-enter-active { opacity: 1; transform: translateY(0); transition: opacity 0.3s, transform 0.3s; }
        .modal-exit { opacity: 1; transform: translateY(0); }
        .modal-exit-active { opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; }

    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">

    <span id="connectionStatus" 
          class="fixed bottom-4 right-4 z-[100] text-xs font-semibold px-3 py-1 rounded-full text-white bg-gradient-to-r from-emerald-500 to-green-500 shadow-lg glow">
          ‚ú® Connected
    </span>

    <header class="sticky top-0 z-50 p-4 sm:p-5 bg-white/90 backdrop-blur-lg shadow-lg border-b border-gray-100">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <h1 id="headerTitle" class="text-3xl sm:text-4xl font-black bg-clip-text text-transparent float pulse-animation bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600">PostKinaa</h1>
            
            <div class="flex items-center space-x-3 sm:space-x-4">
                
                <div class="relative">
                    <button onclick="goToChat()" class="p-3 text-2xl text-gray-700 hover:text-purple-600 transition-colors duration-200 focus:outline-none">
                        üó®Ô∏è
                    </button>
                    <span id="unreadChatIndicator" class="hidden absolute top-1 right-1 w-3 h-3 bg-red-600 rounded-full border-2 border-white shadow-md"></span>
                </div>
                
                <div class="relative">
                    <button onclick="toggleNotificationPanel()" class="p-3 text-2xl text-gray-700 hover:text-purple-600 transition-colors duration-200 focus:outline-none">
                        <span role="img" aria-label="Notifications">üîî</span>
                    </button>
                    <span id="unreadIndicator" class="hidden absolute top-1 right-1 w-3 h-3 bg-red-600 rounded-full border-2 border-white shadow-md"></span>
                </div>
                
                <button onclick="goToSettings()" class="w-10 h-10 sm:w-11 sm:h-11 bg-gray-200 rounded-full text-xl font-bold flex items-center justify-center hover:ring-4 hover:ring-purple-300 transition-all duration-300">
                    ‚öôÔ∏è
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 sm:p-6 pb-20">

        <div id="loadingIndicator" class="text-center py-10">
            <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full inline-block spinner"></div>
            <p class="text-gray-600 mt-3 font-semibold">Posts Loading...</p>
        </div>
        
        <div id="noPostsMessage" class="hidden text-center py-20 glass-effect rounded-2xl p-8 border-2 border-white/40 shadow-xl">
            <p class="text-3xl mb-3">üò≠</p>
            <h2 class="text-xl font-bold text-gray-700">‡∂≠‡∑Ä‡∂∏ Post ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∑ë!</h2>
            <p class="text-gray-500 mt-2">‡∂¥‡∑Ö‡∂∏‡∑î Post ‡∂ë‡∂ö ‡∂Ø‡∑è‡∂±‡∑ä‡∂±.</p>
        </div>

        <div id="postsFeed" class="space-y-8">
            </div>

    </main>
    
    <button onclick="openPostModal()" 
            class="fixed bottom-20 right-5 sm:bottom-8 sm:right-8 z-40 
                   w-14 h-14 sm:w-16 sm:h-16 
                   bg-gradient-to-r from-pink-500 to-purple-600 text-white 
                   rounded-full shadow-2xl hover:scale-105 transition-transform duration-300 
                   flex items-center justify-center text-3xl font-bold ring-4 ring-white ring-opacity-50">
        +
    </button>
    
    <div id="postModalOverlay" onclick="closePostModal()"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[1000] hidden flex items-center justify-center transition-opacity duration-300">
        
        <div id="postCreationCard" onclick="event.stopPropagation()"
             class="bg-white rounded-3xl shadow-2xl p-6 sm:p-8 w-11/12 max-w-lg modal-enter max-h-[90vh] overflow-y-auto">
             
            <div class="flex items-start justify-between border-b pb-4 mb-4">
                <h2 class="text-2xl font-bold text-gray-800">‡∂±‡∑Ä Post ‡∂ë‡∂ö‡∂ö‡∑ä</h2>
                <button onclick="closePostModal()" class="p-1 text-gray-500 hover:text-red-500">
                    ‚úñÔ∏è
                </button>
            </div>

            <div class="flex items-start space-x-4 mb-4">
                <div id="postAvatarContainer" class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-br from-purple-500 via-pink-500 to-blue-500 rounded-xl sm:rounded-2xl flex items-center justify-center text-2xl sm:text-3xl shadow-xl shrink-0">
                    </div>
                <div class="flex-1">
                    <input type="text" id="authorName" placeholder="‡∂î‡∂∂‡∂ú‡∑ö ‡∂±‡∂∏..." class="w-full bg-white/70 backdrop-blur-sm p-3 rounded-lg border border-gray-300 text-gray-700 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 mb-3" maxlength="50" readonly>
                </div>
            </div>
            
            <textarea id="postContent" placeholder="‡∂î‡∂∂‡∑ö ‡∂Ö‡∂Ø‡∑Ñ‡∑É ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±..." class="w-full bg-white p-3 rounded-lg border border-gray-300 text-gray-700 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 h-32 sm:h-40 resize-none mb-4"></textarea>

            <div class="flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0 sm:space-x-4">
                <div class="w-full sm:w-auto relative group">
                    <button id="feelingButton" onclick="toggleFeelingPanel()" class="w-full sm:w-auto px-4 py-2 bg-gray-100 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-200 transition-colors duration-200 flex items-center justify-center sm:justify-start space-x-2">
                        <span id="currentFeelingEmoji" class="text-xl">üôÇ</span>
                        <span id="currentFeelingText" class="font-medium text-sm">Select Feeling (Optional)</span>
                    </button>
                    <div id="feelingPanel" class="hidden absolute z-20 bottom-full mb-2 w-full sm:w-72 bg-white rounded-xl shadow-2xl p-3 border border-gray-200">
                        <p class="font-bold text-sm mb-2 text-gray-700">How are you feeling?</p>
                        <div class="grid grid-cols-3 gap-2">
                            </div>
                    </div>
                </div>

                <button id="postButton" onclick="createPost()" class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 text-white font-bold rounded-full shadow-lg hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 transition-all duration-300 text-base sm:text-lg">
                    Post ‡∂ö‡∂ª‡∂±‡∑ä‡∂±! ‚ú®
                </button>
            </div>
            
        </div>
    </div>


    <div id="notificationPanel" 
         class="fixed top-0 right-0 w-full md:w-96 h-full bg-white/90 backdrop-blur-xl shadow-2xl z-[1001] transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col border-l border-gray-100">
        
        <div class="p-5 border-b-2 border-gray-100 flex items-center justify-between sticky top-0 bg-white/90 backdrop-blur-sm">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center space-x-2">
                üîî <span>‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏‡∑ä</span>
            </h2>
            <button onclick="closeNotificationPanel()" class="p-2 text-gray-500 hover:text-red-500 text-xl transition-colors duration-200">
                ‚úñÔ∏è
            </button>
        </div>
        
        <div id="notificationList" class="flex-1 overflow-y-auto p-4 space-y-3">
            </div>

    </div>


    <script>

        /* ============================================================
            üî• Firebase Config + Init
        ============================================================ */
        const firebaseConfig = {
            apiKey: "AIzaSyAzNJ-P8aAMvTuNWKcQYCjIIHiaL0BpdZ0",
            authDomain: "game-f1c21.firebaseapp.com",
            databaseURL: "https://game-f1c21-default-rtdb.firebaseio.com",
            projectId: "game-f1c21",
            storageBucket: "game-f1c21.firebasestorage.app",
            messagingSenderId: "656338565711",
            appId: "1:656338565711:web:395f9c7f846588b065883a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const postsRef = database.ref("posts");
        const usersRef = database.ref("users"); 
        const notificationsRef = database.ref("notifications"); 

        let currentUser = null;
        // üî• FIX 3: Feeling ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∑è ‡∂±‡∑ú‡∂ú‡∑ô‡∂± Post ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß ‡∂â‡∂© ‡∂Ø‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è null ‡∂Ω‡∑ô‡∑É ‡∂≠‡∂∂‡∂∫‡∑í
        let selectedFeeling = null; 
        let allNotifications = []; 
        let currentUserName = '';
        let currentUserAvatar = 'üë§'; 

        /* ============================================================
            üî• Navigation
        ============================================================ */
        function goToChat() {
            window.location.href = "chat.html";
        }
        
        function goToSettings() {
            window.location.href = "settings.html";
        }

        function goToProfile(uid) {
            window.location.href = `profile.html?uid=${uid}`; 
        }

        /* ============================================================
            üî• Theme System (UNCHANGED)
        ============================================================ */
        const THEMES = {
            default: {
                bg: 'bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50',
                header: 'from-purple-600 via-pink-600 to-blue-600',
                download: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                button: 'from-purple-600 via-pink-600 to-blue-600',
                avatarGradient: 'from-purple-500 via-pink-500 to-blue-500', 
                settingBack: 'text-purple-600 hover:bg-purple-100', 
                settingBackBG: '#9333ea', 
            },
            blue: {
                bg: 'bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50',
                header: 'from-blue-600 via-indigo-600 to-purple-600',
                download: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                button: 'from-blue-600 via-indigo-600 to-purple-600',
                avatarGradient: 'from-blue-500 via-indigo-500 to-purple-500',
                settingBack: 'text-blue-600 hover:bg-blue-100',
                settingBackBG: '#3b82f6',
            },
            green: {
                bg: 'bg-gradient-to-br from-green-50 via-teal-50 to-cyan-50',
                header: 'from-green-600 via-teal-600 to-cyan-600',
                download: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                button: 'from-green-600 via-teal-600 to-cyan-600',
                avatarGradient: 'from-green-500 via-teal-500 to-cyan-500',
                settingBack: 'text-green-600 hover:bg-green-100',
                settingBackBG: '#10b981',
            },
            dark: {
                bg: 'bg-gray-800', 
                header: 'bg-white', 
                download: 'linear-gradient(135deg, #374151 0%, #1f2937 100%)',
                button: 'from-gray-600 via-gray-700 to-gray-800', 
                avatarGradient: 'from-gray-700 via-gray-600 to-gray-500',
                settingBack: 'text-gray-400 hover:bg-gray-700 hover:text-white',
                settingBackBG: '#4b5563',
            },
            red: {
                bg: 'bg-gradient-to-br from-red-50 via-pink-50 to-orange-50',
                header: 'from-red-600 via-pink-600 to-orange-600',
                download: 'linear-gradient(135deg, #f87171 0%, #f43f5e 100%)',
                button: 'from-red-600 via-pink-600 to-orange-600',
                avatarGradient: 'from-red-500 via-pink-500 to-orange-500',
                settingBack: 'text-red-600 hover:bg-red-100',
                settingBackBG: '#ef4444',
            },
            yellow: {
                bg: 'bg-gradient-to-br from-yellow-50 via-amber-50 to-orange-50',
                header: 'from-yellow-600 via-amber-600 to-orange-600',
                download: 'linear-gradient(135deg, #fcd34d 0%, #fb923c 100%)',
                button: 'from-yellow-600 via-amber-600 to-orange-600',
                avatarGradient: 'from-yellow-500 via-amber-500 to-orange-500',
                settingBack: 'text-yellow-600 hover:bg-yellow-100',
                settingBackBG: '#f59e0b',
            },
            teal: {
                bg: 'bg-gradient-to-br from-teal-50 via-cyan-50 to-blue-50',
                header: 'from-teal-600 via-cyan-600 to-blue-600',
                download: 'linear-gradient(135deg, #2dd4bf 0%, #06b6d4 100%)',
                button: 'from-teal-600 via-cyan-600 to-blue-600',
                avatarGradient: 'from-teal-500 via-cyan-500 to-blue-500',
                settingBack: 'text-teal-600 hover:bg-teal-100',
                settingBackBG: '#14b8a6',
            }
        };

        function applyTheme() {
            const themeName = localStorage.getItem("appTheme") || "default";
            const theme = THEMES[themeName] || THEMES.default;

            document.body.className = "min-h-screen " + theme.bg;
            const headerTitle = document.getElementById("headerTitle");
            const postButton = document.getElementById("postButton");
            const postAvatarContainer = document.getElementById("postAvatarContainer");

            if (themeName === 'dark') {
                headerTitle.className = "text-3xl sm:text-4xl font-black bg-clip-text text-white float pulse-animation";
            } else {
                headerTitle.className = headerTitle.className.replace(/from-.*?to-.*?/g, ''); 
                headerTitle.className =
                    "text-3xl sm:text-4xl font-black bg-clip-text text-transparent float pulse-animation bg-gradient-to-r " + theme.header;
            }

            postButton.classList.remove('from-purple-600', 'via-pink-600', 'to-blue-600', 'from-purple-700', 'via-pink-700', 'to-blue-700');
            postButton.classList.add(...theme.button.split(' '), ...theme.button.replace(/600/g, '700').split(' ').map(cls => cls.replace('from-', 'hover:from-').replace('via-', 'hover:via-').replace('to-', 'hover:to-')));

            if (postAvatarContainer) {
                // üî• FIX 5: Avatar container gradient update
                postAvatarContainer.classList.remove('from-purple-500', 'via-pink-500', 'to-blue-500');
                postAvatarContainer.classList.add('bg-gradient-to-br', ...theme.avatarGradient.split(' '));
            }
        }

        /* ============================================================
            üî• Real-time Connection Status (UNCHANGED)
        ============================================================ */
        const statusEl = document.getElementById("connectionStatus");

        database.ref('.info/connected').on('value', (snap) => {
            const isConnected = snap.val();
            
            if (isConnected === false) {
                statusEl.textContent = 'üî¥ Offline';
                statusEl.className = statusEl.className.replace(/green|emerald|blue/g, 'red').replace(/glow/, 'pulse-animation');
            } else {
                statusEl.textContent = '‚ú® Connected';
                statusEl.className = statusEl.className.replace(/red/g, 'green').replace(/pulse-animation/, 'glow');
            }
        });

        /* ============================================================
            üî• Auth Check and User Data Setup
        ============================================================ */
        auth.onAuthStateChanged(user => {
            if (!user) {
                statusEl.style.display = "none";
                window.location.href = "index.html";
                return;
            }
            
            statusEl.style.display = "inline-block";
            
            currentUser = user;
            const uid = user.uid;
            
            usersRef.child(uid).once('value', snap => {
                const userData = snap.val();
                const defaultName = user.email ? user.email.split("@")[0] : '‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è';
                
                if (!userData) {
                    usersRef.child(uid).set({
                        name: defaultName,
                        avatar: 'üë§',
                        followerCount: 0,
                        followingCount: 0,
                    }).then(() => {
                        currentUserName = defaultName;
                        currentUserAvatar = 'üë§';
                        updatePostModalUserInfo();
                    });
                } else {
                    currentUserName = userData.name || defaultName;
                    currentUserAvatar = userData.avatar || 'üë§';
                    
                    if (!userData.name) {
                        usersRef.child(uid).update({ name: defaultName });
                    }
                    updatePostModalUserInfo();
                }
            });

            applyTheme();
            loadPosts();
            setupNotificationListener(); 
            setupUnreadChatListener(); 
        });
        
        // üî• FIX 5: Modal ‡∂ë‡∂ö‡∑ö User Info update ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        function updatePostModalUserInfo() {
            const authorNameEl = document.getElementById('authorName');
            const avatarContainerEl = document.getElementById('postAvatarContainer');

            if (authorNameEl) {
                authorNameEl.value = currentUserName;
            }
            
            if (avatarContainerEl) {
                // Remove old emoji content
                while (avatarContainerEl.firstChild) {
                    avatarContainerEl.removeChild(avatarContainerEl.firstChild);
                }
                // Add new emoji
                const span = document.createElement('span');
                span.textContent = currentUserAvatar;
                avatarContainerEl.appendChild(span);
            }
        }

        function signOutUser() {
            auth.signOut().then(() => {
                notifyUser("PostKinaa", "‡∂Ω‡∑ú‡∂ú‡∑ä ‡∂Ö‡∑Ä‡∑î‡∂ß‡∑ä ‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í."); // üî• Modified
                window.location.href = "index.html";
            });
        }

        /* ============================================================
            üî• Post Loading and Rendering (UNCHANGED LOGIC)
        ============================================================ */
        function loadPosts() {
            const feed = document.getElementById("postsFeed");
            const loading = document.getElementById("loadingIndicator");
            const noPosts = document.getElementById("noPostsMessage");

            feed.innerHTML = "";
            loading.style.display = "block";
            feed.style.display = "none";
            noPosts.style.display = "none";

            postsRef.orderByChild("timestamp").once("value").then(snap => { 
                loading.style.display = "none";
                
                if (!snap.exists()) {
                    feed.style.display = "none";
                    noPosts.style.display = "block";
                    return;
                }

                const posts = [];
                snap.forEach(s => {
                    posts.push({ id: s.key, ...s.val() });
                });
                
                posts.reverse(); 

                feed.innerHTML = "";
                posts.forEach(p => renderPost(p));
                
                feed.style.display = "block";
            }).catch(err => {
                console.error("Error loading posts:", err);
                loading.style.display = "none";
                notifyUser("PostKinaa Error", "‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂Ω‡∑ù‡∂©‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‚ùå"); // üî• Modified
            });

            postsRef.on("child_added", (snapshot) => {
                if (feed.innerHTML === "") return;
                
                const newPost = { id: snapshot.key, ...snapshot.val() };
                const existingPost = document.getElementById(`post-${newPost.id}`);
                
                if (!existingPost) {
                    feed.insertBefore(createPostElement(newPost), feed.firstChild);
                    notifyUser("PostKinaa", "‡∂±‡∑Ä ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∑Ä‡∑î‡∂±‡∑è! üéâ"); // üî• Modified
                }
            });

            postsRef.on("child_changed", (snapshot) => {
                const updatedPost = { id: snapshot.key, ...snapshot.val() };
                const postElement = document.getElementById(`post-${updatedPost.id}`);
                
                if (postElement) {
                    const newElement = createPostElement(updatedPost);
                    postElement.replaceWith(newElement);
                }
            });

            postsRef.on("child_removed", (snapshot) => {
                const postElement = document.getElementById(`post-${snapshot.key}`);
                if (postElement) {
                    postElement.remove();
                }
                
                if (feed.children.length === 0) {
                    feed.style.display = "none";
                    noPosts.style.display = "block";
                }
            });
        }

        function createPostElement(post) {
            const timeAgo = getTimeAgo(post.timestamp);
            const me = currentUser ? currentUser.uid : null;
            const isAuthor = post.authorId === me;

            const myReaction = post.reactions && post.reactions[me] ? post.reactions[me] : null;

            const likeCount = post.reactionCounts?.like || 0;
            const laughCount = post.reactionCounts?.laugh || 0;
            const fireCount = post.reactionCounts?.fire || 0;
            // üî• NEW: Add Heart and Sad reaction counts
            const heartCount = post.reactionCounts?.heart || 0;
            const sadCount = post.reactionCounts?.sad || 0;
            
            const postFeeling = post.feeling; 

            const div = document.createElement("div");
            div.id = `post-${post.id}`;
            div.className = "post-card glass-effect rounded-3xl shadow-2xl border-2 border-white/40 p-5 sm:p-7 hover:shadow-[0_30px_70px_rgba(168,85,247,0.3)] transition-all duration-500 fade-in mb-8";
            
            div.style.position = 'relative'; 

            // üî• FIX 4: Feeling ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂≠‡∑í‡∂∂‡∑ö ‡∂±‡∂∏‡∑ä ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í
            const feelingDisplayHTML = postFeeling ? 
                `<span class="ml-2 px-2 py-0.5 bg-gradient-to-r from-yellow-50 to-pink-50 text-gray-700 rounded-full text-xs font-bold shadow-sm inline-flex items-center mt-1 sm:mt-0">
                    <span class="mr-1 text-base">${postFeeling.emoji}</span> is feeling ${postFeeling.text}
                </span>`
                : '';


            div.innerHTML = `
                <div class="flex items-start justify-between mb-4 sm:mb-5 flex-wrap">
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-br ${post.gradient} rounded-xl sm:rounded-2xl flex items-center justify-center text-2xl sm:text-3xl shadow-xl hover:scale-110 transition-transform duration-300 shrink-0">
                            ${post.avatar || '‚ùì'}
                        </div>
                        <div>
                            <div class="flex items-start flex-wrap">
                                <h3 class="font-bold text-gray-800 text-lg sm:text-xl">
                                    <a onclick="goToProfile('${post.authorId}')" 
                                       class="cursor-pointer text-gray-800 hover:text-purple-600 transition-colors duration-200">
                                        ${post.author || '‡∂±‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠'}
                                    </a>
                                </h3>
                                ${feelingDisplayHTML}
                            </div>
                            <p class="text-xs sm:text-sm text-gray-500 mt-1">${timeAgo} ${post.edited ? '(Edited ‚úèÔ∏è)' : ''}</p>
                        </div>
                    </div>
                    ${isAuthor ? `
                        <div class="flex space-x-2 shrink-0 pt-1">
                            <button onclick="editPost('${post.id}', '${escapeText(post.content)}')" class="p-2 text-gray-400 hover:text-blue-500 transition-colors duration-200">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deletePost('${post.id}')" class="p-2 text-gray-400 hover:text-red-500 transition-colors duration-200">
                                üóëÔ∏è
                            </button>
                        </div>
                    ` : ''}
                </div>
                
                <p class="text-gray-700 text-base sm:text-lg mb-4 sm:mb-6 whitespace-pre-line">${unescapeText(post.content)}</p>

                <div class="flex items-center justify-between flex-wrap gap-2">
                    <div class="flex flex-wrap gap-2"> 
                        <button onclick="toggleSingleReaction('${post.id}', 'heart')" class="reaction-btn flex items-center space-x-1 px-2 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-red-100 hover:to-pink-100 text-gray-700 transition-all duration-300 hover:scale-110 text-xs sm:text-base ${myReaction === 'heart' ? 'bg-gradient-to-r from-pink-200 to-red-200 text-red-600 shadow-lg scale-105' : ''}">
                            <span class="text-lg sm:text-2xl">‚ù§Ô∏è</span>
                            <span class="reaction-count font-bold text-sm sm:text-lg">${heartCount}</span>
                        </button>
                        
                        <button onclick="toggleSingleReaction('${post.id}', 'like')" class="reaction-btn flex items-center space-x-1 px-2 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-red-50 hover:to-pink-50 text-gray-700 transition-all duration-300 hover:scale-110 text-xs sm:text-base ${myReaction === 'like' ? 'bg-gradient-to-r from-red-100 to-pink-100 text-pink-600 shadow-lg scale-105' : ''}">
                            <span class="text-lg sm:text-2xl">üëç</span> 
                            <span class="reaction-count font-bold text-sm sm:text-lg">${likeCount}</span>
                        </button>
                        
                        <button onclick="toggleSingleReaction('${post.id}', 'laugh')" class="reaction-btn flex items-center space-x-1 px-2 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-yellow-50 hover:to-orange-50 text-gray-700 transition-all duration-300 hover:scale-110 text-xs sm:text-base ${myReaction === 'laugh' ? 'bg-gradient-to-r from-yellow-100 to-orange-100 text-yellow-600 shadow-lg scale-105' : ''}">
                            <span class="text-lg sm:text-2xl">üòÇ</span> 
                            <span class="reaction-count font-bold text-sm sm:text-lg">${laughCount}</span>
                        </button>

                        <button onclick="toggleSingleReaction('${post.id}', 'sad')" class="reaction-btn flex items-center space-x-1 px-2 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 text-gray-700 transition-all duration-300 hover:scale-110 text-xs sm:text-base ${myReaction === 'sad' ? 'bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-600 shadow-lg scale-105' : ''}">
                            <span class="text-lg sm:text-2xl">üò¢</span>
                            <span class="reaction-count font-bold text-sm sm:text-lg">${sadCount}</span>
                        </button>

                        <button onclick="toggleSingleReaction('${post.id}', 'fire')" class="reaction-btn flex items-center space-x-1 px-2 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-orange-50 hover:to-red-50 text-gray-700 transition-all duration-300 hover:scale-110 text-xs sm:text-base ${myReaction === 'fire' ? 'bg-gradient-to-r from-orange-100 to-red-100 text-red-600 shadow-lg scale-105' : ''}">
                            <span class="text-lg sm:text-2xl">üî•</span> 
                            <span class="reaction-count font-bold text-sm sm:text-lg">${fireCount}</span>
                        </button>
                        
                        <button onclick="commentPost('${post.id}')" class="flex items-center space-x-1 px-2 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 text-gray-700 transition-all duration-300 hover:scale-110 text-xs sm:text-base">
                            <span class="text-lg sm:text-2xl">üí¨</span> 
                            <span class="font-bold text-sm sm:text-lg comment-count">${post.commentsCount || 0}</span>
                        </button>
                        <button onclick="downloadPost('${post.id}')" class="flex items-center space-x-1 px-2 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-green-50 hover:to-teal-50 text-gray-700 transition-all duration-300 hover:scale-110 hover:rotate-12 text-xs sm:text-base">
                            <span class="text-lg sm:text-2xl">‚¨áÔ∏è</span>
                        </button>
                    </div>
                </div>
            `;
            return div;
        }

        function renderPost(post) {
            const feed = document.getElementById("postsFeed");
            const postElement = createPostElement(post);
            feed.appendChild(postElement);
        }

        /* ============================================================
            üî• Modal Logic (NEW)
        ============================================================ */
        const postModalOverlay = document.getElementById('postModalOverlay');
        const postModalCard = document.getElementById('postCreationCard');
        const defaultFeeling = { emoji: 'üôÇ', text: 'Select Feeling (Optional)' };

        function openPostModal() {
            if (!currentUser) {
                notifyUser("PostKinaa", "‡∂∏‡∑î‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±."); // üî• Modified
                return;
            }
            
            // üî• FIX 3: Reset post content and feeling for new post
            document.getElementById("postContent").value = "";
            selectedFeeling = null; 
            selectFeeling(defaultFeeling); // Set to default optional text
            
            updatePostModalUserInfo(); // Ensure avatar/name is correct
            
            postModalOverlay.classList.remove('hidden');
            postModalOverlay.classList.add('flex');
            postModalCard.classList.remove('modal-enter');
            postModalCard.classList.add('modal-enter-active');

            // Set focus to textarea for quick typing
            setTimeout(() => {
                document.getElementById('postContent').focus();
            }, 50);
        }

        function closePostModal() {
            postModalCard.classList.remove('modal-enter-active');
            postModalCard.classList.add('modal-exit-active');

            setTimeout(() => {
                postModalOverlay.classList.remove('flex');
                postModalOverlay.classList.add('hidden');
                postModalCard.classList.remove('modal-exit-active');
                postModalCard.classList.add('modal-enter'); 
            }, 300);
        }

        /* ============================================================
            üî• Feeling Feature Logic (Updated)
        ============================================================ */
        const FEELINGS = [
            { emoji: 'üòä', text: 'Happy' },
            { emoji: 'ü§©', text: 'Excited' },
            { emoji: 'üò¥', text: 'Tired' },
            { emoji: 'ü§Ø', text: 'Mind Blown' },
            { emoji: 'ü§î', text: 'Thinking' },
            { emoji: 'üòé', text: 'Cool' },
            { emoji: 'ü•∞', text: 'Loved' },
            { emoji: 'üòÇ', text: 'Laughing' },
            { emoji: 'üò°', text: 'Angry' },
            { emoji: '‚ùå', text: 'Remove Feeling' } // Remove option added
        ];

        function initFeelingPanel() {
            const panel = document.getElementById('feelingPanel');
            const grid = panel.querySelector('.grid');
            grid.innerHTML = '';
            
            FEELINGS.forEach(f => {
                const button = document.createElement('button');
                button.className = 'p-2 rounded-lg hover:bg-purple-200 transition-colors duration-200 text-center';
                button.innerHTML = `<span class="text-2xl">${f.emoji}</span><p class="text-xs text-gray-700 mt-1">${f.text}</p>`;
                button.onclick = () => selectFeeling(f);
                grid.appendChild(button);
            });
            
            // Initial selection display
            selectFeeling(defaultFeeling);
        }

        function toggleFeelingPanel() {
            const panel = document.getElementById('feelingPanel');
            panel.classList.toggle('hidden');
        }

        function selectFeeling(feeling) {
            if (feeling.emoji === '‚ùå') {
                selectedFeeling = null;
                document.getElementById('currentFeelingEmoji').textContent = defaultFeeling.emoji;
                document.getElementById('currentFeelingText').textContent = defaultFeeling.text;
            } else if (feeling.emoji === defaultFeeling.emoji) {
                // Initial load
                document.getElementById('currentFeelingEmoji').textContent = defaultFeeling.emoji;
                document.getElementById('currentFeelingText').textContent = defaultFeeling.text;
                selectedFeeling = null;
            } else {
                selectedFeeling = feeling;
                document.getElementById('currentFeelingEmoji').textContent = feeling.emoji;
                document.getElementById('currentFeelingText').textContent = `Feeling ${feeling.text}`;
            }
            toggleFeelingPanel(); 
        }

        /* ============================================================
            üî• Create Post (Updated Logic for Feeling)
        ============================================================ */
        function createPost() {
            if (!currentUser) {
                notifyUser("PostKinaa", "‡∂∏‡∑î‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±."); // üî• Modified
                return;
            }

            const uid = currentUser.uid;
            const authorName = document.getElementById("authorName").value.trim();
            const content = document.getElementById("postContent").value.trim();

            if (!authorName || !content) {
                notifyUser("PostKinaa", "‡∂±‡∂∏ ‡∑É‡∑Ñ ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫ ‡∂¥‡∑î‡∂ª‡∑Ä‡∂±‡∑ä‡∂±."); // üî• Modified
                return;
            }
            
            // Get a random gradient for the post background (simplified for quick use)
            const gradients = ['from-red-500 to-pink-500', 'from-blue-500 to-cyan-500', 'from-green-500 to-teal-500', 'from-yellow-500 to-orange-500', 'from-purple-500 to-indigo-500'];
            const randomGradient = gradients[Math.floor(Math.random() * gradients.length)];

            const postData = {
                author: authorName,
                content: content,
                authorId: uid,
                timestamp: Date.now(),
                avatar: currentUserAvatar, // Use globally stored avatar
                gradient: randomGradient,
                edited: false,
                feeling: selectedFeeling // This will be null if no feeling is selected
            };

            postsRef.push(postData)
                .then(() => {
                    closePostModal(); // Close modal after successful post
                    document.getElementById("postContent").value = "";
                    selectedFeeling = null; 
                    selectFeeling(defaultFeeling);
                    notifyUser("PostKinaa", "Post ‡∂ë‡∂ö ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í! üéâ"); // üî• Modified
                })
                .catch(error => {
                    console.error("Error pushing post:", error);
                    notifyUser("PostKinaa Error", "Post ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‚ùå"); // üî• Modified
                });
        }

        /* ============================================================
            üî• Reaction Emojis
        ============================================================ */
        const REACTION_EMOJIS = {
            like: 'üëç',
            laugh: 'üòÇ',
            fire: 'üî•',
            heart: '‚ù§Ô∏è', // NEW
            sad: 'üò¢',    // NEW
        };

        /* ============================================================
            üî• Single Reaction System (WITH NOTIFICATION TRIGGER - UNCHANGED)
        ============================================================ */
        function toggleSingleReaction(postId, newReactionType) {
            // ... (Reaction Logic is unchanged)
            if (!currentUser) return;
            const uid = currentUser.uid;
            const postReactionsRef = postsRef.child(postId).child("reactions");
            const userReactionRef = postReactionsRef.child(uid);
            const countsRef = postsRef.child(postId).child("reactionCounts");

            userReactionRef.once("value").then(snap => {
                const currentReaction = snap.val();

                if (currentReaction === newReactionType) {
                    userReactionRef.remove();
                    countsRef.child(newReactionType).transaction(count => (count || 1) - 1);
                } else {
                    if (currentReaction) {
                        countsRef.child(currentReaction).transaction(count => (count || 1) - 1);
                    }

                    userReactionRef.set(newReactionType);
                    countsRef.child(newReactionType).transaction(count => (count || 0) + 1);

                    // Create Notification for Reaction
                    postsRef.child(postId).once('value', postSnap => {
                        const post = postSnap.val();
                        if (post && post.authorId !== uid) {
                            notificationsRef.child(post.authorId).push({
                                type: newReactionType, // üî• MODIFIED: Use the actual reaction type
                                postId: postId,
                                actorId: uid,
                                read: false,
                                timestamp: Date.now()
                            });
                        }
                    });
                }
            });
        }

        function deletePost(id) {
            // ... (Delete Post Logic is unchanged)
            if (!confirm("‡∂∏‡∑ô‡∂∏ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂∏‡∂ö‡∂±‡∑ä‡∂±‡∂Ø?")) return;
            postsRef.child(id).once("value").then(s => {
                if (s.val().authorId !== currentUser.uid) {
                    notifyUser("PostKinaa", "‡∂î‡∂∂‡∂ß ‡∂∏‡∑ô‡∂∫ ‡∂∏‡∑ê‡∂ö‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂±‡∑ê‡∑Ñ‡∑ê"); // üî• Modified
                    return;
                }
                postsRef.child(id).remove();
                notifyUser("PostKinaa", "‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂∏‡∂ö‡∂± ‡∂Ω‡∂Ø‡∑ì üóëÔ∏è"); // üî• Modified
            });
        }

        function editPost(id, oldContent) {
            // ... (Edit Post Logic is unchanged)
            const newText = prompt("‡∂±‡∑Ä ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:", unescapeText(oldContent));
            if (!newText) return;
            postsRef.child(id).update({
                content: newText,
                edited: true
            });
            notifyUser("PostKinaa", "‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í ‚úèÔ∏è"); // üî• Modified
        }

        function commentPost(id) {
            // ... (Comment Post Logic is unchanged)
            window.location.href = `comment.html?postId=${id}`;
        }

      // ... (existing code above)
function downloadPost(postId) {
    postsRef.child(postId).once("value").then(snap => {
        const post = snap.val();
        if (!post) return;

        const themeName = localStorage.getItem("appTheme") || "default";
        const theme = THEMES[themeName] || THEMES.default;

        const wrapper = document.createElement("div");
        wrapper.style.cssText = `
            /* Increase height to allow for longer content. Width can remain fixed. */
            width: 800px;
            /* Set to auto to accommodate long text, or a generous fixed height like 1000px if preferred */
            height: fit-content; 
            min-height: 760px; /* Ensure minimum size */
            position: fixed;
            top: -9999px;
            left: -9999px;
            font-family: system-ui, -apple-system, sans-serif;
        `;

        wrapper.innerHTML = `
            <div style="
                width: 100%;
                height: 100%; /* Use 100% since wrapper height is now dynamic/fit-content */
                background: ${theme.download};
                border-radius: 30px;
                padding: 50px;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
            ">
                <div style="
                    background: white;
                    border-radius: 25px;
                    padding: 45px;
                    height: 100%;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
                    display: flex;
                    flex-direction: column;
                    position: relative;
                ">
                    <div style="
                        display: flex;
                        align-items: center;
                        margin-bottom: 35px;
                        padding-bottom: 25px;
                        border-bottom: 3px solid #f3f4f6;
                    ">
                        <div style="
                            width: 70px;
                            height: 70px;
                            background: ${theme.download};
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 38px;
                            margin-right: 20px;
                            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
                        ">${post.avatar || '‚ùì'}</div>
                        
                        <div style="flex: 1;">
                            <h2 style="
                                font-size: 32px;
                                font-weight: 700;
                                color: #1f2937;
                                margin: 0 0 5px 0;
                                letter-spacing: -0.5px;
                            ">${post.author || '‡∂±‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠'}</h2>
                            <p style="
                                font-size: 16px;
                                color: #9ca3af;
                                margin: 0;
                                font-weight: 500;
                            ">PostKinaa Member</p>
                        </div>
                    </div>

                    <div style="
                        /* flex: 1, align-items: center, ‡∑É‡∑Ñ overflow: hidden ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑í */
                        margin-bottom: 30px;
                        flex-grow: 1; /* ‡∂â‡∂≠‡∑í‡∂ª‡∑í ‡∂â‡∂© ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß */
                    ">
                        <p style="
                            font-size: 26px;
                            line-height: 1.7;
                            color: #374151;
                            margin: 0;
                            white-space: pre-line; /* Pre-line wrapping ‡∂≠‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂Ω‡∂Ø‡∑í */
                            font-weight: 400;
                        ">${post.content || 'Content not found'}</p>
                    </div>

                    <div style="
                        padding-top: 25px;
                        border-top: 3px solid #f3f4f6;
                        display: flex;
                        justify-content: flex-end; 
                        align-items: center;
                    ">
                        <span style="
                            font-size: 18px;
                            color: #9ca3af;
                            font-weight: 600;
                        ">PostKinaa.com</span>
                    </div>

                    <div style="
                        position: absolute;
                        top: 0;
                        right: 0;
                        width: 120px;
                        height: 120px;
                        background: ${theme.download};
                        opacity: 0.08;
                        border-radius: 0 25px 0 100%;
                    "></div>
                </div>
            </div>
        `;

        document.body.appendChild(wrapper);

        // ... (rest of the function remains the same)
        html2canvas(wrapper, { 
            scale: 3,
            backgroundColor: null,
            logging: false
        }).then(canvas => {
            const link = document.createElement("a");
            link.download = `PostKinaa_${post.author}_${Date.now()}.png`;
            link.href = canvas.toDataURL("image/png", 1.0);
            link.click();
            wrapper.remove();
            notifyUser("PostKinaa", "‚¨áÔ∏è Download ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í!"); // üî• Modified
        }).catch(err => {
            console.error(err);
            wrapper.remove();
            notifyUser("PostKinaa Error", "Download error ‚ùå"); // üî• Modified
        });
    });
}
        /* ============================================================
            üî• Helpers (MODIFIED: Popup removed, new notification function added)
        ============================================================ */
        function getTimeAgo(ts) { 
            if (!ts) return "‡∂∏‡∑ô‡∂∏ ‡∂∏‡∑ú‡∑Ñ‡∑ú‡∂≠‡∑ö"; 
            const diff = Date.now() - ts; 
            const s = diff/1000; 
            if (s<60) return `${Math.floor(s)}s ‡∂¥‡∑ô‡∂ª`; 
            const m=s/60; 
            if (m<60) return `${Math.floor(m)}min ‡∂¥‡∑ô‡∂ª`; 
            const h=m/60; 
            if (h<24) return `${Math.floor(h)}h ‡∂¥‡∑ô‡∂ª`; 
            return `${Math.floor(h/24)}d ‡∂¥‡∑ô‡∂ª`; 
        } 

        // üî• REMOVED: showNotification function is removed as requested by the user.

        function notifyUser(title, body) {
            // This function replaces showNotification and uses displayBrowserNotification.
            displayBrowserNotification(title, body);
        }

        function escapeText(text) {
            if (!text) return '';
            return text.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        }
        
        function unescapeText(text) {
            if (!text) return '';
            return text.replace(/&#39;/g, "'").replace(/&quot;/g, '"');
        }

        /* ============================================================
            üî• Notification Panel Logic (MODIFIED for Browser Notifications only)
        ============================================================ */
        function requestNotificationPermission() {
            if (!("Notification" in window) || Notification.permission === "granted" || Notification.permission === "denied") {
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    console.log("Notifications permission granted."); // üî• Modified (No popup for permission success)
                } 
            });
        }

        function displayBrowserNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: 'https://via.placeholder.com/48'
                });
            } else if (Notification.permission === 'default') {
                requestNotificationPermission(); // Request permission if not yet asked
            }
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            
            if (Notification.permission === 'default') {
                requestNotificationPermission();
            }
            
            if (panel.classList.contains('translate-x-full')) {
                panel.classList.remove('translate-x-full');
                loadAndRenderNotifications(true); // Mark as read when opening
            } else {
                panel.classList.add('translate-x-full');
            }
        }

        function closeNotificationPanel() {
            document.getElementById('notificationPanel').classList.add('translate-x-full');
        }

        function setupNotificationListener() {
            if (!currentUser) return;
            
            const userNotificationsRef = notificationsRef.child(currentUser.uid);
            const unreadIndicator = document.getElementById('unreadIndicator');

            // üî• REMOVED: The code that checked unread count on 'value' is removed as requested.

            // NEW NOTIFICATION/BROWSER NOTIFICATION LOGIC (child_added)
            // This now handles both the browser notification and the red dot
            userNotificationsRef.limitToLast(1).on('child_added', snapshot => {
                const notif = snapshot.val();
                
                if (!notif.read && notif.actorId !== currentUser.uid) {
                    database.ref(`users/${notif.actorId}`).once('value', userSnap => {
                        const userData = userSnap.val();
                        const actorName = userData ? (userData.name || '‡∂ö‡∑Ä‡∑î‡∂ª‡∑î‡∂±‡∑ä ‡∑Ñ‡∑ù') : '‡∂ö‡∑Ä‡∑î‡∂ª‡∑î‡∂±‡∑ä ‡∑Ñ‡∑ù';
                        
                        let title = 'üéâ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏';
                        let message = '';
                        
                        // üî• MODIFIED: Handle new reaction types
                        if (notif.type === 'like') {
                            message = `${actorName} ‡∂î‡∂∂‡∑ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂ö‡∑ê‡∂∏‡∂≠‡∑í ‡∑Ä‡∑ì ‡∂á‡∂≠. üëç`;
                        } else if (notif.type === 'heart') {
                            message = `${actorName} ‡∂î‡∂∂‡∑ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂Ü‡∂Ø‡∂ª‡∂∫ ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∂á‡∂≠. ‚ù§Ô∏è`;
                        } else if (notif.type === 'sad') {
                            message = `${actorName} ‡∂î‡∂∂‡∑ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂Ø‡∑î‡∂ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å ‡∂ö‡∂ª ‡∂á‡∂≠. üò¢`;
                        } else if (notif.type === 'fire') {
                            message = `${actorName} ‡∂î‡∂∂‡∑ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß 'üî•' ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫ ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∂á‡∂≠. üî•`;
                        } else if (notif.type === 'laugh') {
                            message = `${actorName} ‡∂î‡∂∂‡∑ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∑É‡∑í‡∂±‡∑è ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫ ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∂á‡∂≠. üòÇ`;
                        } else if (notif.type === 'comment') {
                            const commentSnippet = notif.content ? (notif.content.length > 50 ? notif.content.substring(0, 50) + '...' : notif.content) : '‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä.';
                            message = `${actorName} ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ö‡∑Ö‡∑è: "${commentSnippet}" üí¨`;
                        } else if (notif.type === 'message') {
                            message = `${actorName} ‡∂î‡∂∂‡∂ß ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫‡∂ö‡∑ä ‡∂∫‡∑Ä‡∑è ‡∂á‡∂≠. üó®Ô∏è`;
                        }
                        
                        if (message) {
                             displayBrowserNotification(title, message); // Browser Notification
                             unreadIndicator.classList.remove('hidden'); // üî• NEW: Show red dot only when a new notification arrives
                        }
                    });
                }
            });
        }
        
        function setupUnreadChatListener() {
            if (!currentUser) return;
            
            const userNotificationsRef = notificationsRef.child(currentUser.uid);
            const unreadChatIndicator = document.getElementById('unreadChatIndicator');

            // üó®Ô∏è CHAT RED DOT LOGIC (This logic is kept as is to show unread messages count)
            userNotificationsRef.orderByChild('read').equalTo(false).on('value', snapshot => {
                let unreadMessageCount = 0;
                
                snapshot.forEach(s => {
                    const notif = s.val();
                    if (notif.type === 'message') {
                        unreadMessageCount++;
                    }
                });

                if (unreadMessageCount > 0) {
                    unreadChatIndicator.classList.remove('hidden');
                } else {
                    unreadChatIndicator.classList.add('hidden');
                }
            });
        }


        function loadAndRenderNotifications(markAsRead = false) {
            if (!currentUser) return;

            const list = document.getElementById('notificationList');
            
            list.innerHTML = `<p class='text-center text-gray-500 py-4'><span class='inline-block w-6 h-6 border-2 border-gray-200 border-t-gray-600 rounded-full spinner'></span> Loading...</p>`;

            const userNotificationsRef = notificationsRef.child(currentUser.uid);
            
            userNotificationsRef.orderByChild('timestamp').limitToLast(30).once('value', async (snapshot) => {
                list.innerHTML = '';
                
                if (!snapshot.exists()) {
                    list.innerHTML = "<p class='text-center text-gray-500 py-4'>‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏‡∑ä ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠. üòä</p>";
                    return;
                }

                const notifications = [];
                snapshot.forEach(s => {
                    notifications.push({ key: s.key, ...s.val() });
                });
                
                notifications.reverse(); 
                allNotifications = notifications; 
                
                let needsMarkingAsRead = false;
                
                const renderPromises = notifications.map(async (notif) => {
                    if (notif.actorId) {
                        const actorSnap = await database.ref(`users/${notif.actorId}`).once('value');
                        const actor = actorSnap.val();
                        notif.actorName = actor ? (actor.name || 'Unknown User') : 'Unknown User';
                    }
                    
                    if (!notif.read) {
                        needsMarkingAsRead = true;
                    }
                    
                    return renderNotificationItem(notif);
                });

                const notificationElements = await Promise.all(renderPromises);
                
                notificationElements.forEach(element => list.appendChild(element));

                if (markAsRead && needsMarkingAsRead) {
                    markAllNotificationsAsRead(notifications);
                }
            });
        }

        function renderNotificationItem(notif) {
            let icon = '';
            let message = '';
            
            const actorName = notif.actorName || '‡∂ö‡∑ô‡∂±‡∑ô‡∂ö‡∑ä'; 

            // üî• MODIFIED: Handle new reaction types in the notification panel
            if (notif.type === 'like') {
                icon = 'üëç';
                message = `**${actorName}** ‡∂î‡∂∂‡∑ö ‡∂¥‡∑Ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ö‡∂ß ‡∂ö‡∑ê‡∂∏‡∂≠‡∑í ‡∑Ä‡∑ì ‡∂á‡∂≠.`;
            } else if (notif.type === 'heart') {
                icon = '‚ù§Ô∏è';
                message = `**${actorName}** ‡∂î‡∂∂‡∑ö ‡∂¥‡∑Ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ö‡∂ß ‡∂Ü‡∂Ø‡∂ª‡∂∫ ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∂á‡∂≠.`;
            } else if (notif.type === 'sad') {
                icon = 'üò¢';
                message = `**${actorName}** ‡∂î‡∂∂‡∑ö ‡∂¥‡∑Ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ö‡∂ß ‡∂Ø‡∑î‡∂ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å ‡∂ö‡∂ª ‡∂á‡∂≠.`;
            } else if (notif.type === 'fire') {
                icon = 'üî•';
                message = `**${actorName}** ‡∂î‡∂∂‡∑ö ‡∂¥‡∑Ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ö‡∂ß 'üî•' ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫ ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∂á‡∂≠.`;
            } else if (notif.type === 'laugh') {
                icon = 'üòÇ';
                message = `**${actorName}** ‡∂î‡∂∂‡∑ö ‡∂¥‡∑Ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ö‡∂ß ‡∑É‡∑í‡∂±‡∑è ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫ ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∂á‡∂≠.`;
            } else if (notif.type === 'comment') {
                icon = 'üí¨';
                const commentSnippet = notif.content ? (notif.content.length > 50 ? notif.content.substring(0, 50) + '...' : notif.content) : '‡∂±‡∑Ä‡∂≠‡∂∏ ‡∂Ö‡∂Ø‡∑Ñ‡∑É.';
                message = `**${actorName}** ‡∂î‡∂∂‡∑ö ‡∂¥‡∑Ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ö‡∂ß ‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∂á‡∂≠: *${commentSnippet}*`;
            } else if (notif.type === 'message') {
                icon = 'üó®Ô∏è';
                message = `**${actorName}** ‡∂î‡∂∂‡∂ß ‡∂ö‡∑ô‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫‡∂ö‡∑ä ‡∂∫‡∑Ä‡∑è ‡∂á‡∂≠.`; 
            } else {
                icon = 'üì¢';
                message = '‡∂±‡∑Ä ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏‡∂ö‡∑ä';
            }

            const timeAgo = getTimeAgo(notif.timestamp);

            const element = document.createElement('div');
            element.className = `fade-in p-3 rounded-xl shadow-sm cursor-pointer transition-all duration-300 border-2 ${
                notif.read ? 'bg-gray-50 hover:bg-gray-100 border-gray-100' : 'bg-purple-50 hover:bg-purple-100 border-purple-200 font-semibold'
            }`;
            
            const formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>');
            
            element.innerHTML = `
                <div class="flex items-start space-x-3">
                    <span class="text-2xl pt-0.5 shrink-0">${icon}</span>
                    <div class="flex-1">
                        <p class="text-sm text-gray-800 font-medium leading-snug">${formattedMessage}</p>
                        <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                    </div>
                </div>
            `;
            
            element.onclick = () => {
                // Go to the post/chat and close the panel
                if (notif.type === 'message') {
                    window.location.href = `chat.html?uid=${notif.actorId}`;
                } else if (notif.postId) {
                    window.location.href = `comment.html?postId=${notif.postId}`;
                }
                closeNotificationPanel();
            };
            
            return element;
        }

        function markAllNotificationsAsRead(notifications) {
            if (!currentUser || !notifications.length) return;

            const updates = {};
            let unreadFound = false;
            
            notifications.forEach(notif => {
                if (!notif.key) return; 
                if (!notif.read) {
                    updates[`notifications/${currentUser.uid}/${notif.key}/read`] = true;
                    unreadFound = true;
                }
            });

            if (unreadFound) {
                database.ref().update(updates)
                    .then(() => {
                        const unreadIndicator = document.getElementById('unreadIndicator');
                        unreadIndicator.classList.add('hidden'); // üî• Hides the dot after reading
                    })
                    .catch(error => console.error("Error marking notifications as read:", error));
            }
        }

        /* ============================================================
            üî• Initialization
        ============================================================ */
        initFeelingPanel(); 
    </script>
</body>
</html>

