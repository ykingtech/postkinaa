<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostKinaa - Social Media Home</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* ============================================================
            üî• ANIMATIONS & STYLES (UNCHANGED)
        ============================================================ */
        @keyframes fadeIn { from { opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
        .fade-in { animation: fadeIn 0.5s ease-out; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }

        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .float { animation: float 3s ease-in-out infinite; }

        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); } 50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); } }
        .glow { animation: glow 2s ease-in-out infinite; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-100%); } to { opacity: 1; transform: translateX(0); } }
        .slide-in { animation: slideIn 0.6s ease-out; }

        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .post-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .post-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
        }

        .reaction-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .reaction-btn:hover {
            transform: scale(1.15);
        }

        .reaction-btn:active {
            transform: scale(0.95);
        }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .pulse-animation { animation: pulse 2s ease-in-out infinite; }

        .gradient-border {
            position: relative;
            border: 3px solid transparent;
            background-clip: padding-box;
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 3px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate { to { filter: hue-rotate(360deg); } }

        input:focus, textarea:focus {
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        .hover-lift {
            transition: all 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-3px);
        }
    </style>
</head>

<body class="min-h-screen">

    <header id="appHeader" class="glass-effect sticky top-0 z-50 shadow-2xl border-b-2 border-white/50">
        <div class="max-w-4xl mx-auto px-4 py-3 sm:py-5 flex items-center justify-between">
            
            <div class="flex items-center space-x-2 sm:space-x-4">
                <button onclick="goToSettings()" title="‡∑É‡∑ê‡∂ö‡∑É‡∑ì‡∂∏‡∑ä"
                    class="p-2 sm:p-3 text-xl sm:text-2xl text-gray-600 hover:text-purple-600 hover:bg-purple-100 rounded-xl sm:rounded-2xl transition-all duration-300 hover:rotate-90 hover:scale-110">
                    ‚öôÔ∏è
                </button>
                <h1 class="text-3xl sm:text-4xl font-black bg-clip-text text-transparent float pulse-animation" id="headerTitle">üåü PostKinaa</h1>
            </div>

            <div class="flex items-center space-x-2 sm:space-x-3">
                <button onclick="signOutUser()"  
                    class="px-3 py-1.5 sm:px-5 sm:py-2 bg-gradient-to-r from-red-400 to-pink-500 text-white rounded-full text-xs sm:text-sm font-bold hover:from-red-500 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105">
                    üö™ Logout
                </button>
                
                <div class="relative">
                    
                        </svg>
                        <span id="notificationCount" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
                    </button>
                    
                    <div id="notificationPanel" class="hidden absolute right-0 mt-3 w-80 sm:w-96 glass-effect rounded-2xl shadow-2xl border-2 border-white/50 p-4 fade-in max-h-[70vh] overflow-y-auto z-[100]">
                        <h3 class="font-bold text-xl text-gray-800 border-b pb-2 mb-3">üîî ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏‡∑ä</h3>
                        <div id="notificationsList" class="space-y-3">
                            <p class="text-center text-gray-500 py-4" id="loadingNotifications">Loading...</p>
                        </div>
                        <div id="noNotifications" class="text-center text-gray-500 py-4 hidden">
                            ‡∂≠‡∑Ä‡∂∏ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏‡∑ä ‡∂±‡∑ë.
                        </div>
                    </div>
                </div>
                <span id="connectionStatus" style="display:none;" 
                    class="hidden sm:inline-block px-3 py-1.5 bg-gradient-to-r from-green-400 to-emerald-500 text-white rounded-full text-xs font-bold shadow-lg glow">
                    ‚ú® Connected
                </span>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6">

        <div id="postCreationCard" class="glass-effect rounded-3xl shadow-2xl border-2 border-white/40 p-5 sm:p-8 mb-8 hover:shadow-[0_30px_70px_rgba(168,85,247,0.3)] transition-all duration-500 relative z-10">
            <div class="flex items-start space-x-3 sm:space-x-5">

                <div class="w-10 h-10 sm:w-14 sm:h-14 bg-gradient-to-br from-purple-500 via-pink-500 to-blue-500 rounded-xl sm:rounded-2xl flex items-center justify-center text-2xl sm:text-3xl shadow-2xl shrink-0 float">üòä</div>

                <div class="flex-1">
                    <input id="authorName" type="text" placeholder="‚ú® ‡∂î‡∂∂‡∑ö ‡∂±‡∂∏..." 
                        class="w-full px-4 py-2 sm:px-5 sm:py-3 mb-3 bg-white/60 backdrop-blur-sm rounded-xl sm:rounded-2xl border-2 border-purple-200 focus:border-purple-500 outline-none transition-all duration-300 font-semibold text-gray-800 hover:bg-white/80 shadow-sm text-sm sm:text-base">

                    <textarea id="newPostInput" placeholder="üí≠ ‡∂î‡∂∂‡∑ö ‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä ‡∂∏‡∑ô‡∂≠‡∂± ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±... ‡∂Ö‡∂Ø ‡∂∏‡∑ú‡∂ö‡∂Ø ‡∑É‡∑í‡∂≠‡∂±‡∑ä‡∂±‡∑ö?"
                        class="w-full px-4 py-3 sm:px-5 sm:py-4 bg-white/60 backdrop-blur-sm rounded-xl sm:rounded-2xl border-2 border-purple-200 focus:border-purple-500 outline-none resize-none transition-all duration-300 font-medium text-gray-700 hover:bg-white/80 shadow-sm text-sm sm:text-base"
                        rows="4"></textarea>
                    
                    <div class="mb-4 relative">
                        <span id="selectedFeelingDisplay" class="hidden px-3 py-1.5 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold shadow-inner transition-all duration-300 inline-flex items-center">
                            <span class="mr-1">Feeling:</span> <span id="currentFeelingEmoji"></span> <span id="currentFeelingText" class="ml-1"></span>
                            <button onclick="clearFeeling()" class="ml-2 text-red-500 hover:text-red-700 text-base leading-none">x</button>
                        </span>
                        
                        <div id="feelingSelector" class="hidden absolute top-full left-0 mt-2 p-4 w-full glass-effect rounded-xl shadow-2xl border border-white/50 fade-in z-20">
                            <h4 class="font-bold text-gray-700 mb-3 text-lg">‡∂Ö‡∂Ø ‡∂î‡∂∂‡∑ö ‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏ ‡∂ö‡∑î‡∂∏‡∂ö‡∑ä‡∂Ø?</h4>
                            
                            <div class="flex flex-nowrap overflow-x-auto pb-2 -mx-4 px-4 gap-2 mb-4" id="defaultFeelingsContainer">
                                </div>

                            <div class="flex items-center space-x-2">
                                <div class="relative flex-1">
                                    <input type="text" id="customFeelingInput" 
                                        oninput="updateRecommendedEmoji(this.value)"
                                        placeholder="‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏‡∂ö‡∑ä ‡∂ß‡∂∫‡∑í‡∂¥‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±... (‡∂ã‡∂Ø‡∑è: happy, ‡∂Ø‡∑î‡∂ö‡∑ô‡∂±‡∑ä)"
                                        class="w-full px-4 py-2 pr-12 bg-white/70 rounded-lg border border-purple-200 focus:border-purple-500 outline-none transition-all duration-300 text-gray-700 text-sm">
                                    <span id="recommendedEmojiDisplay" class="absolute right-3 top-1/2 -translate-y-1/2 text-2xl opacity-50 transition-opacity duration-200" title="Recommended Emoji">
                                        üí≠
                                    </span>
                                </div>
                                <button onclick="handleCustomFeeling()"
                                    class="p-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors duration-300 text-sm font-semibold">
                                    ‚úîÔ∏è Add
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-3 sm:mt-5">
                        <div class="flex space-x-1 sm:space-x-2">
                            <button onclick="openFeelingSelector()" title="‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"
                                class="p-2 sm:p-3 hover:bg-gradient-to-br hover:from-pink-100 hover:to-yellow-100 rounded-xl sm:rounded-2xl text-xl sm:text-2xl transition-all duration-300 hover:scale-110 hover:-rotate-6">üòÄ</button>
                        </div>

                        <button onclick="createPost()" id="postButton"
                            class="px-5 py-2.5 sm:px-8 sm:py-3.5 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 text-white rounded-full font-bold hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 shadow-2xl transition-all duration-300 flex items-center space-x-2 hover:scale-105 hover:shadow-[0_15px_40px_rgba(168,85,247,0.5)] text-sm sm:text-base">
                            <span>üöÄ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="postsFeed" style="display:none;"></div> 

        <div id="loadingIndicator" class="text-center py-12">
            <div class="inline-block w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full spinner"></div>
            <p class="mt-6 text-gray-700 font-bold text-lg">‚ú® ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä Loading ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</p>
            <p class="mt-2 text-gray-500">‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ª‡∑ê‡∂≥‡∑ì ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±</p>
        </div>

        <div id="noPostsMessage" class="text-center py-16 glass-effect rounded-3xl border-2 border-white/40 shadow-2xl" style="display:none;">
            <div class="text-8xl mb-6 float">üì≠</div>
            <p class="text-2xl text-gray-700 font-bold mb-3">‡∂≠‡∑Ä‡∂∏ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂±‡∑ë</p>
            <p class="text-gray-500 text-lg">‡∂¥‡∑Ö‡∂∏‡∑î ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂î‡∂∂ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!</p>
            <p class="text-6xl mt-8">‚ú®</p>
        </div>
    </div>

    <script>

    /* ============================================================
        üî• Firebase Config + Init
    ============================================================ */
    const firebaseConfig = {
        apiKey: "AIzaSyAzNJ-P8aAMvTuNWKcQYCjIIHiaL0BpdZ0",
        authDomain: "game-f1c21.firebaseapp.com",
        databaseURL: "https://game-f1c21-default-rtdb.firebaseio.com",
        projectId: "game-f1c21",
        storageBucket: "game-f1c21.firebasestorage.app",
        messagingSenderId: "656338565711",
        appId: "1:656338565711:web:395f9c7f846588b065883a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    const postsRef = database.ref("posts");
    const usersRef = database.ref("users"); 

    let currentUser = null;
    let selectedFeeling = null; 

    /* ============================================================
        üî• Theme System (UNCHANGED)
    ============================================================ */
    const THEMES = {
        default: {
            bg: 'bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50',
            header: 'from-purple-600 via-pink-600 to-blue-600',
            download: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            button: 'from-purple-600 via-pink-600 to-blue-600', // Main button color
            avatarGradient: 'from-purple-500 via-pink-500 to-blue-500', // Post creation avatar
            settingBack: 'text-purple-600 hover:bg-purple-100', // Back button in settings
            settingBackBG: '#9333ea', // Back button background color for comment.html consistency
        },
        blue: {
            bg: 'bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50',
            header: 'from-blue-600 via-indigo-600 to-purple-600',
            download: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            button: 'from-blue-600 via-indigo-600 to-purple-600',
            avatarGradient: 'from-blue-500 via-indigo-500 to-purple-500',
            settingBack: 'text-blue-600 hover:bg-blue-100',
            settingBackBG: '#3b82f6',
        },
        green: {
            bg: 'bg-gradient-to-br from-green-50 via-teal-50 to-cyan-50',
            header: 'from-green-600 via-teal-600 to-cyan-600',
            download: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            button: 'from-green-600 via-teal-600 to-cyan-600',
            avatarGradient: 'from-green-500 via-teal-500 to-cyan-500',
            settingBack: 'text-green-600 hover:bg-green-100',
            settingBackBG: '#10b981',
        },
        dark: {
            bg: 'bg-gray-800', 
            header: 'bg-white', 
            download: 'linear-gradient(135deg, #374151 0%, #1f2937 100%)',
            button: 'from-gray-600 via-gray-700 to-gray-800', 
            avatarGradient: 'from-gray-700 via-gray-600 to-gray-500',
            settingBack: 'text-gray-400 hover:bg-gray-700 hover:text-white',
            settingBackBG: '#4b5563',
        },
        red: {
            bg: 'bg-gradient-to-br from-red-50 via-pink-50 to-orange-50',
            header: 'from-red-600 via-pink-600 to-orange-600',
            download: 'linear-gradient(135deg, #f87171 0%, #f43f5e 100%)',
            button: 'from-red-600 via-pink-600 to-orange-600',
            avatarGradient: 'from-red-500 via-pink-500 to-orange-500',
            settingBack: 'text-red-600 hover:bg-red-100',
            settingBackBG: '#ef4444',
        },
        yellow: {
            bg: 'bg-gradient-to-br from-yellow-50 via-amber-50 to-orange-50',
            header: 'from-yellow-600 via-amber-600 to-orange-600',
            download: 'linear-gradient(135deg, #fcd34d 0%, #fb923c 100%)',
            button: 'from-yellow-600 via-amber-600 to-orange-600',
            avatarGradient: 'from-yellow-500 via-amber-500 to-orange-500',
            settingBack: 'text-yellow-600 hover:bg-yellow-100',
            settingBackBG: '#f59e0b',
        },
        teal: {
            bg: 'bg-gradient-to-br from-teal-50 via-cyan-50 to-blue-50',
            header: 'from-teal-600 via-cyan-600 to-blue-600',
            download: 'linear-gradient(135deg, #2dd4bf 0%, #06b6d4 100%)',
            button: 'from-teal-600 via-cyan-600 to-blue-600',
            avatarGradient: 'from-teal-500 via-cyan-500 to-blue-500',
            settingBack: 'text-teal-600 hover:bg-teal-100',
            settingBackBG: '#14b8a6',
        }
    };

    function applyTheme() {
        const themeName = localStorage.getItem("appTheme") || "default";
        const theme = THEMES[themeName] || THEMES.default;

        document.body.className = "min-h-screen " + theme.bg;
        const headerTitle = document.getElementById("headerTitle");
        const postButton = document.getElementById("postButton");
        const postAvatar = document.querySelector("#postCreationCard > div > div:nth-child(1)"); // The avatar div

        // Update Header Title
        if (themeName === 'dark') {
            headerTitle.className =
                "text-3xl sm:text-4xl font-black bg-clip-text text-white float pulse-animation";
        } else {
            // Remove existing gradient classes and apply new ones
            headerTitle.className = headerTitle.className.replace(/from-.*?to-.*?/g, ''); 
            headerTitle.className =
                "text-3xl sm:text-4xl font-black bg-clip-text text-transparent float pulse-animation bg-gradient-to-r " + theme.header;
        }

        // Update Post Button (Primary action button)
        // Remove existing gradient classes and apply new ones
        postButton.classList.remove('from-purple-600', 'via-pink-600', 'to-blue-600', 'from-purple-700', 'via-pink-700', 'to-blue-700');
        postButton.classList.add(...theme.button.split(' '), ...theme.button.replace(/600/g, '700').split(' ').map(cls => cls.replace('from-', 'hover:from-').replace('via-', 'hover:via-').replace('to-', 'hover:to-')));

        // Update Post Avatar Gradient
        // Remove existing gradient classes and apply new ones
        postAvatar.classList.remove('from-purple-500', 'via-pink-500', 'to-blue-500');
        postAvatar.classList.add('bg-gradient-to-br', ...theme.avatarGradient.split(' '));
    }

    /* ============================================================
        üî• NEW: Real-time Connection Status (UPDATED NOTIFICATION - POPUPS REMOVED)
    ============================================================ */
    const statusEl = document.getElementById("connectionStatus");

    // Firebase Server Connection State Monitoring
    database.ref('.info/connected').on('value', (snap) => {
        const isConnected = snap.val();
        
        if (isConnected === false) {
            statusEl.textContent = 'üî¥ Offline';
            // R-G-B: Replace green/emerald with red for offline status
            statusEl.className = statusEl.className.replace(/green|emerald|blue/g, 'red').replace(/glow/, 'pulse-animation');
            // Notification removed
        } else {
            // üî• NEW: Check if we were previously offline before showing connected notification
            // const wasOffline = statusEl.textContent.includes('Offline'); // Variable kept but not used for notification
            
            statusEl.textContent = '‚ú® Connected';
            // R-G-B: Restore green/emerald/blue classes for connected status
            statusEl.className = statusEl.className.replace(/red/g, 'green').replace(/pulse-animation/, 'glow');

            // Notification removed
        }
    });

    /* ============================================================
        üî• Auth Check and User Data Setup
    ============================================================ */
    auth.onAuthStateChanged(user => {
        if (!user) {
            statusEl.style.display = "none";
            window.location.href = "index.html";
            return;
        }
        
        statusEl.style.display = "inline-block";
        
        currentUser = user;
        
        // FIX 1: Check and Set Initial User Data (Profile Fix)
        usersRef.child(user.uid).once('value', snap => {
            const userData = snap.val();
            const defaultName = user.email ? user.email.split("@")[0] : '‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è';
            
            if (!userData) {
                // ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠‡∑í‡∂±‡∂∏‡∑ä ‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏.
                usersRef.child(user.uid).set({
                    name: defaultName,
                    avatar: 'üë§',
                    followerCount: 0,
                    followingCount: 0,
                }).then(() => {
                    document.getElementById('authorName').value = defaultName;
                });
            } else {
                // ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂≠‡∑í‡∂∂‡∑ö ‡∂±‡∂∏‡∑ä ‡∂±‡∂∏ Load ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
                document.getElementById('authorName').value = userData.name || defaultName;
                
                // Also update the name in case the profile page changed it
                if (!userData.name) {
                    usersRef.child(user.uid).update({ name: defaultName });
                }
            }
        });

        applyTheme();
        loadPosts();
        setupNotificationListener(currentUser.uid); // Setup listener here
    });

    function signOutUser() {
        auth.signOut().then(() => {
            showNotification("Logout successful.");
            window.location.href = "index.html";
        });
    }

    /* ============================================================
        üî• Settings & Profile Navigation
    ============================================================ */
    function goToSettings() {
        window.location.href = "settings.html";
    }

    function goToProfile(uid) {
        window.location.href = `profile.html?uid=${uid}`; 
    }

    /* ============================================================
        üî• Load Posts (UNCHANGED)
    ============================================================ */
    function loadPosts() {
        const feed = document.getElementById("postsFeed");
        const loading = document.getElementById("loadingIndicator");
        const noPosts = document.getElementById("noPostsMessage");

        feed.innerHTML = "";
        loading.style.display = "block";
        feed.style.display = "none";
        noPosts.style.display = "none";

        postsRef.orderByChild("timestamp").once("value").then(snap => { 
            loading.style.display = "none";
            
            if (!snap.exists()) {
                feed.style.display = "none";
                noPosts.style.display = "block";
                return;
            }

            const posts = [];
            snap.forEach(s => {
                posts.push({ id: s.key, ...s.val() });
            });
            
            posts.reverse(); 

            feed.innerHTML = "";
            posts.forEach(p => renderPost(p));
            
            feed.style.display = "block";
        }).catch(err => {
            console.error("Error loading posts:", err);
            loading.style.display = "none";
            showNotification("‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂Ω‡∑ù‡∂©‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‚ùå");
        });

        postsRef.on("child_added", (snapshot) => {
            if (feed.innerHTML === "") return;
            
            const newPost = { id: snapshot.key, ...snapshot.val() };
            const existingPost = document.getElementById(`post-${newPost.id}`);
            
            if (!existingPost) {
                feed.insertBefore(createPostElement(newPost), feed.firstChild);
                showNotification("‡∂±‡∑Ä ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∑Ä‡∑î‡∂±‡∑è! üéâ");
            }
        });

        postsRef.on("child_changed", (snapshot) => {
            const updatedPost = { id: snapshot.key, ...snapshot.val() };
            const postElement = document.getElementById(`post-${updatedPost.id}`);
            
            if (postElement) {
                const newElement = createPostElement(updatedPost);
                postElement.replaceWith(newElement);
            }
        });

        postsRef.on("child_removed", (snapshot) => {
            const postElement = document.getElementById(`post-${snapshot.key}`);
            if (postElement) {
                postElement.remove();
            }
            
            if (feed.children.length === 0) {
                feed.style.display = "none";
                noPosts.style.display = "block";
            }
        });
    }

    /* ============================================================
        üî• Create Post Element (WITH PROFILE LINK)
    ============================================================ */
    function createPostElement(post) {
        const timeAgo = getTimeAgo(post.timestamp);
        const me = currentUser ? currentUser.uid : null;
        const isAuthor = post.authorId === me;

        const myReaction = post.reactions && post.reactions[me] ? post.reactions[me] : null;
        const postFeeling = post.feeling; 

        const likeCount = post.reactionCounts?.like || 0;
        const laughCount = post.reactionCounts?.laugh || 0;
        const fireCount = post.reactionCounts?.fire || 0;

        const div = document.createElement("div");
        div.id = `post-${post.id}`;
        div.className =
            "post-card glass-effect rounded-3xl shadow-2xl border-2 border-white/40 p-5 sm:p-7 hover:shadow-[0_30px_70px_rgba(168,85,247,0.3)] transition-all duration-500 fade-in mb-8";
        
        div.style.position = 'relative'; 

        const feelingDisplayHTML = postFeeling ? 
            `<span class="ml-2 px-2 py-0.5 bg-gradient-to-r from-yellow-50 to-pink-50 text-gray-700 rounded-full text-xs font-bold shadow-sm inline-flex items-center mt-1 sm:mt-0">
                <span class="mr-1 text-base">${postFeeling.emoji}</span> is feeling ${postFeeling.text}
            </span>`
            : '';

        div.innerHTML = `
            <div class="flex items-start justify-between mb-4 sm:mb-5 flex-wrap">
                <div class="flex items-center space-x-3 sm:space-x-4">
                    <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-br ${post.gradient} rounded-xl sm:rounded-2xl flex items-center justify-center text-2xl sm:text-3xl shadow-xl hover:scale-110 transition-transform duration-300 shrink-0">
                        ${post.avatar || '‚ùì'}
                    </div>
                    <div>
                        <div class="flex items-start flex-wrap">
                            <h3 class="font-bold text-gray-800 text-lg sm:text-xl">
                                <a onclick="goToProfile('${post.authorId}')" 
                                   class="cursor-pointer text-gray-800 hover:text-purple-600 transition-colors duration-200">
                                    ${post.author || '‡∂±‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠'}
                                </a>
                            </h3>
                            ${feelingDisplayHTML} 
                        </div>
                        <p class="text-xs sm:text-sm text-gray-500 font-semibold">‚è∞ ${timeAgo}</p>
                    </div>
                </div>

                ${
                    isAuthor
                        ? `
                    <div class="flex space-x-1 mt-3 sm:mt-0 ml-auto sm:ml-0">
                        <button onclick="editPost('${post.id}', '${escapeText(post.content)}')"
                            class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-xl text-lg sm:text-xl transition-all duration-300 hover:scale-110 hover:rotate-12" title="‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="deletePost('${post.id}')"
                            class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-xl text-lg sm:text-xl transition-all duration-300 hover:scale-110 hover:-rotate-12" title="‡∂∏‡∂ö‡∂±‡∑ä‡∂±">
                            üóëÔ∏è
                        </button>
                    </div>`
                        : ""
                }
            </div>

            <p class="text-gray-800 mb-5 sm:mb-6 leading-relaxed text-base sm:text-lg whitespace-pre-line font-medium bg-gradient-to-r from-gray-700 to-gray-900 bg-clip-text">${post.content || 'Content not found'}</p>

            <div class="flex items-center justify-between pt-4 sm:pt-5 border-t-2 border-gray-100 flex-wrap space-y-2 sm:space-y-0 -mx-1 sm:-mx-2">
                <button onclick="toggleSingleReaction('${post.id}', 'like')"
                    class="reaction-btn flex items-center space-x-1 sm:space-x-2 px-3 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-pink-50 hover:to-red-50 text-gray-700 transition-all duration-300 hover:scale-110 text-sm sm:text-base
                    ${myReaction === 'like' ? 'bg-gradient-to-r from-pink-100 to-red-100 text-pink-600 shadow-lg scale-105' : ''}">
                    <span class="text-xl sm:text-2xl">‚ù§Ô∏è</span>
                    <span class="reaction-count font-bold text-base sm:text-lg">${likeCount}</span>
                </button>

                <button onclick="toggleSingleReaction('${post.id}', 'laugh')"
                    class="reaction-btn flex items-center space-x-1 sm:space-x-2 px-3 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-yellow-50 hover:to-orange-50 text-gray-700 transition-all duration-300 hover:scale-110 text-sm sm:text-base
                    ${myReaction === 'laugh' ? 'bg-gradient-to-r from-yellow-100 to-orange-100 text-yellow-600 shadow-lg scale-105' : ''}">
                    <span class="text-xl sm:text-2xl">üòÇ</span>
                    <span class="reaction-count font-bold text-base sm:text-lg">${laughCount}</span>
                </button>

                <button onclick="toggleSingleReaction('${post.id}', 'fire')"
                    class="reaction-btn flex items-center space-x-1 sm:space-x-2 px-3 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-orange-50 hover:to-red-50 text-gray-700 transition-all duration-300 hover:scale-110 text-sm sm:text-base
                    ${myReaction === 'fire' ? 'bg-gradient-to-r from-orange-100 to-red-100 text-red-600 shadow-lg scale-105' : ''}">
                    <span class="text-xl sm:text-2xl">üî•</span>
                    <span class="reaction-count font-bold text-base sm:text-lg">${fireCount}</span>
                </button>

                <button onclick="commentPost('${post.id}')"
                    class="flex items-center space-x-1 sm:space-x-2 px-3 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 text-gray-700 transition-all duration-300 hover:scale-110 text-sm sm:text-base">
                    <span class="text-xl sm:text-2xl">üí¨</span>
                    <span class="font-bold text-base sm:text-lg">${post.commentsCount || 0}</span>
                </button>

                <button onclick="downloadPost('${post.id}')"
                    class="flex items-center space-x-1 sm:space-x-2 px-3 py-1.5 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl hover:bg-gradient-to-r hover:from-green-50 hover:to-teal-50 text-gray-700 transition-all duration-300 hover:scale-110 hover:rotate-12 text-sm sm:text-base">
                    <span class="text-xl sm:text-2xl">‚¨áÔ∏è</span>
                </button>
            </div>
        `;

        return div;
    }

    /* ============================================================
        üî• Render Single Post (UNCHANGED)
    ============================================================ */
    function renderPost(post) {
        const feed = document.getElementById("postsFeed");
        const postElement = createPostElement(post);
        feed.appendChild(postElement);
    }

    /* ============================================================
        üî• NEW: Feeling Feature Logic (UPDATED FOR BLUR CONTROL)
    ============================================================ */
    const FEELINGS_MAP = [
        { text: "‡∑É‡∂≠‡∑î‡∂ß‡∑í‡∂±‡∑ä", emoji: "üòä" },
        { text: "‡∂Ü‡∂Ø‡∂ª‡∂∫‡∑ô‡∂±‡∑ä", emoji: "ü•∞" },
        { text: "‡∂ö‡∂∏‡∑ä‡∂∏‡∑ê‡∂Ω‡∑í", emoji: "üò™" },
        { text: "‡∑É‡∂±‡∑ä‡∑É‡∑î‡∂±‡∑ä", emoji: "üßò" },
        { text: "‡∂ö‡∑ù‡∂¥‡∂∫‡∑ô‡∂±‡∑ä", emoji: "üò°" },
        { text: "‡∂ã‡∂Ø‡∑ä‡∂∫‡∑ù‡∂ú‡∂∫‡∑ô‡∂±‡∑ä", emoji: "ü§©" },
        { text: "‡∂Ø‡∑î‡∂ö‡∑ô‡∂±‡∑ä", emoji: "üò¢" },
        { text: "‡∂∂‡∂Ω‡∑è‡∂¥‡∑ú‡∂ª‡∑ú‡∂≠‡∑ä‡∂≠‡∑î ‡∑É‡∑Ñ‡∂ú‡∂≠‡∂∫‡∑í", emoji: "üôè" },
    ];

    function renderFeelingButtons() {
        const container = document.getElementById('defaultFeelingsContainer');
        container.innerHTML = '';
        
        FEELINGS_MAP.forEach(f => {
            const button = document.createElement('button');
            button.className = 'px-4 py-2 bg-white/80 rounded-full shadow-md text-sm font-medium hover:bg-purple-100 transition-colors duration-200 flex items-center space-x-1 shrink-0';
            button.innerHTML = `<span>${f.emoji}</span> <span class="ml-1">${f.text}</span>`;
            button.onclick = () => selectFeeling(f.text, f.emoji);
            container.appendChild(button);
        });
    }

    function openFeelingSelector() {
        const selector = document.getElementById('feelingSelector');
        
        if (selector.classList.contains('hidden')) {
            selector.classList.remove('hidden');
            if (selector.querySelector('#defaultFeelingsContainer').children.length === 0) {
                renderFeelingButtons();
            }
            
            // üî• NEW: Call applyBlur when the selector opens
            applyBlur(); 
            
            // Add a click listener to the entire document body for outside click
            document.body.addEventListener('click', closeFeelingSelectorOutside, true);
        }
    }

    // Close the selector when clicking outside
    function closeFeelingSelectorOutside(event) {
        const selector = document.getElementById('feelingSelector');
        const feelingButton = document.querySelector('[onclick="openFeelingSelector()"]');

        // Check if the click occurred outside the selector AND outside the button that opens it
        if (!selector.contains(event.target) && !feelingButton.contains(event.target)) {
            closeFeelingSelector();
        }
    }

    // Centralized function to close the selector
    function closeFeelingSelector() {
        const selector = document.getElementById('feelingSelector');
        selector.classList.add('hidden');
        
        // üî• NEW: Call removeBlur when the selector closes
        removeBlur(); 
        
        // Remove the listener after closing
        document.body.removeEventListener('click', closeFeelingSelectorOutside, true);
    }


    function selectFeeling(text, emoji) {
        selectedFeeling = { text: text, emoji: emoji };
        
        document.getElementById('currentFeelingEmoji').textContent = emoji;
        document.getElementById('currentFeelingText').textContent = text;
        document.getElementById('selectedFeelingDisplay').classList.remove('hidden');
        
        closeFeelingSelector(); // This calls removeBlur
        
        showNotification(`Feeling added: ${emoji} ${text} üéâ`);
    }

    function clearFeeling() {
        selectedFeeling = null;
        document.getElementById('selectedFeelingDisplay').classList.add('hidden');
        document.getElementById('customFeelingInput').value = '';
        document.getElementById('recommendedEmojiDisplay').textContent = "üí≠";
        closeFeelingSelector(); // This calls removeBlur
        showNotification("Feeling removed.");
    }
    
    function recommendEmoji(text) {
        if (!text) return "üí≠";
        
        const lowerText = text.toLowerCase();

        if (lowerText.includes("love") || lowerText.includes("‡∂Ü‡∂Ø‡∂ª") || lowerText.includes("‡∂¥‡∑ä‚Äç‡∂ª‡∑ö‡∂∏")) return "üíñ";
        if (lowerText.includes("tired") || lowerText.includes("‡∂∏‡∑Ñ‡∂±‡∑ä‡∑É‡∑í") || lowerText.includes("‡∂±‡∑í‡∂Ø‡∑í")) return "üò¥";
        if (lowerText.includes("happy") || lowerText.includes("‡∑É‡∂≠‡∑î‡∂ß") || lowerText.includes("joy")) return "ü•≥";
        if (lowerText.includes("angry") || lowerText.includes("‡∂ö‡∑ö‡∂±‡∑ä‡∂≠‡∑í‡∂∫") || lowerText.includes("heat")) return "üî•";
        if (lowerText.includes("sad") || lowerText.includes("‡∂Ø‡∑î‡∂ö") || lowerText.includes("‡∂Ö‡∂©‡∑î")) return "üò≠";
        if (lowerText.includes("hungry") || lowerText.includes("‡∂∂‡∂©‡∂ú‡∑í‡∂±‡∑í")) return "üçî";
        if (lowerText.includes("excited") || lowerText.includes("‡∂ã‡∂Ø‡∑ä‡∂∫‡∑ù‡∂ú") || lowerText.includes("‡∑Ä‡∑í‡∂±‡∑ù‡∂Ø")) return "üéâ";

        if (lowerText.includes("‡∑É‡∂≠‡∑î‡∂ß") || lowerText.includes("happy")) return "üòä";
        if (lowerText.includes("‡∂ö‡∂∏‡∑ä‡∂∏‡∑ê‡∂Ω‡∑í") || lowerText.includes("boring")) return "üò™";
        if (lowerText.includes("‡∑É‡∂±‡∑ä‡∑É‡∑î‡∂±‡∑ä") || lowerText.includes("calm")) return "üßò";
        if (lowerText.includes("‡∂ö‡∑ù‡∂¥") || lowerText.includes("angry")) return "üò°";
        
        return "üí≠";
    }

    function updateRecommendedEmoji(text) {
        const display = document.getElementById('recommendedEmojiDisplay');
        if (display) {
            display.textContent = recommendEmoji(text);
        }
    }

    function handleCustomFeeling() {
        const input = document.getElementById('customFeelingInput');
        const display = document.getElementById('recommendedEmojiDisplay');
        
        const customText = input.value.trim();
        const finalEmoji = display.textContent.trim() || "üí≠";

        if (!customText) return;

        selectFeeling(customText, finalEmoji);
        input.value = '';
        display.textContent = "üí≠";
    }
    
    /* ============================================================
        üî• Create Post (FIXED BUG)
    ============================================================ */
    function createPost() {
        // üî• FIX: Robust name fetching to prevent error if currentUser.displayName is null
        const inputName = document.getElementById("authorName").value.trim();
        const defaultName = currentUser.email ? currentUser.email.split("@")[0] : '‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è';
        const name = inputName || defaultName;

        const content = document.getElementById("newPostInput").value.trim();

        if (!content && !selectedFeeling) return showNotification("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±, ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!");

        const btn = document.getElementById("postButton");
        btn.disabled = true;
        btn.innerHTML = `<span class="inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full spinner"></span>`;

        const avatars = ["üòä","üé®","‚ú®","üåü","üé≠","üéÆ","üòé","ü§©"];
        const gradients = [
            "from-purple-400 to-pink-400",
            "from-blue-400 to-purple-400",
            "from-pink-400 to-orange-400",
            "from-green-400 to-teal-400",
            "from-indigo-400 to-blue-400"
        ];

        const newPost = {
            author: name,
            content: content,
            authorId: currentUser.uid,
            avatar: avatars[Math.floor(Math.random()*avatars.length)],
            gradient: gradients[Math.floor(Math.random()*gradients.length)],
            feeling: selectedFeeling || null, 
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            reactionCounts: {
                like: 0, 
                laugh: 0,
                fire: 0
            },
            commentsCount: 0,
        };

        postsRef.push(newPost)
        .then(() => {
            document.getElementById("newPostInput").value = "";
            clearFeeling(); 
            btn.disabled = false;
            btn.innerHTML = `<span>üöÄ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</span>`;
            showNotification("‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂¥‡∑Ö ‡∂ö‡∑Ö‡∑è! üéâ");
            // Remove focus and blur effect
            document.getElementById("newPostInput").blur(); 
            document.getElementById("authorName").blur(); 
            usersRef.child(currentUser.uid).update({ name: name }); 
        })
        .catch(error => {
            console.error("Post Creation Error:", error);
            btn.disabled = false;
            btn.innerHTML = `<span>üöÄ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</span>`;
            showNotification("‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‚ùå");
        });
    }

    /* ============================================================
        üî• Single Reaction System (UNCHANGED)
    ============================================================ */
    function toggleSingleReaction(postId, newReactionType) {
        if (!currentUser) return;

        const uid = currentUser.uid;
        const postReactionsRef = postsRef.child(postId).child("reactions");
        const userReactionRef = postReactionsRef.child(uid);
        const countsRef = postsRef.child(postId).child("reactionCounts");

        userReactionRef.once("value").then(snap => {
            const currentReaction = snap.val();

            if (currentReaction === newReactionType) {
                userReactionRef.remove();
                countsRef.child(newReactionType).transaction(count => (count || 1) - 1);
            } else {
                if (currentReaction) {
                    countsRef.child(currentReaction).transaction(count => (count || 1) - 1);
                }

                userReactionRef.set(newReactionType);

                countsRef.child(newReactionType).transaction(count => (count || 0) + 1);
            }
        });
    }

    function deletePost(id) {
        if (!confirm("‡∂∏‡∑ô‡∂∏ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂∏‡∂ö‡∂±‡∑ä‡∂±‡∂Ø?")) return;

        postsRef.child(id).once("value").then(s => {
            if (s.val().authorId !== currentUser.uid) {
                showNotification("‡∂î‡∂∂‡∂ß ‡∂∏‡∑ô‡∂ö ‡∂∏‡∑ê‡∂ö‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂±‡∑ê‡∑Ñ‡∑ê");
                return;
            }
            postsRef.child(id).remove();
            showNotification("‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂∏‡∂ö‡∂± ‡∂Ω‡∂Ø‡∑ì üóëÔ∏è");
        });
    }

    function editPost(id, oldContent) {
        const newText = prompt("‡∂±‡∑Ä ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:", unescapeText(oldContent));
        if (!newText) return;

        postsRef.child(id).update({
            content: newText,
            edited: true
        });
        showNotification("‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í ‚úèÔ∏è");
    }

    function commentPost(id) {
        window.location.href = `comment.html?postId=${id}`;
    }

    /* ============================================================
        üî• Download Post (UNCHANGED)
    ============================================================ */
    function downloadPost(postId) {
        postsRef.child(postId).once("value").then(snap => {
            const post = snap.val();
            if (!post) return;

            const themeName = localStorage.getItem("appTheme") || "default";
            const theme = THEMES[themeName] || THEMES.default;

            const wrapper = document.createElement("div");
            wrapper.style.cssText = `
                width: 800px;
                height: 760px;
                position: fixed;
                top: -9999px;
                left: -9999px;
                font-family: system-ui, -apple-system, sans-serif;
            `;

            wrapper.innerHTML = `
                <div style="
                    width: 100%;
                    height: 100%;
                    background: ${theme.download};
                    border-radius: 30px;
                    padding: 50px;
                    box-sizing: border-box;
                    display: flex;
                    flex-direction: column;
                ">
                    <div style="
                        background: white;
                        border-radius: 25px;
                        padding: 45px;
                        height: 100%;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
                        display: flex;
                        flex-direction: column;
                        position: relative;
                    ">
                        <div style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 35px;
                            padding-bottom: 25px;
                            border-bottom: 3px solid #f3f4f6;
                        ">
                            <div style="
                                width: 70px;
                                height: 70px;
                                background: ${theme.download};
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 38px;
                                margin-right: 20px;
                                box-shadow: 0 8px 20px rgba(0,0,0,0.12);
                            ">${post.avatar || '‚ùì'}</div>
                            
                            <div style="flex: 1;">
                                <h2 style="
                                    font-size: 32px;
                                    font-weight: 700;
                                    color: #1f2937;
                                    margin: 0 0 5px 0;
                                    letter-spacing: -0.5px;
                                ">${post.author || '‡∂±‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠'}</h2>
                                <p style="
                                    font-size: 16px;
                                    color: #9ca3af;
                                    margin: 0;
                                    font-weight: 500;
                                ">PostKinaa Member</p>
                            </div>
                        </div>

                        <div style="
                            flex: 1;
                            display: flex;
                            align-items: center;
                            overflow: hidden;
                            margin-bottom: 30px;
                        ">
                            <p style="
                                font-size: 26px;
                                line-height: 1.7;
                                color: #374151;
                                margin: 0;
                                white-space: pre-line;
                                font-weight: 400;
                            ">${post.content || 'Content not found'}</p>
                        </div>

                        <div style="
                            padding-top: 25px;
                            border-top: 3px solid #f3f4f6;
                            display: flex;
                            justify-content: flex-end; 
                            align-items: center;
                        ">
                            <span style="
                                font-size: 18px;
                                color: #9ca3af;
                                font-weight: 600;
                            ">PostKinaa.com</span>
                        </div>

                        <div style="
                            position: absolute;
                            top: 0;
                            right: 0;
                            width: 120px;
                            height: 120px;
                            background: ${theme.download};
                            opacity: 0.08;
                            border-radius: 0 25px 0 100%;
                        "></div>
                    </div>
                </div>
            `;

            document.body.appendChild(wrapper);

            html2canvas(wrapper, { 
                scale: 3,
                backgroundColor: null,
                logging: false
            }).then(canvas => {
                const link = document.createElement("a");
                link.download = `PostKinaa_${post.author}_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png", 1.0);
                link.click();
                wrapper.remove();
                showNotification("‚¨áÔ∏è Download ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í!");
            }).catch(err => {
                console.error(err);
                wrapper.remove();
                showNotification("Download error ‚ùå");
            });
        });
    }

    /* ============================================================
        üî• Helpers (UNCHANGED)
    ============================================================ */
    function getTimeAgo(ts) {
        if (!ts) return "‡∂∏‡∑ô‡∂∏ ‡∂∏‡∑ú‡∑Ñ‡∑ú‡∂≠‡∑ö";
        const diff = Date.now() - ts;
        const s = diff/1000;
        if (s<60) return `${Math.floor(s)}s ‡∂¥‡∑ô‡∂ª`;
        const m=s/60;
        if (m<60) return `${Math.floor(m)}min ‡∂¥‡∑ô‡∂ª`;
        const h=m/60;
        if (h<24) return `${Math.floor(h)}h ‡∂¥‡∑ô‡∂ª`;
        return `${Math.floor(h/24)}d ‡∂¥‡∑ô‡∂ª`;
    }

    function showNotification(text) {
        const box = document.createElement("div");
        box.className = "fixed top-5 left-1/2 -translate-x-1/2 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 text-white px-6 py-3 rounded-full shadow-2xl text-sm z-50 fade-in font-bold";
        box.textContent = text;
        document.body.appendChild(box);
        setTimeout(() => {
            box.style.opacity = "0";
            box.style.transform = "translateX(-50%) translateY(-20px)";
            setTimeout(()=>box.remove(),300);
        },2500);
    }

    function escapeText(text) {
        return text.replace(/'/g, '&#39;').replace(/"/g, '&#34;');
    }
    
    function unescapeText(text) {
        return text.replace(/&#39;/g, "'").replace(/&#34;/g, '"');
    }

    /* ============================================================
        üî• NEW: UI/UX Focus Logic (Input Blur/Focus) - UPDATED BLUR
    ============================================================ */
    let newPostInput, postsFeed, header, authorNameInput, postCreationCard;

    const applyBlur = () => {
        // Check if either input is focused OR if the feeling selector is open
        const isFeelingSelectorOpen = !document.getElementById('feelingSelector').classList.contains('hidden');
        
        if (document.activeElement === newPostInput || document.activeElement === authorNameInput || isFeelingSelectorOpen) {
            
            // üî• Deep Blur (as requested)
            postsFeed.style.filter = 'blur(10px) grayscale(80%)'; 
            postsFeed.style.pointerEvents = 'none';
            header.style.zIndex = '60'; 
            
            postCreationCard.style.zIndex = '70';
            postCreationCard.style.transform = 'scale(1.02)';
            postCreationCard.style.transition = 'transform 0.3s, z-index 0s';
        }
    };

    const removeBlur = () => {
        // Small delay to allow focus shift between elements
        setTimeout(() => {
            const isFeelingSelectorOpen = !document.getElementById('feelingSelector').classList.contains('hidden');
            
            // Only remove blur if neither input is currently active AND the feeling selector is closed
            if (document.activeElement !== newPostInput && document.activeElement !== authorNameInput && !isFeelingSelectorOpen) {
                postsFeed.style.filter = 'none'; 
                postsFeed.style.pointerEvents = 'auto';
                header.style.zIndex = '50'; 
                
                postCreationCard.style.zIndex = 'auto';
                postCreationCard.style.transform = 'none';
            }
        }, 100); 
    };

    document.addEventListener('DOMContentLoaded', () => {
       
        newPostInput = document.getElementById('newPostInput');
        postsFeed = document.getElementById('postsFeed');
        header = document.getElementById('appHeader');
        authorNameInput = document.getElementById('authorName');
        postCreationCard = document.getElementById('postCreationCard'); 

        // Attach listeners for input focus/blur
        newPostInput.addEventListener('focus', applyBlur);
        authorNameInput.addEventListener('focus', applyBlur);
        
        newPostInput.addEventListener('blur', removeBlur);
        authorNameInput.addEventListener('blur', removeBlur);
              
        // 1. URL Parameter ‡∂ë‡∂ö ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (comment.html ‡∑Ä‡∑ô‡∂≠‡∑í‡∂±‡∑ä Back Button ‡∂ë‡∂ö ‡∑Ñ‡∂ª‡∑Ñ‡∑è ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑í ‡∑Ä‡∑í‡∂ß)
        const urlParams = new URLSearchParams(window.location.search);
        const highlightPostId = urlParams.get('highlightPost');

        if (highlightPostId) {
            // Post ID ‡∂∫ URL ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑í‡∂∂‡∑ö ‡∂±‡∂∏‡∑ä, ‡∂ë‡∂∫ ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂∏‡∑î.
            refreshSinglePost(highlightPostId);
            
            // ‡∂ë‡∂∏ Post ‡∂ë‡∂ö ‡∑Ä‡∑ô‡∂≠ Scroll ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            const targetPost = document.getElementById(`post-${highlightPostId}`);
            if (targetPost) {
                targetPost.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // URL ‡∂ë‡∂ö ‡∂¥‡∑í‡∂ª‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (‡∂±‡∑ê‡∑Ä‡∂≠ Load ‡∑Ä‡∑ñ ‡∑Ä‡∑í‡∂ß ‡∂±‡∑ê‡∑Ä‡∂≠ refresh ‡∑Ä‡∑ì‡∂∏ ‡∑Ä‡∑ê‡∑Ö‡∑ê‡∂ö‡∑ä‡∑Ä‡∑ì‡∂∏‡∂ß)
            window.history.replaceState(null, null, window.location.pathname);
        } 
        
        // 2. Local Storage ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ Back ‡∂∂‡∑ú‡∂≠‡∑ä‡∂≠‡∂∏ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑í ‡∑Ä‡∑í‡∂ß)
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('refreshPost_')) {
                const postId = key.split('_')[1];
                if (localStorage.getItem(key) === 'true') {
                    refreshSinglePost(postId);
                }
            }
        });
    });

    /* ============================================================
        üî• POST REFRESH LOGIC (NEW)
    ============================================================ */
    function refreshSinglePost(postId) {
        // 1. Firebase ‡∑Ä‡∑ô‡∂≠‡∑í‡∂±‡∑ä ‡∂ë‡∂∏ post ‡∂ë‡∂ö‡∑ö ‡∂±‡∑Ä‡∂≠‡∂∏ ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
        database.ref('posts/' + postId).once('value', (snapshot) => {
            const post = snapshot.val();
            if (post) {
                // 2. ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± post element ‡∂ë‡∂ö ‡∑É‡∑ú‡∂∫‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
                const postElement = document.getElementById(`post-${postId}`);
                if (postElement) {
                    
                    // 3. Comment Count ‡∂ë‡∂ö ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
                    const commentsCountSpan = postElement.querySelector('.comment-count');
                    if (commentsCountSpan) {
                        commentsCountSpan.textContent = post.commentsCount || 0;
                    }
                    
                    // 4. (‡∑Ä‡∑í‡∂ö‡∂Ω‡∑ä‡∂¥) - ‡∂ë‡∂∏ post ‡∂ë‡∂ö ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç‡∂∫‡∑ô‡∂±‡∑ä ‡∂â‡∑É‡∑ä‡∂∏‡∂≠‡∑î ‡∂ö‡∂ª ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏
                    postElement.style.border = '2px solid #f87171'; // ‡∂ª‡∂≠‡∑î ‡∂¥‡∑è‡∂ß border ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∏‡∑î
                    setTimeout(() => {
                        postElement.style.border = 'none'; // ‡∂ß‡∑í‡∂ö ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä‡∂ö‡∑í‡∂±‡∑ä border ‡∂ë‡∂ö ‡∂Ö‡∂∫‡∑í‡∂±‡∑ä ‡∂ö‡∂ª‡∂∏‡∑î
                    }, 1500);
                }
            }
        });

        // 5. Local Storage ‡∑Ñ‡∑í ‡∑É‡∂Ç‡∂•‡∑è‡∑Ä ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        localStorage.removeItem('refreshPost_' + postId);
    }
    
    /* ============================================================
            üîî NEW: NOTIFICATION & PUSH NOTIFICATION LOGIC
        ============================================================ */

        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                showNotification("‡∂∏‡∑ô‡∂∏ ‡∂∂‡∑ä‚Äç‡∂ª‡∑Ä‡∑î‡∑É‡∂ª‡∂∫ Notifications ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑É‡∑Ñ‡∂∫ ‡∂±‡∑ú‡∂Ø‡∂ö‡∑ä‡∑Ä‡∂∫‡∑í.");
                return;
            }
            if (Notification.permission === "granted") {
                showNotification('Notification ‡∂Ö‡∑Ä‡∑É‡∂ª‡∂∫ ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ì ‡∂á‡∂≠.');
                return;
            }

            // User must interact with the page to trigger this
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    showNotification("Notifications ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑í!");
                } else {
                    showNotification("Notifications ‡∂Ö‡∑Ä‡∑É‡∂ª‡∂∫ ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂ö‡∑ä‡∑Ç‡∑ö‡∂¥ ‡∑Ä‡∑í‡∂∫.");
                }
            });
        }
        
        function displayBrowserNotification(title, body) {
            if (Notification.permission === "granted") {
                // Browser Push Notification ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏
                new Notification(title, {
                    body: body,
                    icon: 'https://via.placeholder.com/48' // ‡∂î‡∂∂‡∂ß ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í icon path ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑ê‡∂ö‡∑ä‡∑Ä‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö.
                });
            }
        }
        
        // Notification Count ‡∑É‡∑Ñ Real-time Alerts ‡∑É‡∂≥‡∑Ñ‡∑è Listener ‡∂ë‡∂ö
        function setupNotificationListener(userId) {
            const notificationsRef = database.ref(`notifications/${userId}`); // Changed db.ref to database.ref
            const notificationCountElement = document.getElementById('notificationCount');
            
            // 1. Initial/Real-time Count Update
            notificationsRef.orderByChild('read').equalTo(false).on('value', snapshot => {
                const unreadCount = snapshot.numChildren();

                if (unreadCount > 0) {
                    notificationCountElement.textContent = unreadCount;
                    notificationCountElement.classList.remove('hidden');
                } else {
                    notificationCountElement.classList.add('hidden');
                }
            });

            // 2. Real-time New Notification Alert
            notificationsRef.limitToLast(1).on('child_added', snapshot => {
                const notif = snapshot.val();
                
                // Notification ‡∂ë‡∂ö read ‡∂ö‡∂ª ‡∂±‡∑ê‡∂≠‡∑í‡∂±‡∂∏‡∑ä ‡∑É‡∑Ñ ‡∂ë‡∂∫ ‡∂î‡∂∂‡∂ú‡∑ö‡∂∏ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂ö‡∑ä ‡∂±‡∑ú‡∑Ä‡∑ö ‡∂±‡∂∏‡∑ä ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
                if (!notif.read && notif.actorId !== userId) {
                    
                    database.ref(`users/${notif.actorId}`).once('value', userSnap => { // Changed db.ref to database.ref
                        const userData = userSnap.val();
                        const actorName = userData ? userData.name : '‡∂ö‡∑Ä‡∑î‡∂ª‡∑î‡∂±‡∑ä ‡∑Ñ‡∑ù';
                        
                        let title = '‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ö‡∑í‡∂±‡∑è ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏';
                        let message = '';
                        
                        if (notif.type === 'like') {
                            message = `${actorName} ‡∂î‡∂∂‡∑ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂ª‡∑í‡∂∫‡∑ê‡∂ö‡∑ä‡∑Ç‡∂±‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑î‡∂±‡∑ä‡∂±‡∑è! üëç`;
                        } else if (notif.type === 'comment') {
                            const commentContent = notif.content || '‡∂î‡∂∂‡∂ú‡∑ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä.';
                            const commentSnippet = commentContent.length > 50 ? commentContent.substring(0, 50) + '...' : commentContent;
                            message = `${actorName} ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ö‡∑Ö‡∑è: "${commentSnippet}" üí¨`;
                        }
                        
                        // Web Browser Push Notification ‡∂ë‡∂ö ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏
                        displayBrowserNotification(title, message);
                        
                        // In-App Notification ‡∂ë‡∂ö ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏ (‡∂¥‡∑Ä‡∂≠‡∑í‡∂± showNotification ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂∫‡∑í)
                        showNotification(message); 
                    });
                }
            });
        }
        
        /* ============================================================
            üî• NEW: Notification Panel Functions
        ============================================================ */
        let notificationPanelOpen = false;

        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            const button = document.getElementById('notificationButton');
            
            // Optional: Request permission the first time the user interacts with the button
            if (Notification.permission === 'default') {
                requestNotificationPermission();
            }

            if (panel.classList.contains('hidden')) {
                // Open the panel
                panel.classList.remove('hidden');
                notificationPanelOpen = true;
                loadAndRenderNotifications();

                // Close when clicking outside
                document.addEventListener('click', closeNotificationPanelOutside, true);
            } else {
                // Close the panel
                closeNotificationPanel();
            }
        }

        function closeNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.add('hidden');
            notificationPanelOpen = false;
            document.removeEventListener('click', closeNotificationPanelOutside, true);
        }

        function closeNotificationPanelOutside(event) {
            const panel = document.getElementById('notificationPanel');
            const button = document.getElementById('notificationButton');
            
            // Check if the click occurred outside the panel AND outside the button
            if (!panel.contains(event.target) && !button.contains(event.target)) {
                closeNotificationPanel();
            }
        }

        function loadAndRenderNotifications() {
            if (!currentUser) return;

            const list = document.getElementById('notificationsList');
            const loading = document.getElementById('loadingNotifications');
            const noNotifs = document.getElementById('noNotifications');
            
            list.innerHTML = '';
            loading.style.display = 'block';
            noNotifs.style.display = 'none';

            const notificationsRef = database.ref(`notifications/${currentUser.uid}`);
            
            // Get the latest 30 notifications
            notificationsRef.orderByChild('timestamp').limitToLast(30).once('value', async (snapshot) => {
                loading.style.display = 'none';
                
                if (!snapshot.exists()) {
                    noNotifs.style.display = 'block';
                    return;
                }

                const notifications = [];
                snapshot.forEach(s => {
                    notifications.push({ key: s.key, ...s.val() });
                });
                
                notifications.reverse(); // Newest first
                
                let needsMarkingAsRead = false;
                
                for (const notif of notifications) {
                    // Fetch actor details
                    const actorSnap = await database.ref(`users/${notif.actorId}`).once('value');
                    const actor = actorSnap.val();
                    const actorName = actor ? (actor.name || 'Unknown User') : 'Unknown User';

                    const html = createNotificationElement(notif, actorName);
                    list.appendChild(html);

                    if (!notif.read) {
                        needsMarkingAsRead = true;
                    }
                }

                // Mark all currently visible unread notifications as read
                if (needsMarkingAsRead) {
                    markAllNotificationsAsRead(notifications);
                }
                
                if (notifications.length === 0) {
                    noNotifs.style.display = 'block';
                }
            });
        }

        function createNotificationElement(notif, actorName) {
            const element = document.createElement('div');
            const timeAgo = getTimeAgo(notif.timestamp);
            let icon = '';
            let message = '';
            // Highlight unread notifications
            let highlightClass = notif.read ? 'bg-white/70' : 'bg-purple-50/90 border-l-4 border-purple-500';

            if (notif.type === 'like') {
                icon = '‚ù§Ô∏è';
                message = `**${actorName}** ‡∂î‡∂∂‡∑ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂ª‡∑í‡∂∫‡∑ê‡∂ö‡∑ä‡∑Ç‡∂±‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑î‡∂±‡∑ä‡∂±‡∑è.`;
            } else if (notif.type === 'comment') {
                icon = 'üí¨';
                const content = notif.content || '‡∂î‡∂∂‡∂ú‡∑ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä.';
                const snippet = content.length > 30 ? content.substring(0, 30) + '...' : content;
                message = `**${actorName}** ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ö‡∑Ö‡∑è: *"${snippet}"*`;
            }

            element.className = `${highlightClass} rounded-xl p-3 shadow-md transition-all duration-300 hover:shadow-lg cursor-pointer fade-in`;
            element.innerHTML = `
                <div class="flex items-start space-x-3">
                    <span class="text-2xl pt-0.5 shrink-0">${icon}</span>
                    <div class="flex-1">
                        <p class="text-sm text-gray-800 font-medium leading-snug">${message.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>')}</p>
                        <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                    </div>
                </div>
            `;
            
            element.onclick = () => {
                // Go to the post and close the panel
                window.location.href = `comment.html?postId=${notif.postId}`;
                closeNotificationPanel();
            };
            
            return element;
        }

        function markAllNotificationsAsRead(notifications) {
            if (!currentUser || !notifications.length) return;

            const updates = {};
            let unreadFound = false;
            
            // Only update notifications that are currently unread
            notifications.forEach(notif => {
                if (!notif.read) {
                    updates[`notifications/${currentUser.uid}/${notif.key}/read`] = true;
                    unreadFound = true;
                }
            });

            if (unreadFound) {
                database.ref().update(updates)
                    .catch(error => console.error("Error marking notifications as read:", error));
            }
        }
    </script>

</body>
</html>
