<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostKinaa - Chat (RTDB)</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script> 

    <style>
        /* ============================================================
            üî• ANIMATIONS & BASE STYLES
        ============================================================ */
        @keyframes fadeIn { from { opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
        .fade-in { animation: fadeIn 0.5s ease-out; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }

        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Chat-specific styles */
        .user-list-item {
            transition: all 0.3s ease;
        }

        .user-list-item:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
        
        .chat-message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }

        .sender-bubble {
            background-color: #a855f7; /* Purple-500 */
            color: white;
            border-radius: 20px 20px 5px 20px;
        }

        .receiver-bubble {
            background-color: #f3f4f6; /* Gray-100 */
            color: #1f2937; /* Gray-900 */
            border-radius: 20px 20px 20px 5px;
        }

        input:focus, textarea:focus {
            transform: scale(1.01);
            transition: all 0.3s ease;
        }
        
        /* ============================================================
            üî• MOBILE RESPONSIVENESS
        ============================================================ */
        .main-chat-container {
            display: flex;
        }

        @media (max-width: 767px) {
            .main-chat-container {
                flex-direction: column;
            }
            /* Default: User list is visible, Chat is hidden */
            #userListPanel {
                width: 100%;
                min-width: unset;
                margin-right: 0;
                height: 80vh; /* Set a fixed height for the list */
            }
            .chat-area-main {
                width: 100%;
                height: 80vh;
                position: fixed; /* Fix the chat area to the screen for better mobile transition */
                top: 0;
                left: 0;
                z-index: 40;
                /* By default hide chat on mobile */
                display: none !important; 
            }
            
            /* Toggle visibility for mobile */
            .mobile-hide {
                display: none !important;
            }
            .mobile-show {
                display: flex !important; /* Overrides the default mobile hidden state */
            }
        }
    </style>
</head>

<body class="min-h-screen">

    <div id="notification-box" class="fixed top-5 left-1/2 transform -translate-x-1/2 hidden z-[100]"></div>
    
    <div id="message-context-menu" 
         class="absolute glass-effect shadow-xl rounded-lg border border-gray-200 z-50 py-1 hidden">
        <button id="edit-message-btn" 
                class="w-full text-left px-4 py-2 text-sm text-gray-800 hover:bg-purple-50">
            ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
        </button>
        <button id="delete-message-btn" 
                class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50">
            ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∏‡∂ö‡∂±‡∑ä‡∂±
        </button>
    </div>

    <header id="appHeader" class="glass-effect sticky top-0 z-50 shadow-2xl border-b-2 border-white/50">
        <div class="max-w-4xl mx-auto px-4 py-3 sm:py-5 flex items-center justify-between">
            
            <div class="flex items-center space-x-2 sm:space-x-4">
                <button onclick="goToHome()" title="‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä"
                    class="p-2 sm:p-3 text-xl sm:text-2xl text-gray-600 hover:text-purple-600 hover:bg-purple-100 rounded-xl sm:rounded-2xl transition-all duration-300 hover:scale-110 hover:-rotate-6">
                    üè†
                </button>
                <h1 class="text-3xl sm:text-4xl font-black text-purple-600">üí¨ Chat</h1> 
                <div id="user-info-header" class="ml-4 flex items-center space-x-2 text-gray-700 hidden sm:flex">
                </div>
            </div>

            <div class="flex items-center space-x-3">
                <button onclick="signOutUser()"  
                    class="px-3 py-1.5 sm:px-5 sm:py-2 bg-gradient-to-r from-red-400 to-pink-500 text-white rounded-full text-xs sm:text-sm font-bold hover:from-red-500 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105">
                    üö™ Logout
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6 main-chat-container">

        <div id="userListPanel" class="w-1/3 min-w-[200px] glass-effect rounded-3xl shadow-2xl border-2 border-white/40 p-5 mr-6 h-[80vh] overflow-y-auto">
            
            <input type="text" id="user-search-input" placeholder="‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∂±‡∑ä ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±..." 
                   class="w-full p-3 mb-4 border border-gray-300 rounded-xl focus:ring-purple-500 focus:border-purple-500 transition duration-300 shadow-inner hover:bg-white/90">
            
            <h2 class="text-2xl font-bold text-gray-800 border-b-2 pb-3 mb-4">‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑í‡∂±‡∑ä</h2>
            <div id="usersList" class="space-y-3">
                <p class="text-center text-gray-500 py-4"><span class="inline-block w-6 h-6 border-2 border-gray-200 border-t-gray-600 rounded-full spinner"></span> Loading...</p>
            </div>
        </div>

        <div id="chat-area-main" class="flex-1 glass-effect rounded-3xl shadow-2xl border-2 border-white/40 flex flex-col h-[80vh] relative">
            
            <div id="chat-partner-header" class="p-4 border-b border-gray-200 bg-white/70 rounded-t-3xl hidden items-center justify-between">
                <div class="flex items-center">
                    <button id="back-to-list-btn" class="md:hidden text-purple-600 text-2xl mr-3 font-bold">‚Üê</button>
                    
                    <span id="chat-partner-name" class="font-bold text-lg text-gray-800"></span>
                    <div id="online-status" class="text-xs ml-3 px-2 py-1 rounded-full font-semibold"></div> 
                </div>
                <button onclick="blockUser()" id="block-button" class="text-white px-4 py-1.5 rounded-full text-sm font-bold transition-all duration-300 shadow-lg">
                    üö´ Block
                </button>
            </div>


            <div id="chatDefaultMessage" class="absolute inset-0 flex items-center justify-center p-8 text-center bg-white/50 backdrop-blur-sm rounded-3xl">
                <div class="text-center fade-in">
                    <div class="text-6xl mb-4 float">üëã</div>
                    <h3 class="text-2xl font-bold text-gray-700">‡∂ö‡∂≠‡∑è‡∂∂‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑ô‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.</h3>
                    <p class="text-gray-500 mt-2">‡∑Ä‡∂∏‡∑ä ‡∂¥‡∑É ‡∂á‡∂≠‡∑í ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ö‡∑ô‡∂±‡∑ô‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.</p>
                </div>
            </div>

            <div id="messagesContainer" class="flex-1 overflow-y-auto p-5 space-y-4 hidden">
            </div>

            <div id="chatInputArea" class="p-5 border-t border-gray-200 bg-white/70 rounded-b-3xl hidden">
                <div class="flex space-x-3">
                    <input type="text" id="chatMessageInput" placeholder="‡∂î‡∂∂‡∂ú‡∑ö ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∏‡∑ô‡∂≠‡∂± ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±..."
                        class="flex-1 px-5 py-3 bg-white/60 backdrop-blur-sm rounded-2xl border-2 border-blue-200 focus:border-blue-500 outline-none transition-all duration-300 font-medium text-gray-700 hover:bg-white/80 shadow-sm text-base"
                        onkeydown="if(event.key === 'Enter') sendMessage()">
                    
                    <button onclick="sendMessage()" id="sendButton"
                        class="px-4 py-3 sm:px-6 bg-gradient-to-r from-blue-600 to-teal-600 text-white rounded-2xl font-bold hover:from-blue-700 hover:to-teal-700 shadow-xl transition-all duration-300 flex items-center space-x-1 sm:space-x-2 hover:scale-105 text-sm sm:text-base">
                        <span>üöÄ ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    
    /* ============================================================
        üî• Firebase Config + Init 
    ============================================================ */
    const firebaseConfig = {
        apiKey: "AIzaSyAzNJ-P8aAMvTuNWKcQYCjIIHiaL0BpdZ0",
        authDomain: "game-f1c21.firebaseapp.com",
        databaseURL: "https://game-f1c21-default-rtdb.firebaseio.com", 
        projectId: "game-f1c21",
        storageBucket: "game-f1c21.firebasestorage.app",
        messagingSenderId: "656338565711",
        appId: "1:656338565711:web:395f9c7f846588b065883a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const rtdb = firebase.database(); 
    const usersRef = rtdb.ref("users"); 
    const chatsRef = rtdb.ref("chats"); 
    const notificationsRef = rtdb.ref("notifications"); 

    let currentUser = null;
    let currentChatRecipient = null; 
    let messageListener = null; 
    let presenceListener = null; 
    let isCurrentUserBlockedByPartnerListener = null; 

    let isEditingMessage = false;
    let editingMessageKey = null;
    let isPartnerBlocked = false; 
    let isCurrentUserBlockedByPartner = false; 
    // üî• ‡∂ö‡∑í‡∂∫‡∑Ä‡∑è ‡∂±‡∑ê‡∂≠‡∑í ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© ‡∂ú‡∂´‡∂± ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂± ‡∂ú‡∑ù‡∂Ω‡∑ì‡∂∫ ‡∑Ä‡∑É‡∑ä‡∂≠‡∑î‡∑Ä
    let unreadChatCounts = {}; 

    /* ============================================================
        üî• Auth Check and User Data Setup
    ============================================================ */
    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = "index.html"; 
            return;
        }
        
        usersRef.child(user.uid).once('value').then(snapshot => {
            if (snapshot.exists()) {
                currentUser = { uid: user.uid, ...snapshot.val() };
            } else {
                currentUser = { uid: user.uid, name: user.displayName || 'User' };
            }
            initChatApp();
        }).catch(error => {
            console.error("Error fetching user data:", error);
            currentUser = { uid: user.uid, name: user.displayName || 'User' };
            initChatApp();
        });
    });

    function goToHome() {
        window.location.href = "Home.html";
    }

    function signOutUser() {
        if (currentUser) {
            // Set last active timestamp on sign out
            usersRef.child(currentUser.uid).child('presence').set(firebase.database.ServerValue.TIMESTAMP)
            .catch(e => console.error("Error setting offline status:", e));
        }

        auth.signOut().then(() => {
            window.location.href = "index.html";
        });
    }

    function initChatApp() {
        document.getElementById('user-search-input').addEventListener('input', (e) => loadUsers(e.target.value));
        document.getElementById('back-to-list-btn').addEventListener('click', showUserList);
        
        loadUsers(); 
        setupOnlineHeartbeat();
        // üî• Unread ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑É‡∑Ä‡∂±‡∑ä ‡∂Ø‡∑ì‡∂∏ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        listenForUnreadChatNotifications();
        
        // Listener: ‡∂Ö‡∂¥ ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∑Ö ‡∂Ö‡∂∫‡∂ú‡∑ö ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä
        usersRef.child(currentUser.uid).child('blocked').on('value', snapshot => {
            currentUser.blockedUsers = snapshot.val() || {}; 
            
            if (currentChatRecipient) {
                 const recipientName = document.getElementById('chat-partner-name').textContent;
                 updateChatUIBasedOnInternalBlockStatus(currentChatRecipient, recipientName);
            }
        });
        
        const userInfoHeader = document.getElementById('user-info-header');
        userInfoHeader.innerHTML = `
            <span class="font-semibold">${currentUser.name || 'User'}</span>
            <span class="text-xl">${currentUser.currentFeeling || 'üôÇ'}</span>
        `;
        userInfoHeader.classList.remove('hidden');
        
        document.getElementById('edit-message-btn').addEventListener('click', editMessageAction);
        document.getElementById('delete-message-btn').addEventListener('click', deleteMessageAction);
    }
    
    /* ============================================================
        üî• RTDB PRESENCE & Helpers
    ============================================================ */
    function setupOnlineHeartbeat() {
        const presenceRef = usersRef.child(currentUser.uid).child('presence');
        const connectedRef = rtdb.ref('.info/connected');

        connectedRef.on('value', (snapshot) => {
            if (snapshot.val() === true) {
                presenceRef.set(true);
                presenceRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
            }
        });
    }

    function getTimeAgo(ts) {
        if (!ts || typeof ts !== 'number') return "‡∂Ø‡∑ê‡∂±‡∑ä‡∂∏";
        const diff = Date.now() - ts;
        const s = diff/1000;
        if (s<60) return `${Math.floor(s)}s ‡∂¥‡∑ô‡∂ª`;
        const m=s/60;
        if (m<60) return `${Math.floor(m)}min ‡∂¥‡∑ô‡∂ª`;
        const h=m/60;
        if (h<24) return `${Math.floor(h)}h ‡∂¥‡∑ô‡∂ª`;
        
        return `${new Date(ts).toLocaleDateString()} ${new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`; 
    }

    function listenForPartnerPresence(partnerId) {
        if (presenceListener) {
            if (currentChatRecipient) usersRef.child(currentChatRecipient).child('presence').off('value', presenceListener);
            presenceListener = null;
        }
        
        const partnerPresenceRef = usersRef.child(partnerId).child('presence');
        
        presenceListener = partnerPresenceRef.on('value', snapshot => {
            const statusDiv = document.getElementById('online-status');
            const presenceValue = snapshot.val();

            if (presenceValue === true) {
                statusDiv.textContent = 'Online';
                statusDiv.className = 'text-xs ml-3 px-2 py-1 rounded-full font-semibold bg-green-500 text-white';
            } else if (typeof presenceValue === 'number') {
                const lastActiveTime = presenceValue;
                const timeDiffHours = (Date.now() - lastActiveTime) / 3600000;

                if (timeDiffHours < 1) {
                    statusDiv.textContent = 'Just now';
                    statusDiv.className = 'text-xs ml-3 px-2 py-1 rounded-full font-semibold bg-yellow-500 text-white';
                } else {
                    statusDiv.textContent = `Last seen: ${getTimeAgo(lastActiveTime)}`;
                    statusDiv.className = 'text-xs ml-3 px-2 py-1 rounded-full font-semibold bg-gray-400 text-white';
                }
            } else {
                statusDiv.textContent = 'Offline';
                statusDiv.className = 'text-xs ml-3 px-2 py-1 rounded-full font-semibold bg-gray-400 text-white';
            }
        }, error => console.error("Presence listen error:", error));
    }
    
    function listenForBeingBlockedByPartner(partnerId) {
        // Listener: ‡∂Ö‡∂±‡∑ä‡∂≠‡∑í‡∂∏‡∂∫‡∑è ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂Ö‡∂¥‡∑Ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠‡∑ä‡∂Ø‡∑ê‡∂∫‡∑í ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß
        const isBlockedByPartnerRef = usersRef.child(partnerId).child('blocked').child(currentUser.uid);
        
        if (isCurrentUserBlockedByPartnerListener) {
            isBlockedByPartnerRef.off('value', isCurrentUserBlockedByPartnerListener);
            isCurrentUserBlockedByPartnerListener = null;
        }

        isCurrentUserBlockedByPartnerListener = isBlockedByPartnerRef.on('value', snapshot => {
            isCurrentUserBlockedByPartner = snapshot.val() === true;
            
            const recipientName = document.getElementById('chat-partner-name').textContent;
            updateChatUIBasedOnExternalBlockStatus(recipientName);
        }, error => console.error("External block listen error:", error));
    }
    
    // üî• ‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∑í‡∂≠: ‡∂ö‡∑í‡∂∫‡∑Ä‡∑è ‡∂±‡∑ê‡∂≠‡∑í chat-type notifications ‡∂ú‡∂´‡∂±‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∑É‡∑Ä‡∂±‡∑ä ‡∂Ø‡∑ô‡∂∫‡∑í
    function listenForUnreadChatNotifications() {
        if (!currentUser) return;

        // ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ notifications ‡∑Ä‡∂Ω‡∂ß ‡∑É‡∑Ä‡∂±‡∑ä ‡∂Ø‡∑ô‡∂∫‡∑í
        notificationsRef.child(currentUser.uid).on('value', snapshot => {
            const newUnreadCounts = {};
            
            snapshot.forEach(childSnapshot => {
                const notif = childSnapshot.val();
                // ‡∂ö‡∑í‡∂∫‡∑Ä‡∑è ‡∂±‡∑ê‡∂≠‡∑í chat messages ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂¥‡∑ô‡∂ª‡∑ì‡∂∏
                if (notif.type === 'message' && notif.actorId && !notif.read) {
                    const senderId = notif.actorId;
                    newUnreadCounts[senderId] = (newUnreadCounts[senderId] || 0) + 1;
                }
            });

            // ‡∂ú‡∂´‡∂±‡∑ä ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∑Ä‡∑ì ‡∂á‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∂ú‡∑ù‡∂Ω‡∑ì‡∂∫ ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä ‡∂±‡∑ê‡∑Ä‡∂≠ Load ‡∂ö‡∂ª‡∂∫‡∑í
            if (JSON.stringify(unreadChatCounts) !== JSON.stringify(newUnreadCounts)) {
                unreadChatCounts = newUnreadCounts;
                // ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä ‡∂±‡∑ê‡∑Ä‡∂≠ Load ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (‡∂ª‡∂≠‡∑î ‡∂©‡∑ú‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∂ß/‡∑É‡∑ê‡∂ü‡∑Ä‡∑ì‡∂∏‡∂ß ‡∑É‡∑Ñ ‡∑Ä‡∂ª‡∑ä‡∂ú ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß)
                loadUsers(document.getElementById('user-search-input').value); 
            }
        });
    }

    // üî• ‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∑í‡∂≠: ‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∑í‡∂≠ ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑ô‡∂ö‡∑î‡∂ú‡∑ô‡∂±‡∑ä ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑í ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ chat notifications ‡∂ö‡∑í‡∂∫‡∑Ä‡∑ñ ‡∂∂‡∑Ä‡∂ß ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∂ª‡∂∫‡∑í
    function markChatNotificationsAsRead(partnerId) {
        if (!currentUser || !partnerId) return;

        notificationsRef.child(currentUser.uid)
            .orderByChild('actorId')
            .equalTo(partnerId)
            .once('value')
            .then(snapshot => {
                const updates = {};
                let marked = false;
                
                snapshot.forEach(childSnapshot => {
                    const notif = childSnapshot.val();
                    if (notif.type === 'message' && !notif.read) {
                        updates[`notifications/${currentUser.uid}/${childSnapshot.key}/read`] = true;
                        marked = true;
                    }
                });

                if (marked) {
                    rtdb.ref().update(updates)
                        .catch(error => console.error("Error marking chat notifs as read:", error));
                }
                
                // Read ‡∂ö‡∑Ö ‡∂¥‡∑É‡∑î ‡∑Ä‡∑Ñ‡∑è‡∂∏ ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
                if (unreadChatCounts[partnerId]) {
                    delete unreadChatCounts[partnerId];
                    loadUsers(document.getElementById('user-search-input').value);
                }
            })
            .catch(error => console.error("Error fetching notifs for read:", error));
    }


    /* ============================================================
        üî• Chat Initialization and UI Control
    ============================================================ */
    function startChat(recipientUid, recipientName) {
        if (!recipientUid || typeof recipientUid !== 'string' || recipientUid === 'undefined' || recipientUid === currentUser.uid) {
            console.error("Invalid recipient:", recipientUid);
            showNotification("‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä. ‚ùå");
            return;
        }

        // Clean up previous listeners
        if (messageListener && currentChatRecipient) {
            const oldChatRoomId = getChatRoomId(currentUser.uid, currentChatRecipient);
            chatsRef.child(oldChatRoomId).off('value', messageListener);
            messageListener = null;
        }
        if (presenceListener && currentChatRecipient) {
            usersRef.child(currentChatRecipient).child('presence').off('value', presenceListener);
            presenceListener = null;
        }
        if (isCurrentUserBlockedByPartnerListener && currentChatRecipient) {
            usersRef.child(currentChatRecipient).child('blocked').child(currentUser.uid).off('value', isCurrentUserBlockedByPartnerListener);
            isCurrentUserBlockedByPartnerListener = null;
        }

        currentChatRecipient = recipientUid;
        
        // UI updates
        document.getElementById('chatDefaultMessage').classList.add('hidden');
        document.getElementById('messagesContainer').classList.remove('hidden');
        document.getElementById('chat-partner-header').classList.remove('hidden');
        document.getElementById('chat-partner-header').classList.add('flex');
        
        document.getElementById('chat-partner-name').textContent = recipientName;
        document.getElementById('messagesContainer').innerHTML = ""; 
        document.getElementById('chatMessageInput').value = "";
        document.getElementById('chatMessageInput').focus();

        // Mobile responsiveness: Hide user list, show chat area
        document.getElementById('userListPanel').classList.add('mobile-hide');
        document.getElementById('chat-area-main').classList.add('mobile-show');

        // Highlight the selected user
        document.querySelectorAll('.user-list-item').forEach(el => {
            // Unread highlight class ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            el.classList.remove('border-purple-500', 'bg-purple-100/90', 'scale-105', 'border-red-400', 'bg-red-50/70', 'shadow-lg');
            if (el.getAttribute('data-uid') === recipientUid) {
                el.classList.add('border-purple-500', 'bg-purple-100/90', 'scale-105');
            }
        });

        // Start necessary listeners
        listenForPartnerPresence(recipientUid);
        listenForBeingBlockedByPartner(recipientUid); 
        
        // ‡∂Ö‡∂∑‡∑ä‚Äç‡∂∫‡∂±‡∑ä‡∂≠‡∂ª ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª UI ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        updateChatUIBasedOnInternalBlockStatus(recipientUid, recipientName); 
        
        // ‡∂∂‡∑è‡∑Ñ‡∑í‡∂ª ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∂∏‡∂≠ ‡∂Ö‡∑Ä‡∑É‡∑è‡∂± UI ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∑É‡∂ö‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        updateChatUIBasedOnExternalBlockStatus(recipientName); 
        
        // üî• ‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∑í‡∂≠: ‡∂∏‡∑ô‡∂∏ ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è‡∂ú‡∑ô‡∂±‡∑ä ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑í ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© ‡∂ö‡∑í‡∂∫‡∑Ä‡∑ñ ‡∂∂‡∑Ä‡∂ß ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        markChatNotificationsAsRead(recipientUid); 

        // ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© Load ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è‡∑Ä‡∂±‡∑ä ‡∂Ø‡∑ô‡∂ö‡∂∏ ‡∂Ö‡∑É‡∂∏‡∂≠‡∑ä ‡∑Ä‡∑î‡∑Ä‡∑Ñ‡∑ú‡∂≠‡∑ä)
        if (!isPartnerBlocked && !isCurrentUserBlockedByPartner) {
             listenForMessages(recipientUid);
        }
    }
    
    function listenForMessages(recipientUid) {
        if (messageListener) return; 
        
        const chatRoomId = getChatRoomId(currentUser.uid, recipientUid);
        const chatRoomRef = chatsRef.child(chatRoomId);
        
        messageListener = chatRoomRef.on('value', snapshot => {
            const messagesContainer = document.getElementById("messagesContainer");
            
            if (messagesContainer.querySelector('.block-message-container')) return; 

            messagesContainer.innerHTML = ""; 
            
            snapshot.forEach(childSnapshot => {
                const messageKey = childSnapshot.key;
                const message = childSnapshot.val();
                renderMessage(messageKey, message);
            });
            scrollToBottom();
        }, error => {
            console.error("Error listening to messages:", error);
            showNotification("‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© Load ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä. ‚ùå");
        });
    }

    function showUserList() {
        // Mobile only: Show user list, hide chat area
        document.getElementById('userListPanel').classList.remove('mobile-hide');
        document.getElementById('chat-area-main').classList.remove('mobile-show');
    }

    function getChatRoomId(uid1, uid2) {
        return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
    }

    // ‡∂Ö‡∂¥ ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∑Ö ‡∂Ö‡∂∫‡∂ú‡∑ö ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    function updateChatUIBasedOnInternalBlockStatus(recipientUid, recipientName) {
        const isBlocked = !!(currentUser.blockedUsers && currentUser.blockedUsers[recipientUid]);
        isPartnerBlocked = isBlocked; 
        
        const blockButton = document.getElementById('block-button');
        
        if (isBlocked) {
            blockButton.textContent = 'üîì Unblock';
            blockButton.className = 'bg-green-500 text-white px-4 py-1.5 rounded-full text-sm font-bold hover:bg-green-600 transition-all duration-300 shadow-lg';
            
            if (messageListener && currentChatRecipient) {
                chatsRef.child(getChatRoomId(currentUser.uid, currentChatRecipient)).off('value', messageListener);
                messageListener = null;
            }
            
        } else {
            blockButton.textContent = 'üö´ Block';
            blockButton.className = 'bg-red-500 text-white px-4 py-1.5 rounded-full text-sm font-bold hover:bg-red-600 transition-all duration-300 shadow-lg';
            
            if (!isCurrentUserBlockedByPartner && !messageListener && currentChatRecipient) {
                 listenForMessages(currentChatRecipient);
            }
        }
        
        updateChatUIBasedOnExternalBlockStatus(recipientName);
    }

    // ‡∂Ö‡∂±‡∑ä‡∂≠‡∑í‡∂∏‡∂∫‡∑è ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂Ö‡∂¥‡∑Ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∑Ö ‡∑Ä‡∑í‡∂ß UI ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    function updateChatUIBasedOnExternalBlockStatus(partnerName) {
        const chatInputArea = document.getElementById('chatInputArea');
        const messagesContainer = document.getElementById('messagesContainer');
        
        // 1. ‡∂Ö‡∂¥‡∑í ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠‡∑ä‡∂Ø (‡∂Ö‡∂¥‡∑ö ‡∂¥‡∑ê‡∂≠‡∑ä‡∂≠‡∑ô‡∂±‡∑ä)
        if (isPartnerBlocked) {
             chatInputArea.classList.add('hidden');
             messagesContainer.innerHTML = `
                <div class="block-message-container flex items-center justify-center h-full p-8">
                    <div class="text-center bg-white/70 backdrop-blur-sm p-8 rounded-xl shadow-lg">
                        <p class="text-3xl mb-3">üö´</p>
                        <p class="text-xl font-bold text-red-700">${partnerName} ‡∂î‡∂∂ ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠.</p>
                        <p class="text-gray-600 mt-2">‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏‡∂ß ‡∂â‡∂© ‡∂Ø‡∑ì‡∂∏‡∂ß 'Unblock' ‡∂∂‡∑ú‡∂≠‡∑ä‡∂≠‡∂∏ ‡∂î‡∂∂‡∂±‡∑ä‡∂±.</p>
                    </div>
                </div>
            `;
            

        // 2. ‡∂î‡∑Ä‡∑î‡∂±‡∑ä ‡∂Ö‡∂¥‡∑Ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠‡∑ä‡∂±‡∂∏‡∑ä (‡∂∂‡∑è‡∑Ñ‡∑í‡∂ª ‡∂¥‡∑ê‡∂≠‡∑ä‡∂≠‡∑ô‡∂±‡∑ä)
        } else if (isCurrentUserBlockedByPartner) {
            chatInputArea.classList.add('hidden');
            
            if (messageListener && currentChatRecipient) {
                chatsRef.child(getChatRoomId(currentUser.uid, currentChatRecipient)).off('value', messageListener);
                messageListener = null;
            }

            messagesContainer.innerHTML = `
                <div class="block-message-container flex items-center justify-center h-full p-8">
                    <div class="text-center bg-white/70 backdrop-blur-sm p-8 rounded-xl shadow-lg">
                        <p class="text-3xl mb-3">üõë</p>
                        <p class="text-xl font-bold text-red-700">${partnerName} ‡∂î‡∂∂‡∑Ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠.</p>
                        <p class="text-gray-600 mt-2">‡∂î‡∂∂‡∂ß ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í‡∂∫.</p>
                    </div>
                </div>
            `;
            
        // 3. ‡∂ö‡∑í‡∑É‡∑í‡∑Ä‡∑ô‡∂ö‡∑î ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∂ª ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä
        } else {
            chatInputArea.classList.remove('hidden');
            
            // ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© listener ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
            const blockMessage = messagesContainer.querySelector('.block-message-container');
            if (blockMessage) {
                messagesContainer.innerHTML = '';
            }
             if (!messageListener && currentChatRecipient) {
                 listenForMessages(currentChatRecipient);
            }
        }
    }


    /* ============================================================
        üî• Messaging & Actions (Send, Edit, Delete, Block/Unblock)
    ============================================================ */
    function sendMessage() {
        if (!currentUser || !currentUser.uid) {
            showNotification("‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑ê‡∂≠. ‚ùå");
            return;
        }

        if (!currentChatRecipient || typeof currentChatRecipient !== 'string' || currentChatRecipient === 'undefined') {
            showNotification("‡∂ö‡∂≠‡∑è‡∂∂‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑ô‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±. ‚ùå");
            return; 
        }

        // üõ°Ô∏è Block sending if either party has blocked the other
        if (isPartnerBlocked || isCurrentUserBlockedByPartner) { 
             showNotification("‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö. ‡∂ö‡∂≠‡∑è‡∂∂‡∑É‡∑ä ‡∂≠‡∑Ñ‡∂±‡∂∏‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠. üö´");
             return;
        }
        
        const inputEl = document.getElementById("chatMessageInput");
        const content = inputEl.value.trim();

        if (content === "") {
            showNotification("‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫‡∂ö‡∑ä ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±. ‚ö†Ô∏è");
            return;
        }

        const chatRoomId = getChatRoomId(currentUser.uid, currentChatRecipient);
        const chatRoomRef = chatsRef.child(chatRoomId);

        if (isEditingMessage && editingMessageKey) {
             // 1. Edit existing message
             chatRoomRef.child(editingMessageKey).update({
                content: content,
                edited: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                showNotification("‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑í. ‚úèÔ∏è");
                resetInputMode();
            }).catch(error => {
                console.error("Edit error:", error);
                showNotification("‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´ ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä. ‚ùå");
            });
            
        } else {
            // 2. Send new message
            const newMessage = {
                senderId: currentUser.uid,
                recipientId: currentChatRecipient,
                content: content,
                timestamp: firebase.database.ServerValue.TIMESTAMP, 
                edited: false
            };

            chatRoomRef.push(newMessage) 
            .then(() => {
                inputEl.value = ""; 
                inputEl.focus();
                
                // üî• ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∫‡∑ê‡∑Ä‡∑ñ ‡∂¥‡∑É‡∑î notification ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏ (‡∂ª‡∂≠‡∑î ‡∂©‡∑ú‡∂ß‡∑ä ‡∂ë‡∂ö ‡∑É‡∂≥‡∑Ñ‡∑è)
                notificationsRef.child(currentChatRecipient).push({
                    type: 'message', 
                    actorId: currentUser.uid,
                    read: false,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).catch(error => {
                    console.error("Error sending chat notification:", error);
                });
            })
            .catch(error => {
                console.error("Error sending message:", error);
                showNotification("‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‚ùå");
            });
        }
    }
    
    function renderMessage(messageKey, message) {
        const container = document.getElementById("messagesContainer");
        const isSender = message.senderId === currentUser.uid;

        const existingEl = document.getElementById(`msg-${messageKey}`);
        if (existingEl) {
             const time = message.timestamp ? getTimeAgo(message.timestamp) : "‡∂Ø‡∑ê‡∂±‡∑ä‡∂∏"; 
             const editedMark = message.edited ? '<span class="text-xs ml-1 opacity-60">(edited)</span>' : '';
             existingEl.querySelector('.message-content').textContent = message.content;
             existingEl.querySelector('.message-timestamp').innerHTML = `${time} ${editedMark}`;
             return;
        }

        const div = document.createElement('div');
        div.id = `msg-${messageKey}`;
        div.className = `flex ${isSender ? 'justify-end' : 'justify-start'} fade-in`;
        
        const time = message.timestamp ? getTimeAgo(message.timestamp) : "‡∂Ø‡∑ê‡∂±‡∑ä‡∂∏"; 
        const editedMark = message.edited ? '<span class="text-xs ml-1 opacity-60">(edited)</span>' : '';
        
        const bubble = document.createElement('div');
        bubble.className = `chat-message-bubble ${isSender ? 'sender-bubble' : 'receiver-bubble'} px-4 py-2 text-sm sm:text-base shadow-md cursor-pointer`;
        bubble.innerHTML = `
            <span class="message-content">${message.content}</span>
            <p class="text-xs mt-1 message-timestamp ${isSender ? 'text-purple-200' : 'text-gray-400'} text-right">
                ${time} ${editedMark}
            </p>
        `;

        // Add context menu listener only for the sender's message (for Edit/Delete)
        if (isSender) {
            bubble.addEventListener('contextmenu', (e) => showContextMenu(messageKey, e));
            bubble.addEventListener('click', (e) => { 
                if (window.innerWidth < 768) showContextMenu(messageKey, e); // Mobile click = context menu
            });
        }
        
        div.appendChild(bubble);
        container.appendChild(div);
    }
    
    function showContextMenu(messageKey, event) {
        if (isPartnerBlocked || isCurrentUserBlockedByPartner) return; // Cannot edit/delete if chat is blocked

        event.preventDefault(); 
        
        editingMessageKey = messageKey;
        const menu = document.getElementById('message-context-menu');
        
        // Position the menu
        menu.style.top = `${event.clientY}px`;
        menu.style.left = `${event.clientX}px`;
        menu.classList.remove('hidden');

        document.removeEventListener('click', hideContextMenu); 
        document.addEventListener('click', hideContextMenu, { once: true });
    }

    function hideContextMenu() {
        document.getElementById('message-context-menu').classList.add('hidden');
    }

    function editMessageAction() {
        if (!editingMessageKey || !currentChatRecipient) return;
        
        const messageEl = document.getElementById(`msg-${editingMessageKey}`);
        const currentText = messageEl.querySelector('.message-content').textContent;

        document.getElementById('chatMessageInput').value = currentText;
        document.getElementById('sendButton').innerHTML = '<span>üíæ Save Edit</span>';
        isEditingMessage = true;
        hideContextMenu();
        document.getElementById('chatMessageInput').focus();
    }

    function deleteMessageAction() {
        if (editingMessageKey && currentChatRecipient) {
            if (confirm("‡∂î‡∂∂‡∂ß ‡∂∏‡∑ô‡∂∏ ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∏‡∑ê‡∂ö‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø?")) {
                const chatRoomId = getChatRoomId(currentUser.uid, currentChatRecipient); 
                chatsRef.child(chatRoomId).child(editingMessageKey).remove() 
                    .then(() => {
                        showNotification("‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∏‡∑ê‡∂ö‡∑î‡∑Ä‡∑è! üóëÔ∏è");
                    })
                    .catch(error => {
                        console.error("Delete error:", error);
                        showNotification("‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∏‡∑ê‡∂ö‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä. ‚ùå");
                    });
            }
        }
        resetInputMode();
        hideContextMenu();
    }

    function resetInputMode() {
        document.getElementById('chatMessageInput').value = '';
        document.getElementById('sendButton').innerHTML = '<span>üöÄ ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±</span>';
        isEditingMessage = false;
        editingMessageKey = null;
    }

    function blockUser() {
        if (!currentChatRecipient || typeof currentChatRecipient !== 'string' || currentChatRecipient === 'undefined') {
            showNotification("‡∂ö‡∂≠‡∑è‡∂∂‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑ô‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±. ‚ùå");
            return;
        }

        const partnerName = document.getElementById('chat-partner-name').textContent;
        const recipientUid = currentChatRecipient;
        const isCurrentlyBlocked = isPartnerBlocked; 

        const action = isCurrentlyBlocked ? 'unblock' : 'block';
        const confirmMessage = isCurrentlyBlocked 
            ? `${partnerName} Unblock ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø?` 
            : `${partnerName} ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø? ‡∂â‡∂±‡∑ä‡∂¥‡∑É‡∑î ‡∂î‡∂∂‡∂ß ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂© ‡∂∫‡∑ê‡∑Ä‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö.`;

        if (confirm(confirmMessage)) {
            
            const blockRef = usersRef.child(currentUser.uid).child('blocked').child(recipientUid);
            
            if (action === 'block') {
                blockRef.set(true)
                    .then(() => {
                        showNotification(`${partnerName} ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì. üö´`);
                    })
                    .catch(err => console.error("Block error:", err));
            } else { // Unblock
                blockRef.remove()
                    .then(() => {
                        showNotification(`${partnerName} Unblock ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì. ‚úÖ`);
                        // Unblock ‡∑Ä‡∑ñ ‡∂¥‡∑É‡∑î UI ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß chat ‡∂ë‡∂ö ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
                        startChat(recipientUid, partnerName); 
                    })
                    .catch(err => console.error("Unblock error:", err));
            }
        }
    }
    
    /* ============================================================
        üî• Helpers 
    ============================================================ */
    function showNotification(text) {
        const container = document.getElementById('notification-box');
        container.innerHTML = ''; 
        container.classList.remove('hidden');

        const box = document.createElement('div');
        box.className = "fixed top-5 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-blue-600 via-teal-600 to-green-600 text-white px-6 py-3 rounded-full shadow-2xl text-sm z-50 fade-in font-bold";
        box.textContent = text;
        container.appendChild(box);

        setTimeout(() => {
            box.style.opacity = "0";
            box.style.transform = "translateX(-50%) translateY(-20px)";
            setTimeout(()=> {
                box.remove();
                container.classList.add('hidden');
            },300);
        },2500);
    }
    
    function scrollToBottom() {
        const container = document.getElementById("messagesContainer");
        container.scrollTop = container.scrollHeight;
    }
    
    /* ============================================================
        üî• User List Loading (‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∂±‡∂∫ ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì)
    ============================================================ */
    function loadUsers(query = '') {
        const usersListEl = document.getElementById("usersList");
        usersListEl.innerHTML = '<p class="text-center text-gray-500 py-4"><span class="inline-block w-6 h-6 border-2 border-gray-200 border-t-gray-600 rounded-full spinner"></span> Loading...</p>'; 
        
        let queryRef = usersRef.orderByChild('name').limitToFirst(20);

        if (query.length > 0) {
            queryRef = usersRef.orderByChild('name')
                               .startAt(query)
                               .endAt(query + '\uf8ff') 
                               .limitToFirst(10);
        }
        
        queryRef.once('value').then(snapshot => {
            usersListEl.innerHTML = "";
            let foundUsers = false;
            
            // üî• MODIFIED: ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∂±‡∑ä‡∂ú‡∑ö ‡∂Ö‡∂ª‡∑è‡∑Ä‡∂ö‡∂ß ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
            const usersArray = [];
            snapshot.forEach(childSnapshot => {
                const user = childSnapshot.val();
                const uid = childSnapshot.key;
                
                if (!uid || uid === 'undefined' || uid === currentUser.uid) {
                    return;
                }
                
                // ‡∂±‡∑Ä ‡∂Ö‡∂Ç‡∂ú‡∂∫: unread status ‡∂ë‡∂ö‡∂≠‡∑ä ‡∑É‡∂∏‡∂ü ‡∂Ö‡∂ª‡∑è‡∑Ä‡∂ß ‡∂ë‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
                const unreadCount = unreadChatCounts[uid] || 0;
                usersArray.push({ uid, name: user.name || '‡∂±‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠', avatar: user.avatar || 'üë§', unreadCount });
                foundUsers = true;
            });
            
            // üî• MODIFIED: Unread status ‡∂∏‡∂≠ ‡∂¥‡∂Ø‡∂±‡∂∏‡∑ä‡∑Ä ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä ‡∑Ä‡∂ª‡∑ä‡∂ú ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            // unreadCount ‡∑Ä‡∑ê‡∂©‡∑í‡∂∏ ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑í‡∂±‡∑ä ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä‡∑ö ‡∂â‡∑Ñ‡∑Ö‡∂ß‡∂∏ ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ö.
            usersArray.sort((a, b) => b.unreadCount - a.unreadCount);

            // ‡∑Ä‡∂ª‡∑ä‡∂ú ‡∂ö‡∑Ö ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑í‡∂±‡∑ä ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä‡∂ß ‡∂ë‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            usersArray.forEach(user => {
                renderUserListItem(user.uid, user.name, user.avatar);
            });
            
            if (!foundUsers) {
                usersListEl.innerHTML = "<p class='text-center text-gray-500 py-4'>‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑í‡∂±‡∑ä ‡∑É‡∑ú‡∂∫‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö.</p>";
            }
        }).catch(error => {
            console.error("Error loading users:", error);
            usersListEl.innerHTML = "<p class='text-center text-red-500 py-4'>‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑í‡∂±‡∑ä Load ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä.</p>";
        });
    }

    function renderUserListItem(uid, name, avatar) {
        if (!uid || uid === 'undefined') {
            console.error("Invalid UID:", uid);
            return;
        }
        
        // üî• MODIFIED: Check for unread messages (unreadChatCounts ‡∂ú‡∑ù‡∂Ω‡∑ì‡∂∫‡∑Ä ‡∂≠‡∑í‡∂∂‡∑ö)
        const unreadCount = unreadChatCounts[uid] || 0; 
        const hasUnread = unreadCount > 0;

        const usersListEl = document.getElementById("usersList");
        const div = document.createElement('div');
        
        // üî• MODIFIED: Added highlight class for unread messages
        const highlightClass = hasUnread ? 'border-red-400 bg-red-50/70 shadow-lg' : ''; 
        
        div.className = `user-list-item flex items-center space-x-3 p-3 rounded-xl bg-white/70 border-2 border-gray-100 cursor-pointer hover:bg-purple-50 shadow-md relative ${highlightClass}`; 
        div.setAttribute('data-uid', uid);
        div.id = `user-list-item-${uid}`;
        div.onclick = () => startChat(uid, name);

        // ‡∂Ø‡∑ê‡∂±‡∂ß ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∂≠‡∑ä ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è highlight ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        if (uid === currentChatRecipient) {
             div.classList.add('border-purple-500', 'bg-purple-100/90', 'scale-105');
             div.classList.remove('border-red-400', 'bg-red-50/70', 'shadow-lg'); // ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∂≠‡∑ä ‡∂¥‡∑É‡∑î unread highlight ‡∂ë‡∂ö ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂∫‡∑í
        }


        div.innerHTML = `
            <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-400 rounded-full flex items-center justify-center text-xl shadow-lg shrink-0">
                ${avatar}
            </div>
            <div class="flex-1 overflow-hidden">
                <p class="font-bold text-gray-800 truncate">${name}</p>
            </div>
            ${hasUnread ? // üî• MODIFIED: Red dot indicator ‡∂ë‡∂ö count ‡∂ë‡∂ö ‡∑É‡∂∏‡∂ü ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏
                // Red dot/count - ‡∂ª‡∂≠‡∑î ‡∂≠‡∑í‡∂≠ (count ‡∂ë‡∂ö)
                `<div class="absolute top-2 right-2 w-5 h-5 bg-red-500 rounded-full shadow-lg flex items-center justify-center text-xs text-white font-bold animate-pulse" title="${unreadCount} unread messages">${unreadCount > 9 ? '9+' : unreadCount}</div>` : 
                ''
            }
        `;
        usersListEl.appendChild(div);
    }
    
    /* ============================================================
        üî• Theme Logic for Background (User's Logic Retained)
    ============================================================ */
    const THEMES = {
        default: { bg: 'bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50' },
        blue: { bg: 'bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50' },
        green: { bg: 'bg-gradient-to-br from-green-50 via-teal-50 to-cyan-50' },
        dark: { bg: 'bg-gray-800' }, 
        red: { bg: 'bg-gradient-to-br from-red-50 via-pink-50 to-orange-50' },
        yellow: { bg: 'bg-gradient-to-br from-yellow-50 via-amber-50 to-orange-50' },
        teal: { bg: 'bg-gradient-to-br from-teal-50 via-cyan-50 to-blue-50' }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const themeName = localStorage.getItem("appTheme") || "default";
        const theme = THEMES[themeName] || THEMES.default;
        document.body.className = "min-h-screen " + theme.bg;
    });

    </script>

</body>
</html>
