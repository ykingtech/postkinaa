<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä - Comments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }

        .comment-card {
            transition: all 0.3s ease;
        }

        .comment-card:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen">

    <header id="appHeader" class="bg-white/80 backdrop-blur-lg border-b border-purple-100 sticky top-0 z-50 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent" id="headerTitle">
                üí¨ ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä
            </h1>
            <button onclick="goBackToHome()" id="backButton" class="px-4 py-2 bg-purple-500 text-white rounded-full text-sm font-semibold hover:bg-purple-600 transition-colors">
                ‡∂¥‡∑í‡∂ß‡∑î‡∂¥‡∑É‡∂ß
            </button>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6">
        
        <div id="mainPostContainer" class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-xl border border-purple-100 p-6 mb-8 fade-in">
            <div id="mainPostContent">
                <p class="text-gray-500 text-center">‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</p>
            </div>
        </div>

        <div class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-xl border border-pink-100 p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-700 mb-4">‡∂î‡∂∂‡∑ö ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑î‡∑Ä</h3>
            <textarea
                id="commentInput"
                placeholder="‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑î‡∑Ä ‡∂∏‡∑ô‡∂≠‡∂± ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±..."
                class="w-full px-4 py-3 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-pink-400 focus:bg-white outline-none resize-none transition-all duration-200"
                rows="2"
            ></textarea>
            <div class="flex justify-end mt-4">
                <button
                    onclick="submitComment()"
                    id="commentButton"
                    class="px-6 py-2.5 bg-gradient-to-r from-pink-500 to-red-500 text-white rounded-full font-semibold hover:from-pink-600 hover:to-red-600 shadow-lg transition-all duration-200"
                >
                    üí¨ ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                </button>
            </div>
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä</h2>
        <div id="commentsFeed" class="space-y-4">
            </div>

        <div id="noCommentsMessage" class="text-center py-8 text-gray-500" style="display: none;">
            ‡∂≠‡∑Ä‡∂∏ ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂±‡∑ë.
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentPostId = null;
        let currentPostAuthorId = null; // üî• NEW: To store the main post author's ID

        // Firebase Configuration (Use your configuration)
        const firebaseConfig = {
            apiKey: "AIzaSyAzNJ-P8aAMvTuNWKcQYCjIIHiaL0BpdZ0",
            authDomain: "game-f1c21.firebaseapp.com",
            databaseURL: "https://game-f1c21-default-rtdb.firebaseio.com",
            projectId: "game-f1c21",
            storageBucket: "game-f1c21.firebasestorage.app",
            messagingSenderId: "656338565711",
            appId: "1:656338565711:web:395f9c7f846588b065883a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const postsRef = database.ref("posts");
        const usersRef = database.ref("users");

        // Theme Definitions (Copied from Home.html for consistency)
        const THEMES = {
            default: {
                bg: 'bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50',
                header: 'from-purple-600 via-pink-600 to-blue-600',
                button: 'from-pink-500 to-red-500', 
                buttonHover: 'hover:from-pink-600 hover:to-red-600',
                settingBackBG: '#9333ea', // Back button color for comment.html consistency
            },
            blue: {
                bg: 'bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50',
                header: 'from-blue-600 via-indigo-600 to-purple-600',
                button: 'from-blue-500 to-indigo-500',
                buttonHover: 'hover:from-blue-600 hover:to-indigo-600',
                settingBackBG: '#3b82f6',
            },
            green: {
                bg: 'bg-gradient-to-br from-green-50 via-teal-50 to-cyan-50',
                header: 'from-green-600 via-teal-600 to-cyan-600',
                button: 'from-green-500 to-teal-500',
                buttonHover: 'hover:from-green-600 hover:to-teal-600',
                settingBackBG: '#10b981',
            },
            dark: {
                bg: 'bg-gray-800',
                header: 'text-white', // Dark mode uses text-white instead of gradient
                button: 'from-gray-600 to-gray-700',
                buttonHover: 'hover:from-gray-700 hover:to-gray-800',
                settingBackBG: '#4b5563',
            },
            red: {
                bg: 'bg-gradient-to-br from-red-50 via-pink-50 to-orange-50',
                header: 'from-red-600 via-pink-600 to-orange-600',
                button: 'from-red-500 to-pink-500',
                buttonHover: 'hover:from-red-600 hover:to-pink-600',
                settingBackBG: '#ef4444',
            },
            yellow: {
                bg: 'bg-gradient-to-br from-yellow-50 via-amber-50 to-orange-50',
                header: 'from-yellow-600 via-amber-600 to-orange-600',
                button: 'from-yellow-500 to-amber-500',
                buttonHover: 'hover:from-yellow-600 hover:to-amber-600',
                settingBackBG: '#f59e0b',
            },
            teal: {
                bg: 'bg-gradient-to-br from-teal-50 via-cyan-50 to-blue-50',
                header: 'from-teal-600 via-cyan-600 to-blue-600',
                button: 'from-teal-500 to-cyan-500',
                buttonHover: 'hover:from-teal-600 hover:to-cyan-600',
                settingBackBG: '#14b8a6',
            }
        };

        function applyTheme() {
            const themeName = localStorage.getItem('appTheme') || 'default';
            const theme = THEMES[themeName] || THEMES.default;

            document.body.className = 'min-h-screen ' + theme.bg;
            const headerTitle = document.getElementById('headerTitle');
            const backButton = document.getElementById('backButton');
            const commentButton = document.getElementById('commentButton');

            // 1. Update Header Title
            // Clear existing gradient/text classes
            headerTitle.classList.remove('text-transparent', 'text-white', 'bg-gradient-to-r', 'from-purple-600', 'via-pink-600', 'to-blue-600');
            
            if (themeName === 'dark') {
                headerTitle.classList.add('text-white');
            } else {
                headerTitle.classList.add('bg-clip-text', 'text-transparent', 'bg-gradient-to-r', ...theme.header.split(' '));
            }

            // 2. Update Back Button (match settingBackBG for consistent color)
            backButton.style.backgroundColor = theme.settingBackBG;
            backButton.classList.remove('bg-purple-500', 'hover:bg-purple-600'); 
            
            // 3. Update Comment Button
            commentButton.classList.remove('from-pink-500', 'to-red-500', 'hover:from-pink-600', 'hover:to-red-600');
            commentButton.classList.add('bg-gradient-to-r', ...theme.button.split(' '));
            commentButton.classList.add(...theme.buttonHover.split(' '));
            
            // 4. Update Header Background for Dark Mode
            const header = document.getElementById('appHeader');
            if (themeName === 'dark') {
                header.className = 'bg-gray-700/80 backdrop-blur-lg border-b border-gray-600 sticky top-0 z-50 shadow-sm';
            } else {
                header.className = 'bg-white/80 backdrop-blur-lg border-b border-purple-100 sticky top-0 z-50 shadow-sm';
            }
        }


        function goBackToHome() {
            // Signal Home.html to refresh this post
            localStorage.setItem(`refreshPost_${currentPostId}`, 'true');
            // Redirect to Home.html
            window.location.href = `Home.html?highlightPost=${currentPostId}`;
        }

        function createCommentElement(comment) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-card bg-white/90 backdrop-blur-sm rounded-xl p-4 shadow-sm border border-gray-100 fade-in';
            commentDiv.innerHTML = `
                <div class="flex items-center space-x-3 mb-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-300 to-purple-300 rounded-full flex items-center justify-center text-lg shrink-0">
                        ${comment.avatar}
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">${comment.author}</p>
                        <p class="text-xs text-gray-500">${getTimeAgo(comment.timestamp)}</p>
                    </div>
                </div>
                <p class="text-gray-700 ml-11 whitespace-pre-line">${comment.content}</p>
            `;
            return commentDiv;
        }
        
        // üî• NEW: Notification Creator (Same as Home.html)
        function createNotification(type, recipientId, postId, content = null) {
            if (!currentUser || currentUser.uid === recipientId) {
                return; // Don't notify self
            }

            const newNotificationKey = database.ref().child('notifications').child(recipientId).push().key;

            const notificationData = {
                type: type, // 'like' or 'comment'
                actorId: currentUser.uid,
                postId: postId,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            };

            if (content) {
                notificationData.content = content.substring(0, 100); // Max 100 chars for snippet
            }

            const updates = {};
            updates[`/notifications/${recipientId}/${newNotificationKey}`] = notificationData;

            database.ref().update(updates)
                .catch(error => console.error("Error creating notification:", error));
        }

        // ... (rest of the functions: loadPostAndComments, loadComments, submitComment, getTimeAgo, showNotification)

        function loadPostAndComments(postId) {
            const postContainer = document.getElementById('mainPostContent');
            const commentsFeed = document.getElementById('commentsFeed');
            const noCommentsMessage = document.getElementById('noCommentsMessage');

            // Load main post details
            postsRef.child(postId).once('value', snapshot => {
                const post = snapshot.val();
                
                if (!post) {
                    postContainer.innerHTML = '<p class="text-red-500 text-center text-xl font-bold">‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö üòî</p>';
                    return;
                }

                // üî• Set Post Author ID
                currentPostAuthorId = post.authorId; 
                
                // Display post content
                postContainer.innerHTML = `
                    <div class="flex items-start space-x-4 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-xl shadow-xl shrink-0">
                            ${post.avatar || 'üë§'}
                        </div>
                        <div>
                            <p class="font-bold text-lg text-gray-800">${post.author || '‡∂±‡∑ú‡∂Ø‡∂±‡∑ä‡∂±‡∑è ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑ô‡∂ö‡∑ä'}</p>
                            <p class="text-xs text-gray-500">${getTimeAgo(post.timestamp)}</p>
                        </div>
                    </div>
                    <p class="text-lg text-gray-700 whitespace-pre-line pl-14">${post.content || ''}</p>
                `;

                // Load comments for this post
                loadComments(postId);
            });
        }

        function loadComments(postId) {
            const commentsRef = postsRef.child(postId).child('comments');
            const commentsFeed = document.getElementById('commentsFeed');
            const noCommentsMessage = document.getElementById('noCommentsMessage');
            
            commentsFeed.innerHTML = '';
            noCommentsMessage.style.display = 'none';

            commentsRef.on('value', snapshot => {
                commentsFeed.innerHTML = '';
                if (!snapshot.exists()) {
                    noCommentsMessage.style.display = 'block';
                    return;
                }
                
                noCommentsMessage.style.display = 'none';

                const comments = [];
                snapshot.forEach(s => {
                    comments.push(s.val());
                });
                
                comments.reverse(); // Newest comment at the top

                const userPromises = comments.map(comment => 
                    usersRef.child(comment.authorId).once('value')
                );

                Promise.all(userPromises).then(userSnaps => {
                    commentsFeed.innerHTML = ''; // Clear again to avoid duplicates on re-render
                    
                    comments.forEach((comment, index) => {
                        const userData = userSnaps[index].val();
                        // Use user data if available, otherwise fallback to stored comment data
                        comment.author = userData ? userData.name : comment.author; 
                        comment.avatar = userData ? userData.avatar : comment.avatar;
                        
                        const commentElement = createCommentElement(comment);
                        commentsFeed.appendChild(commentElement);
                    });
                });
            });
        }

        function submitComment() {
            if (!currentUser) {
                showNotification("‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±.");
                return;
            }

            const commentInput = document.getElementById('commentInput');
            const commentButton = document.getElementById('commentButton');
            const commentText = commentInput.value.trim();

            if (!commentText) {
                showNotification("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑î‡∑Ä‡∂ö‡∑ä ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±.");
                return;
            }

            commentButton.disabled = true;
            commentButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Sending...</span>`;

            usersRef.child(currentUser.uid).once('value', snap => {
                const userData = snap.val() || {};

                const commentData = {
                    author: userData.name || '‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è',
                    authorId: currentUser.uid,
                    avatar: userData.avatar || 'üë§',
                    content: commentText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                const commentsRef = postsRef.child(currentPostId).child('comments');
                
                return commentsRef.push(commentData)
                    .then(() => {
                        // Update comment count on the post
                        postsRef.child(currentPostId).child('commentsCount').transaction(count => (count || 0) + 1);

                        showNotification("‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑î‡∑Ä ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í! üéâ");
                        commentInput.value = '';
                        commentButton.disabled = false;
                        commentButton.innerHTML = `üí¨ ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±`;
                        
                        // üî• NOTIFICATION CREATION
                        createNotification('comment', currentPostAuthorId, currentPostId, commentText); 

                    })
                    .catch((error) => {
                        console.error('Error adding comment:', error);
                        commentButton.disabled = false;
                        commentButton.innerHTML = `üí¨ ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±`;
                        showNotification("‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‚ùå");
                    });
            });
        }

        // Time Ago Utility
        function getTimeAgo(timestamp) {
            if (!timestamp) return '‡∂Ø‡∑ê‡∂±‡∑ä';
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days} ‡∂Ø‡∑í‡∂±${days > 1 ? '' : '‡∂ö‡∂ß'} ‡∂¥‡∑ô‡∂ª`;
            if (hours > 0) return `${hours} ‡∂¥‡∑ê‡∂∫${hours > 1 ? '' : '‡∂ö‡∂ß'} ‡∂¥‡∑ô‡∂ª`;
            if (minutes > 0) return `${minutes} ‡∂∏‡∑í‡∂±‡∑í‡∂≠‡∑ä‡∂≠‡∑î${minutes > 1 ? '' : '‡∂ö‡∂ß'} ‡∂¥‡∑ô‡∂ª`;
            return '‡∂Ø‡∑ê‡∂±‡∑ä';
        }

        // Notification Utility
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-2xl shadow-2xl z-50 fade-in';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(10px)';
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme();

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                } else {
                    // If not logged in, redirect to login page
                    window.location.replace("index.html");
                    return;
                }
                
                // Get postId from URL
                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('postId');
                
                if (postId) {
                    currentPostId = postId;
                    loadPostAndComments(postId);
                } else {
                    document.getElementById('mainPostContent').innerHTML = '<p class="text-red-500 text-center text-xl font-bold">‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ID ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö.</p>';
                }
            });
        });

    </script>
</body>
</html>
