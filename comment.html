<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä - Comments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="min-h-screen">

    <header id="appHeader" class="bg-white/80 backdrop-blur-lg border-b border-purple-100 sticky top-0 z-50 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent" id="headerTitle">
                üí¨ ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä
            </h1>
            <a href="index.html" class="px-4 py-2 bg-purple-500 text-white rounded-full text-sm font-semibold hover:bg-purple-600 transition-colors">
                ‡∂¥‡∑í‡∂ß‡∑î‡∂¥‡∑É‡∂ß
            </a>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6">
        
        <div id="mainPostContainer" class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-xl border border-purple-100 p-6 mb-8 fade-in">
            <div id="mainPostContent">
                <p class="text-gray-500 text-center">‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</p>
            </div>
        </div>

        <div class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-xl border border-pink-100 p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-700 mb-4">‡∂î‡∂∂‡∑ö ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑î‡∑Ä</h3>
            <textarea
                id="commentInput"
                placeholder="‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑î‡∑Ä ‡∂∏‡∑ô‡∂≠‡∂± ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±..."
                class="w-full px-4 py-3 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-pink-400 focus:bg-white outline-none resize-none transition-all duration-200"
                rows="2"
            ></textarea>
            <div class="flex justify-end mt-4">
                <button
                    onclick="submitComment()"
                    id="commentButton"
                    class="px-6 py-2.5 bg-gradient-to-r from-pink-500 to-red-500 text-white rounded-full font-semibold hover:from-pink-600 hover:to-red-600 shadow-lg transition-all duration-200"
                >
                    üí¨ ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                </button>
            </div>
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä</h2>
        <div id="commentsFeed" class="space-y-4">
            </div>

        <div id="noCommentsMessage" class="text-center py-8 text-gray-500" style="display: none;">
            ‡∂≠‡∑Ä‡∂∏ ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä ‡∂±‡∑ë.
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentPostId = null;

        // Firebase Configuration (Use your configuration)
        const firebaseConfig = {
            apiKey: "AIzaSyAzNJ-P8aAMvTuNWKcQYCjIIHiaL0BpdZ0",
            authDomain: "game-f1c21.firebaseapp.com",
            databaseURL: "https://game-f1c21-default-rtdb.firebaseio.com",
            projectId: "game-f1c21",
            storageBucket: "game-f1c21.firebasestorage.app",
            messagingSenderId: "656338565711",
            appId: "1:656338565711:web:395f9c7f846588b065883a",
            measurementId: "G-2M7BJXBB7W"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const avatars = ['üòä', 'üé®', '‚ú®', 'üéØ', 'üåü', 'üé≠', 'üé™', 'üé®', 'üåà', '‚≠ê', 'üé∏', 'üéÆ', 'üé¨', 'üìö', 'üéµ'];
        const gradients = [
            'from-purple-400 to-pink-400', 'from-blue-400 to-purple-400', 'from-pink-400 to-orange-400',
            'from-green-400 to-teal-400', 'from-yellow-400 to-orange-400', 'from-red-400 to-pink-400',
            'from-indigo-400 to-blue-400'
        ];

        // --- Theme System (Duplicated for consistency) ---
        function getThemeClass(themeName) {
            switch (themeName) {
                case 'green':
                    return { bg: 'bg-gradient-to-br from-green-50 via-teal-50 to-cyan-50', header: 'bg-gradient-to-r from-green-600 via-teal-600 to-cyan-600' };
                case 'blue':
                    return { bg: 'bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50', header: 'bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600' };
                default:
                    return { bg: 'bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50', header: 'bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600' };
            }
        }

        function applyTheme() {
            const themeName = localStorage.getItem('appTheme') || 'default';
            const theme = getThemeClass(themeName);
            document.body.className = 'min-h-screen ' + theme.bg;
            document.getElementById('headerTitle').className = 'text-3xl font-bold bg-clip-text text-transparent ' + theme.header;
            document.getElementById('appHeader').querySelector('a').style.backgroundColor = themeName === 'green' ? '#10b981' : themeName === 'blue' ? '#3b82f6' : '#9333ea';
        }

        // --- Initialization and Auth Check ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                applyTheme();
                
                // Get postId from URL
                const urlParams = new URLSearchParams(window.location.search);
                currentPostId = urlParams.get('postId');
                
                if (currentPostId) {
                    loadMainPost(currentPostId);
                    loadComments(currentPostId);
                } else {
                    document.getElementById('mainPostContent').innerHTML = '<p class="text-red-500 text-center">Post ID ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑í‡∂´‡∑í.</p>';
                }
            } else {
                // If not logged in, redirect to auth page
                window.location.href = 'auth.html';
            }
        });

        // --- Core Functions ---

        // 1. Load Main Post
        function loadMainPost(postId) {
            database.ref(`posts/${postId}`).once('value', (snapshot) => {
                const post = snapshot.val();
                if (post) {
                    const postContentDiv = document.getElementById('mainPostContent');
                    postContentDiv.innerHTML = `
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br ${post.gradient} rounded-full flex items-center justify-center text-xl shadow-lg shrink-0">
                                ${post.avatar}
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">${post.author}</h3>
                                <p class="text-sm text-gray-500">${getTimeAgo(post.timestamp)}</p>
                            </div>
                        </div>
                        <p class="text-gray-700 leading-relaxed text-xl">${post.content}</p>
                    `;
                    document.title = `‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑ä - ${post.author}`;
                } else {
                    document.getElementById('mainPostContent').innerHTML = '<p class="text-red-500 text-center">‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑í‡∂´‡∑í.</p>';
                }
            });
        }

        // 2. Load Comments
        function loadComments(postId) {
            const commentsRef = database.ref(`posts/${postId}/comments`);
            const commentsFeed = document.getElementById('commentsFeed');
            const noCommentsMessage = document.getElementById('noCommentsMessage');
            
            commentsRef.orderByChild('timestamp').on('value', (snapshot) => {
                commentsFeed.innerHTML = '';
                const comments = [];
                snapshot.forEach((childSnapshot) => {
                    comments.push(childSnapshot.val());
                });

                if (comments.length === 0) {
                    noCommentsMessage.style.display = 'block';
                } else {
                    noCommentsMessage.style.display = 'none';
                    comments.reverse().forEach(comment => {
                        renderComment(comment, commentsFeed);
                    });
                }
            });
        }
        
        // 3. Render a single Comment
        function renderComment(comment, container) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'bg-white rounded-xl p-4 shadow-md border border-gray-100 fade-in';
            commentDiv.innerHTML = `
                <div class="flex items-center space-x-3 mb-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-300 to-purple-300 rounded-full flex items-center justify-center text-lg shrink-0">
                        ${comment.avatar}
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">${comment.author}</p>
                        <p class="text-xs text-gray-500">${getTimeAgo(comment.timestamp)}</p>
                    </div>
                </div>
                <p class="text-gray-700 ml-11">${comment.content}</p>
            `;
            container.appendChild(commentDiv);
        }

        // 4. Submit Comment
        function submitComment() {
            if (!currentUser || !currentPostId) return;

            const commentInput = document.getElementById('commentInput');
            const content = commentInput.value.trim();
            
            if (!content) {
                showNotification('‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑î‡∑Ä ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±!');
                return;
            }

            const commentButton = document.getElementById('commentButton');
            commentButton.disabled = true;

            const randomAvatar = avatars[Math.floor(Math.random() * avatars.length)];
            
            const newComment = {
                authorId: currentUser.uid,
                author: currentUser.email.split('@')[0], // Use email prefix as author name
                avatar: randomAvatar,
                content: content,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
            };

            const commentsRef = database.ref(`posts/${currentPostId}/comments`);
            const commentsCountRef = database.ref(`posts/${currentPostId}/commentsCount`);
            
            commentsRef.push(newComment)
                .then(() => {
                    // Update comment count
                    commentsCountRef.transaction((current) => {
                        return (current || 0) + 1;
                    });

                    commentInput.value = '';
                    commentButton.disabled = false;
                    showNotification('‡∂ö‡∂∏‡∑ô‡∂±‡∑ä‡∂ß‡∑î‡∑Ä ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì! ‚úÖ');
                })
                .catch((error) => {
                    console.error('Error adding comment:', error);
                    commentButton.disabled = false;
                });
        }

        // Time Ago Utility
        function getTimeAgo(timestamp) {
            if (!timestamp) return '‡∂Ø‡∑ê‡∂±‡∑ä';
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days} ‡∂Ø‡∑í‡∂±${days > 1 ? '' : '‡∂ö‡∂ß'} ‡∂¥‡∑ô‡∂ª`;
            if (hours > 0) return `${hours} ‡∂¥‡∑ê‡∂∫${hours > 1 ? '' : '‡∂ö‡∂ß'} ‡∂¥‡∑ô‡∂ª`;
            if (minutes > 0) return `${minutes} ‡∂∏‡∑í‡∂±‡∑í‡∂≠‡∑ä‡∂≠‡∑î${minutes > 1 ? '' : '‡∂ö‡∂ß'} ‡∂¥‡∑ô‡∂ª`;
            return '‡∂Ø‡∑ê‡∂±‡∑ä';
        }

        // Notification Utility
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-2xl shadow-2xl z-50 fade-in';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

    </script>

</body>

</html>
